<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title><![CDATA[Mr wang]]></title>
  
  <link href="/atom.xml" rel="self"/>
  <link href="http://www.mr-wang.cn/"/>
  <updated>2016-09-08T09:15:08.644Z</updated>
  <id>http://www.mr-wang.cn/</id>
  
  <author>
    <name><![CDATA[Mr wang]]></name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title><![CDATA[PyQt实现WebView]]></title>
    <link href="http://www.mr-wang.cn/2016/09/08/PyQt-WebView/"/>
    <id>http://www.mr-wang.cn/2016/09/08/PyQt-WebView/</id>
    <published>2016-09-08T09:26:27.000Z</published>
    <updated>2016-09-08T09:15:08.644Z</updated>
    <content type="html"><![CDATA[<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># __*__ coding:utf-8 __*__</span><br><span class="line"></span><br><span class="line">import sys,time</span><br><span class="line">from PyQt4.Qt import *</span><br><span class="line">from PyQt4.QtWebKit import *</span><br><span class="line">from PyQt4.QtCore import *</span><br><span class="line">from PyQt4 import QtGui</span><br><span class="line">import ConfigParser</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class WebView(QWebView):</span><br><span class="line">    def __init__(self):</span><br><span class="line">        super(WebView,self).__init__()</span><br><span class="line"></span><br><span class="line">        #读取配置文件，配置文件管理访问的url及窗口是否全屏</span><br><span class="line">        cf = ConfigParser.ConfigParser()</span><br><span class="line">        cf.read('WeChat.conf')</span><br><span class="line">        url = cf.get('WeChat','url')</span><br><span class="line">        showFullScreen_enable = cf.get('WeChat','showFullScreen_enable')</span><br><span class="line"></span><br><span class="line">        #打开url</span><br><span class="line">        self.load(QUrl(url))</span><br><span class="line">        self.page().setLinkDelegationPolicy(QWebPage.DelegateAllLinks)</span><br><span class="line">        self.page().linkClicked.connect(self.linkClicked)</span><br><span class="line"></span><br><span class="line">        #设置窗口标题、图标</span><br><span class="line">        self.setWindowTitle(u'二维码扫码')</span><br><span class="line">        self.setWindowIcon(QtGui.QIcon('WeChat.png'))</span><br><span class="line"></span><br><span class="line">        #创建托盘</span><br><span class="line">        self.createTrayIcon()</span><br><span class="line">        #托盘点击事件</span><br><span class="line">        self.trayIcon.activated.connect(self.iconActivated)</span><br><span class="line"></span><br><span class="line">        if showFullScreen_enable == 'True':</span><br><span class="line">            self.showFullScreen()</span><br><span class="line">        else:</span><br><span class="line">            pass</span><br><span class="line"></span><br><span class="line">        self.show()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    def linkClicked(self, url):</span><br><span class="line">        self.load(QUrl(url))</span><br><span class="line"></span><br><span class="line">    def closeEvent(self, event):</span><br><span class="line">        QtGui.QMessageBox.about(self,u'提示 ',u'不允许关闭! ')</span><br><span class="line">        event.ignore()</span><br><span class="line"></span><br><span class="line">    def focusOutEvent(self, QFocusEvent):</span><br><span class="line">        self.trayIcon.showMessage("警告", "窗口已失焦", 2)</span><br><span class="line"></span><br><span class="line">    def focusInEvent(self, QFocusEvent):</span><br><span class="line">        self.trayIcon.showMessage("提示", "窗口已聚焦", 1)</span><br><span class="line"></span><br><span class="line">    def createTrayIcon(self):</span><br><span class="line">         icon = QtGui.QIcon('WeChat.png')</span><br><span class="line">         self.trayIcon = QtGui.QSystemTrayIcon(self)</span><br><span class="line">         self.trayIcon.setIcon(icon)</span><br><span class="line">         self.trayIcon.setToolTip(self.tr("二维码扫码"))</span><br><span class="line">         self.trayIcon.setVisible(True)</span><br><span class="line"></span><br><span class="line">    def iconActivated(self, reason):</span><br><span class="line">        if reason in (QtGui.QSystemTrayIcon.Trigger, QtGui.QSystemTrayIcon.DoubleClick):</span><br><span class="line">            self.showFullScreen()</span><br><span class="line">        elif reason == QtGui.QSystemTrayIcon.MiddleClick:</span><br><span class="line">            self.showFullScreen()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == '__main__':</span><br><span class="line"></span><br><span class="line">    app = QApplication(sys.argv)</span><br><span class="line"></span><br><span class="line">    #解决打包exe后，页面中文乱码问题</span><br><span class="line">    app.Encoding(QApplication.UnicodeUTF8)</span><br><span class="line">    utfcodec = QTextCodec.codecForName("UTF-8")</span><br><span class="line">    QTextCodec.setCodecForTr(utfcodec)</span><br><span class="line">    QTextCodec.setCodecForLocale(utfcodec)</span><br><span class="line">    QTextCodec.setCodecForCStrings(utfcodec)</span><br><span class="line"></span><br><span class="line">    webView = WebView()</span><br><span class="line"></span><br><span class="line">    sys.exit(app.exec_())</span><br></pre></td></tr></table></figure>]]></content>
    <summary type="html">
    <![CDATA[<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line]]>
    </summary>
    
      <category term="Python" scheme="http://www.mr-wang.cn/tags/Python/"/>
    
      <category term="技术" scheme="http://www.mr-wang.cn/categories/%E6%8A%80%E6%9C%AF/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Mysql主从复制及读写分离的实现-MyCat]]></title>
    <link href="http://www.mr-wang.cn/2016/03/10/Mysql-Master-slave-Read-Write-Splitting-MyCat/"/>
    <id>http://www.mr-wang.cn/2016/03/10/Mysql-Master-slave-Read-Write-Splitting-MyCat/</id>
    <published>2016-03-10T12:26:27.000Z</published>
    <updated>2016-04-01T06:37:03.575Z</updated>
    <content type="html"><![CDATA[<h1 id="MyCat介绍">MyCat介绍</h1><h2 id="什么是MyCat">什么是MyCat</h2><ul>
<li>一个彻底开源的，面向企业应用开发的大数据库集群</li>
<li>支持事务、ACID、可以替代MySQL的加强版数据库</li>
<li>一个可以视为MySQL集群的企业级数据库，用来替代昂贵的Oracle集群</li>
<li>一个融合内存缓存技术、NoSQL技术、HDFS大数据的新型SQL Server</li>
<li>结合传统数据库和新型分布式数据仓库的新一代企业级数据库产品</li>
<li>一个新颖的数据库中间件产品</li>
</ul>
<p>MyCat官网：<a href="http://www.mycat.org.cn/" target="_blank" rel="external">http://www.mycat.org.cn/</a></p>
<h2 id="优势">优势</h2><p>copy官方的说明：<br>基于阿里开源的Cobar产品而研发，Cobar的稳定性、可靠性、优秀的架构和性能以及众多成熟的使用案例使得MYCAT一开始就拥有一个很好的起点，站在巨人的肩膀上，我们能看到更远。业界优秀的开源项目和创新思路被广泛融入到MYCAT的基因中，使得MYCAT在很多方面都领先于目前其他一些同类的开源项目，甚至超越某些商业产品。</p>
<p>MYCAT背后有一支强大的技术团队，其参与者都是5年以上资深软件工程师、架构师、DBA等，优秀的技术团队保证了MYCAT的产品质量。</p>
<p>MYCAT并不依托于任何一个商业公司，因此不像某些开源项目，将一些重要的特性封闭在其商业产品中，使得开源项目成了一个摆设（猜测是说的淘宝的TDDL，只开源动态数据源，分表分库部分还未开源）。</p>
<a id="more"></a>
<h1 id="Mysql主从配置">Mysql主从配置</h1><h2 id="环境介绍：">环境介绍：</h2><p>两台Mysql数据库实现主从配置<br>Mycat:172.16.14.1<br>Mysql Master:172.16.14.2<br>Mysql Slave:172.16.14.3</p>
<h2 id="在Master服务器上安装并配置Mysql">在Master服务器上安装并配置Mysql</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#安装Mysql并加入到系统服务</span><br><span class="line">[root@master ~]# tar xf mysql-<span class="number">5.6</span>.<span class="number">13</span>-linux-glibc2.<span class="number">5</span>-x86_64.tar.gz -C /usr/local/</span><br><span class="line">[root@master ~]# <span class="keyword">cd</span> /usr/local/</span><br><span class="line">[root@master local]# <span class="keyword">ln</span> -<span class="keyword">s</span> mysql-<span class="number">5.6</span>.<span class="number">13</span>-linux-glibc2.<span class="number">5</span>-x86_64 mysql</span><br><span class="line">[root@master local]# <span class="keyword">cd</span> mysql</span><br><span class="line">[root@master mysql]# <span class="keyword">cp</span> support-<span class="keyword">files</span>/mysql.server /etc/init.<span class="keyword">d</span>/mysqld</span><br><span class="line">[root@master mysql]# chmod +<span class="keyword">x</span> /etc/init.<span class="keyword">d</span>/mysqld</span><br><span class="line">[root@master mysql]# chkconfig --<span class="built_in">add</span> mysqld</span><br><span class="line">[root@master mysql]# <span class="keyword">echo</span> <span class="string">"PATH=/usr/local/mysql/bin:$PATH"</span> &gt;&gt; /etc/<span class="keyword">profile</span></span><br><span class="line">[root@master mysql]# . /etc/<span class="keyword">profile</span></span><br></pre></td></tr></table></figure>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">#提供主配置文件</span><br><span class="line">[root@master mysql]# <span class="keyword">vim</span> /etc/my.<span class="keyword">cnf</span></span><br><span class="line">[client]</span><br><span class="line">#定义mysql client的密码</span><br><span class="line">#password       = your_password</span><br><span class="line">port            = <span class="number">3306</span></span><br><span class="line">socket          = /tmp/mysql.sock</span><br><span class="line">[mysqld]</span><br><span class="line">port            = <span class="number">3306</span></span><br><span class="line">socket          = /tmp/mysql.sock</span><br><span class="line">skip-external-locking</span><br><span class="line">key_buffer_size = <span class="number">256</span>M</span><br><span class="line">max_allowed_packet = <span class="number">1</span>M</span><br><span class="line">table_open_cache = <span class="number">256</span></span><br><span class="line">sort_buffer_size = <span class="number">1</span>M</span><br><span class="line">read_buffer_size = <span class="number">1</span>M</span><br><span class="line">read_rnd_buffer_size = <span class="number">4</span>M</span><br><span class="line">myisam_sort_buffer_size = <span class="number">64</span>M</span><br><span class="line">thread_cache_size = <span class="number">8</span></span><br><span class="line">query_cache_size= <span class="number">16</span>M</span><br><span class="line">thread_concurrency = <span class="number">8</span></span><br><span class="line">binlog-format=ROW</span><br><span class="line">#开启GTID模式</span><br><span class="line"><span class="built_in">log</span>-slave-updates=true</span><br><span class="line">gtid-<span class="built_in">mode</span>=<span class="keyword">on</span></span><br><span class="line">enforce-gtid-consistency=true</span><br><span class="line"></span><br><span class="line">master-info-repository=TABLE</span><br><span class="line">relay-<span class="built_in">log</span>-info-repository=TABLE</span><br><span class="line"><span class="keyword">sync</span>-master-info=<span class="number">1</span></span><br><span class="line">slave-parallel-workers=<span class="number">2</span></span><br><span class="line">binlog-checksum=CRC32</span><br><span class="line">master-verify-checksum=<span class="number">1</span></span><br><span class="line">slave-sql-verify-checksum=<span class="number">1</span></span><br><span class="line">binlog-rows-query-log_events=<span class="number">1</span></span><br><span class="line">report-port=<span class="number">3306</span></span><br><span class="line">datadir=/data</span><br><span class="line">report-host=<span class="number">172.16</span>.<span class="number">14.2</span></span><br><span class="line"><span class="built_in">log</span>-bin=mysql-bin</span><br><span class="line">server-id       = <span class="number">10</span></span><br><span class="line">[mysqldump]</span><br><span class="line">quick</span><br><span class="line">max_allowed_packet = <span class="number">16</span>M</span><br><span class="line">[mysql]</span><br><span class="line"><span class="keyword">no</span>-auto-rehash</span><br><span class="line">[myisamchk]</span><br><span class="line">key_buffer_size = <span class="number">128</span>M</span><br><span class="line">sort_buffer_size = <span class="number">128</span>M</span><br><span class="line">read_buffer = <span class="number">2</span>M</span><br><span class="line">write_buffer = <span class="number">2</span>M</span><br><span class="line">[mysqlhotcopy]</span><br><span class="line">interactive-timeout</span><br></pre></td></tr></table></figure>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#初始化Mysql</span><br><span class="line">[root@master mysql]# useradd -<span class="keyword">r</span> mysql</span><br><span class="line">[root@master mysql]# <span class="built_in">mkdir</span> /data</span><br><span class="line">[root@master mysql]# chown -R mysql.mysql /data</span><br><span class="line">[root@master mysql]# chown -R root.mysql /usr/local/mysql/*</span><br><span class="line">[root@master mysql]# ./scripts/mysql_install_db --user=mysql --datadir=/data/</span><br><span class="line">[root@master ~]# service mysqld start</span><br></pre></td></tr></table></figure>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#在Slave服务器上安装Mysql与在Master服务器上安装方法相同，而在Slave服务器上安装Mysql有两个参数与Master服务器不同；如下</span><br><span class="line">server-id=<span class="number">11</span></span><br><span class="line">report-host=<span class="number">172.16</span>.<span class="number">14.3</span></span><br><span class="line">[root@slave ~]# service mysqld start</span><br></pre></td></tr></table></figure>
<h2 id="在Master服务器上为Slave创建复制用户并测试连接">在Master服务器上为Slave创建复制用户并测试连接</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mysql</span><br><span class="line">mysql&gt; grant replication slave,replication client <span class="keyword">on</span> *.* <span class="keyword">to</span> <span class="string">'slave'</span>@<span class="string">'172.16.%.%'</span> identified by <span class="string">'passwd'</span>;</span><br><span class="line">mysql&gt; flush privileges;</span><br><span class="line">------------------------------------------------------------------------</span><br><span class="line">######测试连接</span><br><span class="line">[root@slave ~]# mysql -uslave -ppasswd -<span class="keyword">h</span> <span class="number">172.16</span>.<span class="number">14.2</span></span><br></pre></td></tr></table></figure>
<h2 id="启动从节点的复制线程">启动从节点的复制线程</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# mysql</span><br><span class="line">mysql&gt; change master to master_host='172.16.14.2',master_user='slave',master_password='passwd',master_auto_position=1;</span><br><span class="line">mysql&gt; start slave;</span><br><span class="line">mysql&gt; show slave status\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 172.16.14.2</span><br><span class="line">                  Master_User: slave</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000005</span><br><span class="line">          Read_Master_Log_Pos: 191</span><br><span class="line">               Relay_Log_File: slave-relay-bin.000003</span><br><span class="line">                Relay_Log_Pos: 401</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000005</span><br><span class="line">             Slave_IO_Running: Yes      #主要看这两项为“YES”说明成功</span><br><span class="line">            Slave_SQL_Running: Yes</span><br></pre></td></tr></table></figure>
<h2 id="在Master服务器创建数据库查看Slave服务器是否更新">在Master服务器创建数据库查看Slave服务器是否更新</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mysql -<span class="keyword">e</span> <span class="string">'create database allen;'</span></span><br><span class="line">------------------------------------------------------------------------</span><br><span class="line">[root@slave ~]# mysql -<span class="keyword">e</span> <span class="string">'show databases;'</span></span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| allen              |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| test               |</span><br><span class="line">+--------------------+</span><br><span class="line">#由上可见，新创建的<span class="string">"allen"</span>数据库已成功同步</span><br></pre></td></tr></table></figure>
<p>至此Mysql 5.6 基于GTID的复制已经完成，下面将介绍如何基于Mysql的主从复制架构做读写分离</p>
<h1 id="读写分离配置">读写分离配置</h1><p>基于前面做的Mysql主从架构，然后在前端加一台服务器，用于实现Mysql的读写分离，IP地址为：172.16.14.1；由于Mycat是java程序所研发，所以需要先安装JDK程序</p>
<h2 id="安装JDK">安装JDK</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@amoeba ~]# tar xzvf jdk-7u72-linux-x64.tar.gz</span><br><span class="line">[root@amoeba ~]# chown -R /usr/local/java</span><br><span class="line">[root@amoeba ~]# mv jdk1.7.0_72 /usr/local/java</span><br><span class="line">[root@amoeba ~]# vim /etc/profile</span><br><span class="line">export JAVA_HOME=/usr/local/java/jdk1.7.0_72</span><br><span class="line">export CLASSPATH=.:$JAVA_HOME/jre/lib/rt.jar:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar</span><br><span class="line">export PATH=$PATH:$JAVA_HOME/bin</span><br><span class="line">[root@amoeba ~]# source /etc/profile</span><br><span class="line">[root@amoeba ~]# java -version</span><br><span class="line">java version "1.7.0_72"</span><br><span class="line">Java(TM) SE Runtime Environment (build 1.7.0_72-b14)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 24.72-b04, mixed mode)</span><br></pre></td></tr></table></figure>
<h2 id="安装MyCat">安装MyCat</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@amoeba ~]# tar xzvf Mycat-server-<span class="number">1.5</span>-RELEASE-<span class="number">20160309173032</span>-linux.tar.gz </span><br><span class="line">[root@amoeba ~]# mv Mycat /usr/local/</span><br></pre></td></tr></table></figure>
<h2 id="授权Mysql用户，用于实现前端MyCat连接">授权Mysql用户，用于实现前端MyCat连接</h2><p>由于上面授权的主从复制帐号不能同步”mysql”数据库，所以用户名也无法同步，要在两台数据库上同时授权，用户名密码保持一致</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#主mysql</span><br><span class="line">[root@master ~]# mysql</span><br><span class="line">mysql&gt; grant <span class="keyword">all</span> <span class="keyword">on</span> *.* <span class="keyword">to</span> <span class="string">'mycat'</span>@<span class="string">'172.16.%.%'</span> identified by <span class="string">'123456'</span>;</span><br><span class="line">mysql&gt; flush privileges;</span><br><span class="line"></span><br><span class="line">#备mysql</span><br><span class="line">[root@slave ~]# mysql</span><br><span class="line">mysql&gt; grant <span class="keyword">all</span> <span class="keyword">on</span> *.* <span class="keyword">to</span> <span class="string">'mycat'</span>@<span class="string">'172.16.%.%'</span> identified by <span class="string">'123456'</span>;</span><br><span class="line">mysql&gt; flush privileges;</span><br></pre></td></tr></table></figure>
<h2 id="配置MyCat">配置MyCat</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[root@mycat ~]# <span class="keyword">cd</span> /usr/local/mycat/<span class="keyword">conf</span>/  #主要配置文件为以下两个</span><br><span class="line">schema.xml        #定义数据库读写分离及节点管理信息等</span><br><span class="line">server.xml        #保存了所有mycat需要的系统配置信息,mycat服务用户密码等</span><br><span class="line"></span><br><span class="line">[root@mycat ~]# <span class="keyword">vi</span> schema.xml</span><br><span class="line">&lt;?xml <span class="keyword">version</span>=<span class="string">"1.0"</span>?&gt;</span><br><span class="line">&lt;!DOCTYPE myca<span class="variable">t:schema</span> SYSTEM <span class="string">"schema.dtd"</span>&gt;</span><br><span class="line">&lt;myca<span class="variable">t:schema</span> xmln<span class="variable">s:mycat</span>=<span class="string">"http://org.opencloudb/"</span>&gt;</span><br><span class="line"></span><br><span class="line">&lt;!--schema标签用于定义MyCat实例中的逻辑库，MyCat可有多个逻辑库，每个逻辑库都有自己的相关配置。可以使用 schema 标签来划分不同的逻辑库。--&gt;</span><br><span class="line">&lt;!--这里定义一个TESTDB的逻辑库，包含dn1这个分片 --&gt;</span><br><span class="line">	&lt;schema name=<span class="string">"TESTDB"</span> checkSQLschema=<span class="string">"false"</span> sqlMaxLimit=<span class="string">"100"</span> dataNode=<span class="string">"dn1"</span>&gt;</span><br><span class="line">	    &lt;!--可配置分片规则,user表根据latest-month-calldate规则分片到dn2,dn3节点，其他没定义的表默认在dn1节点--&gt; </span><br><span class="line">		&lt;!-- auto sharding by id (long) --&gt;</span><br><span class="line">		&lt;!-- &lt;table name=<span class="string">"user"</span> primaryKey=<span class="string">"ID"</span> dataNode=<span class="string">"dn2，dn3"</span> rule=<span class="string">"latest-month-calldate"</span> /&gt; --&gt;</span><br><span class="line">	&lt;/schema&gt;</span><br><span class="line">	</span><br><span class="line">	&lt;!--定义数据分片节点，使用名字为localhost1库实例上的wytest物理数据库，就组成一个数据分片，可配置多个 --&gt;</span><br><span class="line">	&lt;dataNode name=<span class="string">"dn1"</span> dataHost=<span class="string">"localhost1"</span> database=<span class="string">"wytest"</span> /&gt;</span><br><span class="line">	&lt;!--&lt;dataNode name=<span class="string">"dn4"</span> dataHost=<span class="string">"sequoiadb1"</span> database=<span class="string">"SAMPLE"</span> /&gt;</span><br><span class="line">	 &lt;dataNode name=<span class="string">"jdbc_dn1"</span> dataHost=<span class="string">"jdbchost"</span> database=<span class="string">"db1"</span> /&gt; </span><br><span class="line">	&lt;dataNode	name=<span class="string">"jdbc_dn2"</span> dataHost=<span class="string">"jdbchost"</span> database=<span class="string">"db2"</span> /&gt; </span><br><span class="line">	&lt;dataNode name=<span class="string">"jdbc_dn3"</span> 	dataHost=<span class="string">"jdbchost"</span> database=<span class="string">"db3"</span> /&gt; --&gt;</span><br><span class="line">	</span><br><span class="line">	&lt;!--定义具体的数据实例--&gt;</span><br><span class="line">	&lt;!--balance 负载均衡类型，目前的取值有 <span class="number">3</span> 种：</span><br><span class="line">     <span class="number">1</span>. balance=<span class="string">"0"</span>,不开启读写分离机制，所有读操作都发送到当前可用的writeHost上。</span><br><span class="line">     <span class="number">2</span>. balance=<span class="string">"1"</span>，全部的readHost与stand by writeHost参与select查询的负载均衡，简单的说，当双主双从模式(M1-&gt;S1，M2-&gt;S2，并且M1与M2互为主备)，正常情冴下，M2,S1,S2 都参不 select 查询的负载均衡。</span><br><span class="line">     <span class="number">3</span>. balance=<span class="string">"2"</span>，所有读操作都随机的在 writeHost、readhost 上分发。</span><br><span class="line">     <span class="number">4</span>. balance=<span class="string">"3"</span>，所有读请求随机的分发到wiriterHost对应的readhost执行，writerHost不负担读压力，注意 balance=<span class="number">3</span> 叧在 <span class="number">1.4</span> 及其以后版本有，<span class="number">1.3</span> 没有。--&gt;</span><br><span class="line">	&lt;dataHost name=<span class="string">"localhost1"</span> maxCon=<span class="string">"1000"</span> minCon=<span class="string">"10"</span> balance=<span class="string">"1"</span></span><br><span class="line">		writeType=<span class="string">"0"</span> dbType=<span class="string">"mysql"</span> dbDriver=<span class="string">"native"</span> switchType=<span class="string">"1"</span>  slaveThreshold=<span class="string">"100"</span>&gt;</span><br><span class="line">		&lt;heartbeat&gt;select user()&lt;/heartbeat&gt;</span><br><span class="line">		&lt;!-- can have multi <span class="keyword">write</span> hosts --&gt;</span><br><span class="line">		&lt;!--在一个dataHost内可定义多个writeHost和readHost。但是，如果writeHost指定的后端数据库宕机，那么这个writeHost绑定的所有readHost都将不可用。另一方面，由于这个writeHost宕机，系统会自动的检测到，并切换到备用的writeHost上去--&gt;</span><br><span class="line">		&lt;writeHost host=<span class="string">"hostM1"</span> url=<span class="string">"172.16.14.2:3306"</span> user=<span class="string">"mycat"</span> password=<span class="string">"123456"</span>&gt;</span><br><span class="line">		&lt;!-- can have multi <span class="keyword">read</span> hosts --&gt;</span><br><span class="line">        &lt;readHost host=<span class="string">"hostS1"</span> url=<span class="string">"172.16.14.3:3306"</span> user=<span class="string">"mycat"</span> password=<span class="string">"123456"</span> /&gt;</span><br><span class="line">		&lt;/writeHost&gt;</span><br><span class="line">		&lt;!-- &lt;writeHost host=<span class="string">"hostM2"</span> url=<span class="string">"localhost:3316"</span> user=<span class="string">"root"</span> password=<span class="string">"123456"</span>/&gt; --&gt;</span><br><span class="line">	&lt;/dataHost&gt;</span><br><span class="line">&lt;/myca<span class="variable">t:schema</span>&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">[root@mycat ~]# <span class="keyword">vi</span> server.xml</span><br><span class="line">&lt;?xml <span class="keyword">version</span>=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</span><br><span class="line">&lt;!DOCTYPE myca<span class="variable">t:server</span> SYSTEM <span class="string">"server.dtd"</span>&gt;</span><br><span class="line">&lt;myca<span class="variable">t:server</span> xmln<span class="variable">s:mycat</span>=<span class="string">"http://org.opencloudb/"</span>&gt;</span><br><span class="line">	&lt;<span class="built_in">system</span>&gt;</span><br><span class="line">	&lt;property name=<span class="string">"defaultSqlParser"</span>&gt;druidparser&lt;/property&gt;</span><br><span class="line">      &lt;!--  &lt;property name=<span class="string">"useCompression"</span>&gt;<span class="number">1</span>&lt;/property&gt;--&gt; &lt;!--<span class="number">1</span>为开启mysql压缩协议--&gt;</span><br><span class="line">	&lt;!-- &lt;property name=<span class="string">"processorBufferChunk"</span>&gt;<span class="number">40960</span>&lt;/property&gt; --&gt;</span><br><span class="line">	&lt;!-- </span><br><span class="line">	&lt;property name=<span class="string">"processors"</span>&gt;<span class="number">1</span>&lt;/property&gt; </span><br><span class="line">	&lt;property name=<span class="string">"processorExecutor"</span>&gt;<span class="number">32</span>&lt;/property&gt; </span><br><span class="line">	 --&gt;</span><br><span class="line">		&lt;!--默认是<span class="number">65535</span> <span class="number">64</span>K 用于sql解析时最大文本长度 --&gt;</span><br><span class="line">		&lt;!--&lt;property name=<span class="string">"maxStringLiteralLength"</span>&gt;<span class="number">65535</span>&lt;/property&gt;--&gt;</span><br><span class="line">		&lt;!--&lt;property name=<span class="string">"sequnceHandlerType"</span>&gt;<span class="number">0</span>&lt;/property&gt;--&gt;</span><br><span class="line">		&lt;!--&lt;property name=<span class="string">"backSocketNoDelay"</span>&gt;<span class="number">1</span>&lt;/property&gt;--&gt;</span><br><span class="line">		&lt;!--&lt;property name=<span class="string">"frontSocketNoDelay"</span>&gt;<span class="number">1</span>&lt;/property&gt;--&gt;</span><br><span class="line">		&lt;!--&lt;property name=<span class="string">"processorExecutor"</span>&gt;<span class="number">16</span>&lt;/property&gt;--&gt;</span><br><span class="line">		&lt;!-- </span><br><span class="line">			&lt;property name=<span class="string">"mutiNodeLimitType"</span>&gt;<span class="number">1</span>&lt;/property&gt; <span class="number">0</span>：开启小数量级（默认） ；<span class="number">1</span>：开启亿级数据排序</span><br><span class="line">	    	&lt;property name=<span class="string">"mutiNodePatchSize"</span>&gt;<span class="number">100</span>&lt;/property&gt; 亿级数量排序批量</span><br><span class="line">			&lt;property name=<span class="string">"processors"</span>&gt;<span class="number">32</span>&lt;/property&gt;</span><br><span class="line">			&lt;property name=<span class="string">"processorExecutor"</span>&gt;<span class="number">32</span>&lt;/property&gt; </span><br><span class="line">			&lt;property name=<span class="string">"serverPort"</span>&gt;<span class="number">8066</span>&lt;/property&gt; </span><br><span class="line">			&lt;property name=<span class="string">"managerPort"</span>&gt;<span class="number">9066</span>&lt;/property&gt; </span><br><span class="line">			&lt;property name=<span class="string">"idleTimeout"</span>&gt;<span class="number">300000</span>&lt;/property&gt; </span><br><span class="line">			&lt;property name=<span class="string">"bindIp"</span>&gt;<span class="number">0.0</span>.<span class="number">0.0</span>&lt;/property&gt; </span><br><span class="line">			&lt;property name=<span class="string">"frontWriteQueueSize"</span>&gt;<span class="number">4096</span>&lt;/property&gt; </span><br><span class="line">			&lt;property name=<span class="string">"processors"</span>&gt;<span class="number">32</span>&lt;/property&gt; --&gt;</span><br><span class="line">	&lt;/<span class="built_in">system</span>&gt;</span><br><span class="line">	</span><br><span class="line">	&lt;!--定义test用户，访问TESTDB的逻辑库(schema.xml中定义)--&gt;</span><br><span class="line">	&lt;user name=<span class="string">"test"</span>&gt;</span><br><span class="line">		&lt;property name=<span class="string">"password"</span>&gt;test&lt;/property&gt;</span><br><span class="line">		&lt;property name=<span class="string">"schemas"</span>&gt;TESTDB&lt;/property&gt;</span><br><span class="line">	&lt;/user&gt;</span><br><span class="line"></span><br><span class="line">	&lt;user name=<span class="string">"user"</span>&gt;</span><br><span class="line">		&lt;property name=<span class="string">"password"</span>&gt;user&lt;/property&gt;</span><br><span class="line">		&lt;property name=<span class="string">"schemas"</span>&gt;TESTDB&lt;/property&gt;</span><br><span class="line">		&lt;property name=<span class="string">"readOnly"</span>&gt;true&lt;/property&gt;</span><br><span class="line">	&lt;/user&gt;</span><br><span class="line">	</span><br><span class="line">	&lt;!-- </span><br><span class="line">	&lt;quarantine&gt; </span><br><span class="line">	   &lt;whitehost&gt;</span><br><span class="line">	      &lt;host host=<span class="string">"127.0.0.1"</span> user=<span class="string">"mycat"</span>/&gt;</span><br><span class="line">	      &lt;host host=<span class="string">"127.0.0.2"</span> user=<span class="string">"mycat"</span>/&gt;</span><br><span class="line">	   &lt;/whitehost&gt;</span><br><span class="line">       &lt;blacklist check=<span class="string">"false"</span>&gt;&lt;/blacklist&gt;</span><br><span class="line">	&lt;/quarantine&gt;</span><br><span class="line">	--&gt;</span><br><span class="line">&lt;/myca<span class="variable">t:server</span>&gt;</span><br></pre></td></tr></table></figure>]]></content>
    <summary type="html">
    <![CDATA[<h1 id="MyCat介绍">MyCat介绍</h1><h2 id="什么是MyCat">什么是MyCat</h2><ul>
<li>一个彻底开源的，面向企业应用开发的大数据库集群</li>
<li>支持事务、ACID、可以替代MySQL的加强版数据库</li>
<li>一个可以视为MySQL集群的企业级数据库，用来替代昂贵的Oracle集群</li>
<li>一个融合内存缓存技术、NoSQL技术、HDFS大数据的新型SQL Server</li>
<li>结合传统数据库和新型分布式数据仓库的新一代企业级数据库产品</li>
<li>一个新颖的数据库中间件产品</li>
</ul>
<p>MyCat官网：<a href="http://www.mycat.org.cn/">http://www.mycat.org.cn/</a></p>
<h2 id="优势">优势</h2><p>copy官方的说明：<br>基于阿里开源的Cobar产品而研发，Cobar的稳定性、可靠性、优秀的架构和性能以及众多成熟的使用案例使得MYCAT一开始就拥有一个很好的起点，站在巨人的肩膀上，我们能看到更远。业界优秀的开源项目和创新思路被广泛融入到MYCAT的基因中，使得MYCAT在很多方面都领先于目前其他一些同类的开源项目，甚至超越某些商业产品。</p>
<p>MYCAT背后有一支强大的技术团队，其参与者都是5年以上资深软件工程师、架构师、DBA等，优秀的技术团队保证了MYCAT的产品质量。</p>
<p>MYCAT并不依托于任何一个商业公司，因此不像某些开源项目，将一些重要的特性封闭在其商业产品中，使得开源项目成了一个摆设（猜测是说的淘宝的TDDL，只开源动态数据源，分表分库部分还未开源）。</p>]]>
    
    </summary>
    
      <category term="Database" scheme="http://www.mr-wang.cn/tags/Database/"/>
    
      <category term="技术" scheme="http://www.mr-wang.cn/categories/%E6%8A%80%E6%9C%AF/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Mysql主从复制及读写分离的实现-Amoeba]]></title>
    <link href="http://www.mr-wang.cn/2016/03/05/Mysql-Master-slave-Read-Write-Splitting-Amoeba/"/>
    <id>http://www.mr-wang.cn/2016/03/05/Mysql-Master-slave-Read-Write-Splitting-Amoeba/</id>
    <published>2016-03-05T12:26:27.000Z</published>
    <updated>2016-04-01T06:35:47.334Z</updated>
    <content type="html"><![CDATA[<h1 id="Amoeba简介">Amoeba简介</h1><p>Amoeba(变形虫)项目,该开源框架于2008年开始发布一款 Amoeba for Mysql软件。这个软件致力于MySQL的分布式数据库前端代理层，它主要在应用层访问MySQL的 时候充当SQL路由功能，专注于分布式数据库代理层（Database Proxy）开发。座落与 Client、DB Server(s)之间,对客户端透明。具有负载均衡、高可用性、SQL 过滤、读写分离、可路由相关的到目标数据库、可并发请求多台数据库合并结果。 通过Amoeba你能够完成多数据源的高可用、负载均衡、数据切片的功能，目前Amoeba已在很多企业的生产线上面使用</p>
<p>Amoeba优缺点<br>优点：<br>1、降低费用，简单易用<br>2、提高系统整体可用性<br>3、易于扩展处理能力与系统规模<br>4、可以直接实现读写分离及负载均衡效果，而不用修改代码<br>缺点：<br>1、不支持事务与存储过程<br>2、暂不支持分库分表，amoeba目前只做到分数据库实例<br>3、不适合从amoeba导数据的场景或者对大数据量查询的query并不合适（比如一次请求返回10w以上甚至更多数据的场合）</p>
<p>Mysql GTID<br>Mysql 5.6的新特性之一，加入了全局事务性ID(GTID:Global Transactions Identifier)来强化数据库的主备一致性，故障恢复，以及容错能力;也使得复制功能的配置、监控及管理变得更加易于实现，且更加健壮。</p>
<a id="more"></a>
<h1 id="Mysql主从配置">Mysql主从配置</h1><h2 id="环境介绍：">环境介绍：</h2><p>两台Mysql数据库实现主从配置<br>Amoeba:172.16.14.1<br>Mysql Master:172.16.14.2<br>Mysql Slave:172.16.14.3</p>
<h2 id="在Master服务器上安装并配置Mysql">在Master服务器上安装并配置Mysql</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#安装Mysql并加入到系统服务</span><br><span class="line">[root@master ~]# tar xf mysql-<span class="number">5.6</span>.<span class="number">13</span>-linux-glibc2.<span class="number">5</span>-x86_64.tar.gz -C /usr/local/</span><br><span class="line">[root@master ~]# <span class="keyword">cd</span> /usr/local/</span><br><span class="line">[root@master local]# <span class="keyword">ln</span> -<span class="keyword">s</span> mysql-<span class="number">5.6</span>.<span class="number">13</span>-linux-glibc2.<span class="number">5</span>-x86_64 mysql</span><br><span class="line">[root@master local]# <span class="keyword">cd</span> mysql</span><br><span class="line">[root@master mysql]# <span class="keyword">cp</span> support-<span class="keyword">files</span>/mysql.server /etc/init.<span class="keyword">d</span>/mysqld</span><br><span class="line">[root@master mysql]# chmod +<span class="keyword">x</span> /etc/init.<span class="keyword">d</span>/mysqld</span><br><span class="line">[root@master mysql]# chkconfig --<span class="built_in">add</span> mysqld</span><br><span class="line">[root@master mysql]# <span class="keyword">echo</span> <span class="string">"PATH=/usr/local/mysql/bin:$PATH"</span> &gt;&gt; /etc/<span class="keyword">profile</span></span><br><span class="line">[root@master mysql]# . /etc/<span class="keyword">profile</span></span><br></pre></td></tr></table></figure>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">#提供主配置文件</span><br><span class="line">[root@master mysql]# <span class="keyword">vim</span> /etc/my.<span class="keyword">cnf</span></span><br><span class="line">[client]</span><br><span class="line">#password       = your_password</span><br><span class="line">port            = <span class="number">3306</span></span><br><span class="line">socket          = /tmp/mysql.sock</span><br><span class="line">[mysqld]</span><br><span class="line">port            = <span class="number">3306</span></span><br><span class="line">socket          = /tmp/mysql.sock</span><br><span class="line">skip-external-locking</span><br><span class="line">key_buffer_size = <span class="number">256</span>M</span><br><span class="line">max_allowed_packet = <span class="number">1</span>M</span><br><span class="line">table_open_cache = <span class="number">256</span></span><br><span class="line">sort_buffer_size = <span class="number">1</span>M</span><br><span class="line">read_buffer_size = <span class="number">1</span>M</span><br><span class="line">read_rnd_buffer_size = <span class="number">4</span>M</span><br><span class="line">myisam_sort_buffer_size = <span class="number">64</span>M</span><br><span class="line">thread_cache_size = <span class="number">8</span></span><br><span class="line">query_cache_size= <span class="number">16</span>M</span><br><span class="line">thread_concurrency = <span class="number">8</span></span><br><span class="line">binlog-format=ROW</span><br><span class="line"><span class="built_in">log</span>-slave-updates=true</span><br><span class="line">gtid-<span class="built_in">mode</span>=<span class="keyword">on</span></span><br><span class="line">enforce-gtid-consistency=true</span><br><span class="line">master-info-repository=TABLE</span><br><span class="line">relay-<span class="built_in">log</span>-info-repository=TABLE</span><br><span class="line"><span class="keyword">sync</span>-master-info=<span class="number">1</span></span><br><span class="line">slave-parallel-workers=<span class="number">2</span></span><br><span class="line">binlog-checksum=CRC32</span><br><span class="line">master-verify-checksum=<span class="number">1</span></span><br><span class="line">slave-sql-verify-checksum=<span class="number">1</span></span><br><span class="line">binlog-rows-query-log_events=<span class="number">1</span></span><br><span class="line">report-port=<span class="number">3306</span></span><br><span class="line">datadir=/data</span><br><span class="line">report-host=master.allen.<span class="keyword">com</span></span><br><span class="line"><span class="built_in">log</span>-bin=mysql-bin</span><br><span class="line">server-id       = <span class="number">10</span></span><br><span class="line">[mysqldump]</span><br><span class="line">quick</span><br><span class="line">max_allowed_packet = <span class="number">16</span>M</span><br><span class="line">[mysql]</span><br><span class="line"><span class="keyword">no</span>-auto-rehash</span><br><span class="line">[myisamchk]</span><br><span class="line">key_buffer_size = <span class="number">128</span>M</span><br><span class="line">sort_buffer_size = <span class="number">128</span>M</span><br><span class="line">read_buffer = <span class="number">2</span>M</span><br><span class="line">write_buffer = <span class="number">2</span>M</span><br><span class="line">[mysqlhotcopy]</span><br><span class="line">interactive-timeout</span><br></pre></td></tr></table></figure>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#初始化Mysql</span><br><span class="line">[root@master mysql]# useradd -<span class="keyword">r</span> mysql</span><br><span class="line">[root@master mysql]# <span class="built_in">mkdir</span> /data</span><br><span class="line">[root@master mysql]# chown -R mysql.mysql /data</span><br><span class="line">[root@master mysql]# chown -R root.mysql /usr/local/mysql/*</span><br><span class="line">[root@master mysql]# ./scripts/mysql_install_db --user=mysql --datadir=/data/</span><br><span class="line">[root@master ~]# service mysqld start</span><br></pre></td></tr></table></figure>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#在Slave服务器上安装Mysql与在Master服务器上安装方法相同，而在Slave服务器上安装Mysql有两个参数与Master服务器不同；如下</span><br><span class="line">server-id=<span class="number">11</span></span><br><span class="line">report-host=slave.allen.<span class="keyword">com</span></span><br><span class="line">[root@slave ~]# service mysqld start</span><br></pre></td></tr></table></figure>
<h2 id="在Master服务器上为Slave创建复制用户并测试连接">在Master服务器上为Slave创建复制用户并测试连接</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mysql</span><br><span class="line">mysql&gt; grant replication slave,replication client <span class="keyword">on</span> *.* <span class="keyword">to</span> <span class="string">'slave'</span>@<span class="string">'172.16.%.%'</span> identified by <span class="string">'passwd'</span>;</span><br><span class="line">mysql&gt; flush privileges;</span><br><span class="line">------------------------------------------------------------------------</span><br><span class="line">######测试连接</span><br><span class="line">[root@slave ~]# mysql -uslave -ppasswd -<span class="keyword">h</span> <span class="number">172.16</span>.<span class="number">14.2</span></span><br></pre></td></tr></table></figure>
<h2 id="启动从节点的复制线程">启动从节点的复制线程</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# mysql</span><br><span class="line">mysql&gt; change master to master_host='172.16.14.2',master_user='slave',master_password='passwd',master_auto_position=1;</span><br><span class="line">mysql&gt; start slave;</span><br><span class="line">mysql&gt; show slave status\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 172.16.14.2</span><br><span class="line">                  Master_User: slave</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000005</span><br><span class="line">          Read_Master_Log_Pos: 191</span><br><span class="line">               Relay_Log_File: slave-relay-bin.000003</span><br><span class="line">                Relay_Log_Pos: 401</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000005</span><br><span class="line">             Slave_IO_Running: Yes      #主要看这两项为“YES”说明成功</span><br><span class="line">            Slave_SQL_Running: Yes</span><br></pre></td></tr></table></figure>
<h2 id="在Master服务器创建数据库查看Slave服务器是否更新">在Master服务器创建数据库查看Slave服务器是否更新</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mysql -<span class="keyword">e</span> <span class="string">'create database allen;'</span></span><br><span class="line">------------------------------------------------------------------------</span><br><span class="line">[root@slave ~]# mysql -<span class="keyword">e</span> <span class="string">'show databases;'</span></span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| allen              |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| test               |</span><br><span class="line">+--------------------+</span><br><span class="line">#由上可见，新创建的<span class="string">"allen"</span>数据库已成功同步</span><br></pre></td></tr></table></figure>
<p>至此Mysql 5.6 基于GTID的复制已经完成，下面将介绍如何基于Mysql的主从复制架构做读写分离</p>
<h1 id="读写分离配置">读写分离配置</h1><p>基于前面做的Mysql主从架构，然后在前端加一台服务器，用于实现Mysql的读写分离，IP地址为：172.16.14.1；由于Amoeba是java程序所研发，所以需要先安装JDK程序</p>
<h2 id="安装JDK">安装JDK</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@amoeba ~]# tar xzvf jdk-7u72-linux-x64.tar.gz</span><br><span class="line">[root@amoeba ~]# chown -R /usr/local/java</span><br><span class="line">[root@amoeba ~]# mv jdk1.7.0_72 /usr/local/java</span><br><span class="line">[root@amoeba ~]# vim /etc/profile</span><br><span class="line">export JAVA_HOME=/usr/local/java/jdk1.7.0_72</span><br><span class="line">export CLASSPATH=.:$JAVA_HOME/jre/lib/rt.jar:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar</span><br><span class="line">export PATH=$PATH:$JAVA_HOME/bin</span><br><span class="line">[root@amoeba ~]# source /etc/profile</span><br><span class="line">[root@amoeba ~]# java -version</span><br><span class="line">java version "1.7.0_72"</span><br><span class="line">Java(TM) SE Runtime Environment (build 1.7.0_72-b14)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 24.72-b04, mixed mode)</span><br></pre></td></tr></table></figure>
<h2 id="安装Amoeba">安装Amoeba</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@amoeba ~]# unzip amoeba-mysql-<span class="number">3.0</span>.<span class="number">5</span>-RC-distribution.zip </span><br><span class="line">[root@amoeba ~]# mv amoeba /usr/local/</span><br></pre></td></tr></table></figure>
<h2 id="授权Mysql用户，用于实现前端Amoeba连接">授权Mysql用户，用于实现前端Amoeba连接</h2><p>由于上面授权的主从复制帐号不能同步”mysql”数据库，所以用户名也无法同步，要在两台数据库上同时授权，用户名密码保持一致</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#主mysql</span><br><span class="line">[root@master ~]# mysql</span><br><span class="line">mysql&gt; grant <span class="keyword">all</span> <span class="keyword">on</span> *.* <span class="keyword">to</span> <span class="string">'amoeba'</span>@<span class="string">'172.16.%.%'</span> identified by <span class="string">'amoebapass'</span>;</span><br><span class="line">mysql&gt; flush privileges;</span><br><span class="line"></span><br><span class="line">#备mysql</span><br><span class="line">[root@slave ~]# mysql</span><br><span class="line">mysql&gt; grant <span class="keyword">all</span> <span class="keyword">on</span> *.* <span class="keyword">to</span> <span class="string">'amoeba'</span>@<span class="string">'172.16.%.%'</span> identified by <span class="string">'amoebapass'</span>;</span><br><span class="line">mysql&gt; flush privileges;</span><br></pre></td></tr></table></figure>
<h2 id="配置Amoeba">配置Amoeba</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">[root@amoeba ~]# cd /usr/local/amoeba/conf/  #主要配置文件为以下两个</span><br><span class="line">amoeba.xml        #定义数据库读写分离及节点管理信息等</span><br><span class="line">dbServers.xml     #定义连接后端Mysql服务器信息</span><br><span class="line">------------------------------------------------------------------------</span><br><span class="line">[root@amoeba conf]# vim dbServers.xml</span><br><span class="line">&lt;?xml version="1.0" encoding="gbk"?&gt;</span><br><span class="line">&lt;!DOCTYPE amoeba:dbServers SYSTEM "dbserver.dtd"&gt;</span><br><span class="line">&lt;amoeba:dbServers xmlns:amoeba="http://amoeba.meidusa.com/"&gt;</span><br><span class="line">        &lt;!--</span><br><span class="line">            Each dbServer needs to be configured into a Pool,</span><br><span class="line">            If you need to configure multiple dbServer with load balancing that can be simplified by the following configuration:</span><br><span class="line">             add attribute with name virtual = "true" in dbServer, but the configuration does not allow the element with name factoryConfig</span><br><span class="line">             such as 'multiPool' dbServer</span><br><span class="line">        --&gt;</span><br><span class="line">    &lt;dbServer name="abstractServer" abstractive="true"&gt;</span><br><span class="line">        &lt;factoryConfig class="com.meidusa.amoeba.mysql.net.MysqlServerConnectionFactory"&gt;</span><br><span class="line">            &lt;property name="manager"&gt;$&#123;defaultManager&#125;&lt;/property&gt;</span><br><span class="line">            &lt;property name="sendBufferSize"&gt;64&lt;/property&gt;</span><br><span class="line">            &lt;property name="receiveBufferSize"&gt;128&lt;/property&gt;</span><br><span class="line">            &lt;!-- mysql port --&gt;</span><br><span class="line">            &lt;property name="port"&gt;3306&lt;/property&gt;</span><br><span class="line">            #连接后端Mysql服务器端口</span><br><span class="line">            &lt;!-- mysql schema --&gt;</span><br><span class="line">            &lt;property name="schema"&gt;test&lt;/property&gt;</span><br><span class="line">            #连接到后端Mysql使用的默认数据库</span><br><span class="line">            &lt;!-- mysql user --&gt;</span><br><span class="line">            &lt;property name="user"&gt;amoeba&lt;/property&gt;</span><br><span class="line">            #连接后端Mysql数据库的用户名</span><br><span class="line">            &lt;property name="password"&gt;amoebapass&lt;/property&gt;</span><br><span class="line">                #连接后端Mysql数据库的用户名</span><br><span class="line">        &lt;/factoryConfig&gt;</span><br><span class="line">        &lt;poolConfig class="com.meidusa.amoeba.net.poolable.PoolableObjectPool"&gt;</span><br><span class="line">            &lt;property name="maxActive"&gt;500&lt;/property&gt;</span><br><span class="line">            &lt;property name="maxIdle"&gt;500&lt;/property&gt;</span><br><span class="line">            &lt;property name="minIdle"&gt;10&lt;/property&gt;</span><br><span class="line">            &lt;property name="minEvictableIdleTimeMillis"&gt;600000&lt;/property&gt;</span><br><span class="line">            &lt;property name="timeBetweenEvictionRunsMillis"&gt;600000&lt;/property&gt;</span><br><span class="line">            &lt;property name="testOnBorrow"&gt;true&lt;/property&gt;</span><br><span class="line">            &lt;property name="testOnReturn"&gt;true&lt;/property&gt;</span><br><span class="line">            &lt;property name="testWhileIdle"&gt;true&lt;/property&gt;</span><br><span class="line">        &lt;/poolConfig&gt;</span><br><span class="line">    &lt;/dbServer&gt;</span><br><span class="line">                        #定义"master"数据库节点,"name"名称可以自定义</span><br><span class="line">    &lt;dbServer name="master"  parent="abstractServer"&gt;</span><br><span class="line">        &lt;factoryConfig&gt;</span><br><span class="line">            &lt;!-- mysql ip --&gt;</span><br><span class="line">            &lt;property name="ipAddress"&gt;172.16.14.2&lt;/property&gt;</span><br><span class="line">        &lt;/factoryConfig&gt;</span><br><span class="line">    &lt;/dbServer&gt;</span><br><span class="line">                       #定义"slave"数据库节点</span><br><span class="line">    &lt;dbServer name="slave"  parent="abstractServer"&gt;</span><br><span class="line">        &lt;factoryConfig&gt;</span><br><span class="line">            &lt;!-- mysql ip --&gt;</span><br><span class="line">            &lt;property name="ipAddress"&gt;172.16.14.3&lt;/property&gt;</span><br><span class="line">        &lt;/factoryConfig&gt;</span><br><span class="line">    &lt;/dbServer&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dbServer name="multiPool" virtual="true"&gt;</span><br><span class="line">        &lt;poolConfig class="com.meidusa.amoeba.server.MultipleServerPool"&gt;</span><br><span class="line">            &lt;!-- Load balancing strategy: 1=ROUNDROBIN , 2=WEIGHTBASED , 3=HA--&gt; #这里注释的为算法</span><br><span class="line">            &lt;property name="loadbalance"&gt;1&lt;/property&gt;</span><br><span class="line">            #定义选择哪一种算法进行负载均衡调度</span><br><span class="line">            &lt;!-- Separated by commas,such as: server1,server2,server1 --&gt;</span><br><span class="line">#定义数据库池,用于实现负载均衡."slave"为上面定义的从数据库节点，可以写多个用","分隔;</span><br><span class="line">如:"slave,slave,master"可以实现基于权重负载的效果;当然这里也可以不用定义</span><br><span class="line">            &lt;property name="poolNames"&gt;slave&lt;/property&gt;</span><br><span class="line">        &lt;/poolConfig&gt;</span><br><span class="line">    &lt;/dbServer&gt;</span><br><span class="line">&lt;/amoeba:dbServers&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">========================================================================</span><br><span class="line">[root@amoeba conf]# vim amoeba.xml</span><br><span class="line">&lt;?xml version="1.0" encoding="gbk"?&gt;</span><br><span class="line">&lt;!DOCTYPE amoeba:configuration SYSTEM "amoeba.dtd"&gt;</span><br><span class="line">&lt;amoeba:configuration xmlns:amoeba="http://amoeba.meidusa.com/"&gt;</span><br><span class="line">    &lt;proxy&gt;</span><br><span class="line">        &lt;!-- service class must implements com.meidusa.amoeba.service.Service --&gt;</span><br><span class="line">&lt;service name="Amoeba for Mysql" class="com.meidusa.amoeba.net.ServerableConnectionManager"&gt;</span><br><span class="line">            &lt;!-- port --&gt; #定义amoeba代理服务器的对外连接监听端口</span><br><span class="line">            &lt;property name="port"&gt;3306&lt;/property&gt;   </span><br><span class="line">            &lt;!-- bind ipAddress --&gt; #定义amoeba代理服务器对外连接的监听IP</span><br><span class="line">            &lt;property name="ipAddress"&gt;172.16.14.1&lt;/property&gt;   </span><br><span class="line">            &lt;property name="manager"&gt;$&#123;clientConnectioneManager&#125;&lt;/property&gt;</span><br><span class="line">            &lt;property name="connectionFactory"&gt;</span><br><span class="line">                &lt;bean class="com.meidusa.amoeba.mysql.net.MysqlClientConnectionFactory"&gt;</span><br><span class="line">                    &lt;property name="sendBufferSize"&gt;128&lt;/property&gt;</span><br><span class="line">                    &lt;property name="receiveBufferSize"&gt;64&lt;/property&gt;</span><br><span class="line">                &lt;/bean&gt;</span><br><span class="line">            &lt;/property&gt;   </span><br><span class="line">            &lt;property name="authenticator"&gt;</span><br><span class="line">                &lt;bean class="com.meidusa.amoeba.mysql.server.MysqlClientAuthenticator"&gt;             </span><br><span class="line">    #定义amoeba连接用户名和密码，客户端或程序只需要使用此用户名和密码连接即可</span><br><span class="line">                    &lt;property name="user"&gt;admin&lt;/property&gt;         </span><br><span class="line">                    &lt;property name="password"&gt;password&lt;/property&gt;           </span><br><span class="line">                    &lt;property name="filter"&gt;</span><br><span class="line">                        &lt;bean class="com.meidusa.amoeba.server.IPAccessController"&gt;</span><br><span class="line">                    &lt;property name="ipFile"&gt;$&#123;amoeba.home&#125;/conf/access_list.conf&lt;/property&gt;</span><br><span class="line">                        &lt;/bean&gt;</span><br><span class="line">                    &lt;/property&gt;</span><br><span class="line">                &lt;/bean&gt;</span><br><span class="line">            &lt;/property&gt;   </span><br><span class="line">        &lt;/service&gt;</span><br><span class="line">        &lt;!-- server class must implements com.meidusa.amoeba.service.Service --&gt;</span><br><span class="line">        &lt;service name="Amoeba Monitor Server" class="com.meidusa.amoeba.monitor.MonitorServer"&gt;</span><br><span class="line">            &lt;!-- port --&gt;</span><br><span class="line">            &lt;!--  default value: random number</span><br><span class="line">            &lt;property name="port"&gt;9066&lt;/property&gt;</span><br><span class="line">            --&gt;</span><br><span class="line">            &lt;!-- bind ipAddress --&gt;</span><br><span class="line">            &lt;property name="ipAddress"&gt;127.0.0.1&lt;/property&gt;</span><br><span class="line">            &lt;property name="daemon"&gt;true&lt;/property&gt;</span><br><span class="line">            &lt;property name="manager"&gt;$&#123;clientConnectioneManager&#125;&lt;/property&gt;</span><br><span class="line">            &lt;property name="connectionFactory"&gt;</span><br><span class="line">            &lt;bean class="com.meidusa.amoeba.monitor.net.MonitorClientConnectionFactory"&gt;&lt;/bean&gt;</span><br><span class="line">            &lt;/property&gt;   </span><br><span class="line">        &lt;/service&gt;</span><br><span class="line">        &lt;runtime class="com.meidusa.amoeba.mysql.context.MysqlRuntimeContext"&gt;</span><br><span class="line">            &lt;!-- proxy server net IO Read thread size --&gt;</span><br><span class="line">            &lt;property name="readThreadPoolSize"&gt;20&lt;/property&gt;   </span><br><span class="line">            &lt;!-- proxy server client process thread size --&gt;</span><br><span class="line">            &lt;property name="clientSideThreadPoolSize"&gt;30&lt;/property&gt;</span><br><span class="line">            &lt;!-- mysql server data packet process thread size --&gt;</span><br><span class="line">            &lt;property name="serverSideThreadPoolSize"&gt;30&lt;/property&gt;</span><br><span class="line">            &lt;!-- per connection cache prepared statement size  --&gt;</span><br><span class="line">            &lt;property name="statementCacheSize"&gt;500&lt;/property&gt; </span><br><span class="line">            &lt;!-- query timeout( default: 60 second , TimeUnit:second) --&gt;</span><br><span class="line">            &lt;property name="queryTimeout"&gt;60&lt;/property&gt;</span><br><span class="line">        &lt;/runtime&gt;</span><br><span class="line">    &lt;/proxy&gt;</span><br><span class="line">    &lt;!--</span><br><span class="line">        Each ConnectionManager will start as thread</span><br><span class="line">        manager responsible for the Connection IO read , Death Detection</span><br><span class="line">    --&gt;</span><br><span class="line">    &lt;connectionManagerList&gt;</span><br><span class="line">    &lt;connectionManager name="clientConnectioneManager" class="com.meidusa.amoeba.net.MultiConnectionManagerWrapper"&gt;</span><br><span class="line">    &lt;property name="subManagerClassName"&gt;com.meidusa.amoeba.net.ConnectionManager&lt;/property&gt;</span><br><span class="line">            &lt;!--</span><br><span class="line">              default value is avaliable Processors</span><br><span class="line">            &lt;property name="processors"&gt;5&lt;/property&gt;</span><br><span class="line">             --&gt;</span><br><span class="line">        &lt;/connectionManager&gt;</span><br><span class="line">&lt;connectionManager name="defaultManager" class="com.meidusa.amoeba.net.MultiConnectionManagerWrapper"&gt;</span><br><span class="line">&lt;property name="subManagerClassName"&gt;com.meidusa.amoeba.net.AuthingableConnectionManager&lt;/property&gt;</span><br><span class="line">            &lt;!--</span><br><span class="line">              default value is avaliable Processors</span><br><span class="line">            &lt;property name="processors"&gt;5&lt;/property&gt;</span><br><span class="line">             --&gt;</span><br><span class="line">        &lt;/connectionManager&gt;</span><br><span class="line">    &lt;/connectionManagerList&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- default using file loader --&gt;</span><br><span class="line">    &lt;dbServerLoader class="com.meidusa.amoeba.context.DBServerConfigFileLoader"&gt;</span><br><span class="line">        &lt;property name="configFile"&gt;$&#123;amoeba.home&#125;/conf/dbServers.xml&lt;/property&gt;</span><br><span class="line">    &lt;/dbServerLoader&gt;</span><br><span class="line">    &lt;queryRouter class="com.meidusa.amoeba.mysql.parser.MysqlQueryRouter"&gt;</span><br><span class="line">        &lt;property name="ruleLoader"&gt;</span><br><span class="line">            &lt;bean class="com.meidusa.amoeba.route.TableRuleFileLoader"&gt;</span><br><span class="line">                &lt;property name="ruleFile"&gt;$&#123;amoeba.home&#125;/conf/rule.xml&lt;/property&gt;</span><br><span class="line">                &lt;property name="functionFile"&gt;$&#123;amoeba.home&#125;/conf/ruleFunctionMap.xml&lt;/property&gt;</span><br><span class="line">            &lt;/bean&gt;</span><br><span class="line">        &lt;/property&gt;</span><br><span class="line">        &lt;property name="sqlFunctionFile"&gt;$&#123;amoeba.home&#125;/conf/functionMap.xml&lt;/property&gt;</span><br><span class="line">        &lt;property name="LRUMapSize"&gt;1500&lt;/property&gt;</span><br><span class="line">        &lt;property name="defaultPool"&gt;master&lt;/property&gt;</span><br><span class="line">        #定义默认池,一些sql语句默认会在此定义的服务器上执行</span><br><span class="line">        &lt;property name="writePool"&gt;master&lt;/property&gt;</span><br><span class="line">                #定义只写数据库</span><br><span class="line">        &lt;property name="readPool"&gt;slave&lt;/property&gt;</span><br><span class="line">#定义只读数据库,此处定义的是在"dbServer.xml"文件中定义的后端服务器名称，也可以定义数据库池的名称,实现负载均衡</span><br><span class="line">        &lt;property name="needParse"&gt;true&lt;/property&gt;</span><br><span class="line">    &lt;/queryRouter&gt;</span><br><span class="line">&lt;/amoeba:configuration&gt;</span><br></pre></td></tr></table></figure>
<h2 id="启动amoeba服务并连接测试">启动amoeba服务并连接测试</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@amoeba ~]# /usr/local/amoeba/bin/launcher &amp;</span><br><span class="line">[root@amoeba ~]# ss -tanlp | grep 3306</span><br><span class="line">LISTEN     0      128      ::ffff:172.16.14.1:3306     :::*      users:(("java",29448,54))</span><br><span class="line">#由上可见已启动成功并监听在3306端口</span><br></pre></td></tr></table></figure>
<h2 id="连接到amoeba代理服务器,执行插入与查询操作,查看是否实现读写分离">连接到amoeba代理服务器,执行插入与查询操作,查看是否实现读写分离</h2><p>略…</p>
]]></content>
    <summary type="html">
    <![CDATA[<h1 id="Amoeba简介">Amoeba简介</h1><p>Amoeba(变形虫)项目,该开源框架于2008年开始发布一款 Amoeba for Mysql软件。这个软件致力于MySQL的分布式数据库前端代理层，它主要在应用层访问MySQL的 时候充当SQL路由功能，专注于分布式数据库代理层（Database Proxy）开发。座落与 Client、DB Server(s)之间,对客户端透明。具有负载均衡、高可用性、SQL 过滤、读写分离、可路由相关的到目标数据库、可并发请求多台数据库合并结果。 通过Amoeba你能够完成多数据源的高可用、负载均衡、数据切片的功能，目前Amoeba已在很多企业的生产线上面使用</p>
<p>Amoeba优缺点<br>优点：<br>1、降低费用，简单易用<br>2、提高系统整体可用性<br>3、易于扩展处理能力与系统规模<br>4、可以直接实现读写分离及负载均衡效果，而不用修改代码<br>缺点：<br>1、不支持事务与存储过程<br>2、暂不支持分库分表，amoeba目前只做到分数据库实例<br>3、不适合从amoeba导数据的场景或者对大数据量查询的query并不合适（比如一次请求返回10w以上甚至更多数据的场合）</p>
<p>Mysql GTID<br>Mysql 5.6的新特性之一，加入了全局事务性ID(GTID:Global Transactions Identifier)来强化数据库的主备一致性，故障恢复，以及容错能力;也使得复制功能的配置、监控及管理变得更加易于实现，且更加健壮。</p>]]>
    
    </summary>
    
      <category term="Database" scheme="http://www.mr-wang.cn/tags/Database/"/>
    
      <category term="技术" scheme="http://www.mr-wang.cn/categories/%E6%8A%80%E6%9C%AF/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[阅读书单]]></title>
    <link href="http://www.mr-wang.cn/2015/10/15/book-list/"/>
    <id>http://www.mr-wang.cn/2015/10/15/book-list/</id>
    <published>2015-10-15T13:06:27.000Z</published>
    <updated>2016-04-01T05:03:41.000Z</updated>
    <content type="html"><![CDATA[<ul>
<li><p><strong>2015.07阅读清单</strong></p>
<ul>
<li>[x] Linux系统命令及Shell脚本实践指南（纸质）</li>
<li>[x] 高性能Linux服务器构建实战——系统安全、故障排查、自动化运维与集群架构（纸质）</li>
</ul>
</li>
<li><p><strong>2015.10阅读清单</strong></p>
<ul>
<li>[ ] 构建高性能Web站点（纸质）</li>
<li>[ ] 深入理解Nginx（纸质）</li>
</ul>
</li>
</ul>
]]></content>
    <summary type="html">
    <![CDATA[<ul>
<li><p><strong>2015.07阅读清单</strong></p>
<ul>
<li>[x] Linux系统命令及Shell脚本实践指南（纸质）</li>
<li>[x] 高性能Linux服务器构建实战——系统安全、故障排查、自动化运维与集群架构（纸质）</]]>
    </summary>
    
      <category term="阅读,书单" scheme="http://www.mr-wang.cn/tags/%E9%98%85%E8%AF%BB-%E4%B9%A6%E5%8D%95/"/>
    
      <category term="读书" scheme="http://www.mr-wang.cn/categories/%E8%AF%BB%E4%B9%A6/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[CentOS下Oracle安装]]></title>
    <link href="http://www.mr-wang.cn/2015/07/16/CentOS-Oracle-installation/"/>
    <id>http://www.mr-wang.cn/2015/07/16/CentOS-Oracle-installation/</id>
    <published>2015-07-16T12:26:27.000Z</published>
    <updated>2016-04-01T06:20:49.777Z</updated>
    <content type="html"><![CDATA[<h1 id="安装前准备">安装前准备</h1><h2 id="安装依赖包">安装依赖包</h2><p>oracle 安装所需程序包,可以到安装步骤时，查看缺少什么程序就安装什么程序</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">binutils-<span class="number">2.17</span>.<span class="number">50.0</span>.<span class="number">6</span></span><br><span class="line">compat-libstdc++-<span class="number">33</span>-<span class="number">3.2</span>.<span class="number">3</span></span><br><span class="line">compat-libstdc++-<span class="number">33</span>-<span class="number">3.2</span>.<span class="number">3</span> (<span class="number">32</span> bit)</span><br><span class="line">elfutils-libelf-<span class="number">0.125</span></span><br><span class="line">elfutils-libelf-devel-<span class="number">0.125</span></span><br><span class="line">gcc-<span class="number">4.1</span>.<span class="number">2</span></span><br><span class="line">gcc-<span class="keyword">c</span>++-<span class="number">4.1</span>.<span class="number">2</span></span><br><span class="line">glibc-<span class="number">2.5</span>-<span class="number">24</span></span><br><span class="line">glibc-<span class="number">2.5</span>-<span class="number">24</span> (<span class="number">32</span> bit)</span><br><span class="line">glibc-common-<span class="number">2.5</span></span><br><span class="line">glibc-devel-<span class="number">2.5</span></span><br><span class="line">glibc-devel-<span class="number">2.5</span> (<span class="number">32</span> bit)</span><br><span class="line">glibc-headers-<span class="number">2.5</span></span><br><span class="line">ksh-<span class="number">20060214</span></span><br><span class="line">libaio-<span class="number">0.3</span>.<span class="number">106</span></span><br><span class="line">libaio-<span class="number">0.3</span>.<span class="number">106</span> (<span class="number">32</span> bit)</span><br><span class="line">libaio-devel-<span class="number">0.3</span>.<span class="number">106</span></span><br><span class="line">libaio-devel-<span class="number">0.3</span>.<span class="number">106</span> (<span class="number">32</span> bit)</span><br><span class="line">libgcc-<span class="number">4.1</span>.<span class="number">2</span></span><br><span class="line">libgcc-<span class="number">4.1</span>.<span class="number">2</span> (<span class="number">32</span> bit)</span><br><span class="line">libstdc++-<span class="number">4.1</span>.<span class="number">2</span></span><br><span class="line">libstdc++-<span class="number">4.1</span>.<span class="number">2</span> (<span class="number">32</span> bit)</span><br><span class="line">libstdc++-devel <span class="number">4.1</span>.<span class="number">2</span></span><br><span class="line"><span class="keyword">make</span>-<span class="number">3.81</span></span><br><span class="line">sysstat-<span class="number">7.0</span>.<span class="number">2</span></span><br><span class="line">unixODBC-<span class="number">2.2</span>.<span class="number">14</span>-<span class="number">11</span>.el6 (x86_64) <span class="built_in">or</span> <span class="keyword">later</span></span><br><span class="line">unixODBC-<span class="number">2.2</span>.<span class="number">14</span>-<span class="number">11</span>.el6.i686 <span class="built_in">or</span> <span class="keyword">later</span></span><br><span class="line">unixODBC-devel-<span class="number">2.2</span>.<span class="number">14</span>-<span class="number">11</span>.el6 (x86_64) <span class="built_in">or</span> <span class="keyword">later</span></span><br><span class="line">unixODBC-devel-<span class="number">2.2</span>.<span class="number">14</span>-<span class="number">11</span>.el6.i686 <span class="built_in">or</span> <span class="keyword">later</span></span><br><span class="line">libXp</span><br></pre></td></tr></table></figure>
<p>使用命令 yum install -y ‘package name’ 安装所缺的程序包，pdksh包除外</p>
<p>安装pdksh包，使用rz命令上传pdksh-5.2.14-37.el5_8.1.x86_64.rpm文件到/opt/目录下</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 注意：该程序包与ksh冲突，如果已经安装ksh，建议使用命令 rpm -<span class="keyword">e</span> ksh-* 卸载</span><br><span class="line"></span><br><span class="line">rpm -ivh pdksh-<span class="number">5.2</span>.<span class="number">14</span>-<span class="number">37</span>.el5_8.<span class="number">1</span>.x86_64.rpm</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="创建用户及安装目录">创建用户及安装目录</h2><p>使用rz上传p10404530_112030_Linux-x86-64_1of7.zip、p10404530_112030_Linux-x86-64_2of7.zip到/opt/目录下</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 分别解压上传的文件,解压得到database文件夹</span><br><span class="line">unzip -x p10404530_112030_Linux-x86-64_1of7.zip</span><br><span class="line">unzip -x p10404530_112030_Linux-x86-64_2of7.zip</span><br><span class="line"></span><br><span class="line"># 创建oracle用户和组,并设置密码</span><br><span class="line">groupadd oinstall</span><br><span class="line">groupadd dba</span><br><span class="line">useradd -g oinstall -G dba oracle</span><br><span class="line">passwd oracle</span><br><span class="line"></span><br><span class="line"># 创建oracl安装目录，并将目录权限赋予oracle用户</span><br><span class="line">mkdir -p /data/DBSoft/oracle/product/11.2.0/db_1</span><br><span class="line">chown -R oracle:oinstall /data/DBSoft/oracle</span><br><span class="line">chmod -R 755 /data/DBSoft/oracle</span><br><span class="line"></span><br><span class="line"># 安装时还需要设置Inventory目录，所以创建并赋予权限</span><br><span class="line">mkdir -p /data/DBSoft/oraInventory</span><br><span class="line">chown -R oracle:oinstall /data/DBSoft/oraInventory</span><br><span class="line">chmod -R 755 /data/DBSoft/oraInventory</span><br></pre></td></tr></table></figure>
<h2 id="修改系统参数">修改系统参数</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"># 修改hosts文件，将127.0.0.1修改为本机的ip，避免安装Oracle在Oracle Net Configuration Assistant时会失败</span><br><span class="line">vi /etc/hosts</span><br><span class="line"></span><br><span class="line">192.168.1.250   dbsrver localhost</span><br><span class="line">::1     localhost6 localhost6.localdomain6</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 修改内核参数</span><br><span class="line">vi /etc/sysctl.conf</span><br><span class="line"></span><br><span class="line">kernel.shmmni = 4096</span><br><span class="line">kernel.sem = 250 32000 100 128</span><br><span class="line">net.ipv4.ip_local_port_range = 9000 65500</span><br><span class="line">fs.file-max = 6815744</span><br><span class="line">net.core.rmem_default = 262144</span><br><span class="line">net.core.rmem_max = 4194304</span><br><span class="line">net.core.wmem_default = 262144</span><br><span class="line">net.core.wmem_max = 1048576</span><br><span class="line">fs.aio-max-nr = 1048576</span><br><span class="line"></span><br><span class="line"># 再执行以下命令使以上配置立即生效</span><br><span class="line">sysctl -p</span><br><span class="line"></span><br><span class="line"># 编辑系统资源限制配置文件</span><br><span class="line">vi /etc/security/limits.conf</span><br><span class="line"></span><br><span class="line">oracle soft nproc 2047</span><br><span class="line">oracle hard nproc 16384</span><br><span class="line">oracle soft nofile 1024</span><br><span class="line">oracle hard nofile 65536</span><br></pre></td></tr></table></figure>
<h2 id="配置oracle默认安装参数">配置oracle默认安装参数</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 切换到orcale用户，修改/home/oracle/.bash_profile文件</span><br><span class="line">su - oracle</span><br><span class="line">vi ~/.bash_profile</span><br><span class="line"></span><br><span class="line"># 设置oracle用户环境变量，添加如下</span><br><span class="line">#安装目录</span><br><span class="line">export ORACLE_BASE=/data/DBSoft/oracle</span><br><span class="line">#oracle家目录</span><br><span class="line">export ORACLE_HOME=$ORACLE_BASE/product/11.2.0/db_1</span><br><span class="line">export PATH=$ORACLE_HOME/bin:$PATH</span><br><span class="line"></span><br><span class="line"># 保存退出后执行如下命令使以上设置立即生效,并env或者echo $PATH查看下</span><br><span class="line">source ~/.bash_profile</span><br></pre></td></tr></table></figure>
<h1 id="开始安装oracle">开始安装oracle</h1><h2 id="配置远程安装环境">配置远程安装环境</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># oracle安装需要X-window环境，但是考虑到最大化利用服务器性能，一般服务器中不会安装X-windows环境。所以选择远程来安装oracle。</span><br><span class="line"></span><br><span class="line"># 设置语言环境LANG和LC_ALL,改为英文环境</span><br><span class="line">export LANG=en_US</span><br><span class="line">export LC_ALL=en_US</span><br><span class="line"></span><br><span class="line"># 使用Xmanager来远程显示oracle的安装界面，安装过程中可能遇到界面显示不完全的问题，因为我是在虚拟机中安装，猜测是与内存大小有关</span><br><span class="line">export DISPLAY=192.168.1.233:0.0</span><br><span class="line">./runInstall</span><br></pre></td></tr></table></figure>
<h2 id="安装数据库软件">安装数据库软件</h2><p>1.进入图形化界面，一步步安装，取消勾选I wish…（依照个人），点击Next，弹出确认框再点Yes<br><img src="http://wy-uploads.qiniudn.com/oracle_1.png" alt="此处输入图片的描述"><br><img src="http://wy-uploads.qiniudn.com/oracle_2.png" alt="此处输入图片的描述"></p>
<p>2.询问是否软件升级，选择”Skip software updates”<br><img src="http://wy-uploads.qiniudn.com/oracle_3.png" alt="此处输入图片的描述"></p>
<p>3.选择第二项：Install database software only，只安装数据库软件<br><img src="http://wy-uploads.qiniudn.com/oracle_4.png" alt="此处输入图片的描述"></p>
<p>4.保持默认：Singel instance database installation，点击Next<br><img src="http://wy-uploads.qiniudn.com/oracle_5.png" alt="此处输入图片的描述"></p>
<p>5.选择产品语言，默认英语，附加选择了简体中文，点击Next<br><img src="http://wy-uploads.qiniudn.com/oracle_6.png" alt="此处输入图片的描述"></p>
<p>6.选择数据库版本，默认企业版，点击Next<br><img src="http://wy-uploads.qiniudn.com/oracle_7.png" alt="此处输入图片的描述"></p>
<p>7.配置Oracle安装目录，由于安装前环境变量的配置，安装程序自动读取配置，自动选择好了<br><img src="http://wy-uploads.qiniudn.com/oracle_8.png" alt="此处输入图片的描述"></p>
<p>8.同上，Oracle Inventory Directory目录也自动选择好了，oraInventory Group Name选择安装前创建的组oinstall，点击Next<br><img src="http://wy-uploads.qiniudn.com/oracle_9.png" alt="此处输入图片的描述"></p>
<p>9.保持默认，点击Next<br><img src="http://wy-uploads.qiniudn.com/oracle_10.png" alt="此处输入图片的描述"></p>
<p>10.安装检查中<br><img src="http://wy-uploads.qiniudn.com/oracle_11.png" alt="此处输入图片的描述"></p>
<p>11.检查结束，不满足条件列表,可以针对packages包进行yum install<br><img src="http://wy-uploads.qiniudn.com/oracle_12.png" alt="此处输入图片的描述"></p>
<p>12.忽略物理内存和交换分区的警告<br><img src="http://wy-uploads.qiniudn.com/oracle_13.png" alt="此处输入图片的描述"></p>
<p>13.配置确认，安装<br><img src="http://wy-uploads.qiniudn.com/oracle_14.png" alt="此处输入图片的描述"></p>
<p>14.root用户下，命令执行提示sh文件<br><img src="http://wy-uploads.qiniudn.com/oracle_15.png" alt="此处输入图片的描述"></p>
<h2 id="安装监听">安装监听</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 在oracle用户下</span><br><span class="line">netca</span><br></pre></td></tr></table></figure>
<p><img src="http://wy-uploads.qiniudn.com/oracle_31.png" alt="此处输入图片的描述"></p>
<p><img src="http://wy-uploads.qiniudn.com/oracle_32.png" alt="此处输入图片的描述"></p>
<p><img src="http://wy-uploads.qiniudn.com/oracle_33.png" alt="此处输入图片的描述"></p>
<p><img src="http://wy-uploads.qiniudn.com/oracle_34.png" alt="此处输入图片的描述"></p>
<p><img src="http://wy-uploads.qiniudn.com/oracle_35.png" alt="此处输入图片的描述"><br>提示1521端口被占用，这里是因为我安装过程中修改过hostname，导致的<br><img src="http://wy-uploads.qiniudn.com/oracle_36.png" alt="此处输入图片的描述"></p>
<p><img src="http://wy-uploads.qiniudn.com/oracle_37.png" alt="此处输入图片的描述"></p>
<h2 id="安装数据库实例">安装数据库实例</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 在oracle用户下</span><br><span class="line">dbca</span><br></pre></td></tr></table></figure>
<p><img src="http://wy-uploads.qiniudn.com/oracle_16.png" alt="此处输入图片的描述"></p>
<p><img src="http://wy-uploads.qiniudn.com/oracle_17.png" alt="此处输入图片的描述"></p>
<p><img src="http://wy-uploads.qiniudn.com/oracle_18.png" alt="此处输入图片的描述"><br>配置全局数据库名称<br><img src="http://wy-uploads.qiniudn.com/oracle_19.png" alt="此处输入图片的描述"><br>取消EM管理界面<br><img src="http://wy-uploads.qiniudn.com/oracle_20.png" alt="此处输入图片的描述"></p>
<p><img src="http://wy-uploads.qiniudn.com/oracle_21.png" alt="此处输入图片的描述"><br>备配置置超级管理员密码，统一密码<br><img src="http://wy-uploads.qiniudn.com/oracle_22.png" alt="此处输入图片的描述"></p>
<p><img src="http://wy-uploads.qiniudn.com/oracle_23.png" alt="此处输入图片的描述"></p>
<p><img src="http://wy-uploads.qiniudn.com/oracle_24.png" alt="此处输入图片的描述"></p>
<p><img src="http://wy-uploads.qiniudn.com/oracle_25.png" alt="此处输入图片的描述"><br>修改数据库字符编码<br><img src="http://wy-uploads.qiniudn.com/oracle_26.png" alt="此处输入图片的描述"></p>
<p><img src="http://wy-uploads.qiniudn.com/oracle_27.png" alt="此处输入图片的描述"></p>
<p><img src="http://wy-uploads.qiniudn.com/oracle_28.png" alt="此处输入图片的描述"></p>
<p><img src="http://wy-uploads.qiniudn.com/oracle_29.png" alt="此处输入图片的描述"></p>
<p><img src="http://wy-uploads.qiniudn.com/oracle_30.png" alt="此处输入图片的描述"></p>
<h2 id="配置本地网络服务名">配置本地网络服务名</h2><p>配置本地网络服务名（使服务器充当oracle客户端，连接自己，对数据库进行操作）</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 在oracle用户下</span><br><span class="line">netca</span><br></pre></td></tr></table></figure>
<p><img src="http://wy-uploads.qiniudn.com/oracle_38.png" alt="此处输入图片的描述"><br><img src="http://wy-uploads.qiniudn.com/oracle_39.png" alt="此处输入图片的描述"><br>输入连接的oracle服务器的数据库的实例名，这里输入本机的。<br><img src="http://wy-uploads.qiniudn.com/oracle_40.png" alt="此处输入图片的描述"><br><img src="http://wy-uploads.qiniudn.com/oracle_41.png" alt="此处输入图片的描述"><br>输入oracle服务器的ip地址，这里输入本机的ip<br><img src="http://wy-uploads.qiniudn.com/oracle_42.png" alt="此处输入图片的描述"><br>选中测试<br><img src="http://wy-uploads.qiniudn.com/oracle_43.png" alt="此处输入图片的描述"><br>点击change Login 输入所连接oracle服务器的其中某一个用户名和密码，点击OK<br><img src="http://wy-uploads.qiniudn.com/oracle_44.png" alt="此处输入图片的描述"><br>看到此界面说明测试成功<br><img src="http://wy-uploads.qiniudn.com/oracle_45.png" alt="此处输入图片的描述"><br>为你所设置的本地网络服务名起个名字，与实例名不能相同<br><img src="http://wy-uploads.qiniudn.com/oracle_46.png" alt="此处输入图片的描述"><br><img src="http://wy-uploads.qiniudn.com/oracle_47.png" alt="此处输入图片的描述"></p>
<h1 id="遇到的问题">遇到的问题</h1><h2 id="重启linux后，dbca命令无法找到">重启linux后，dbca命令无法找到</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/profile</span><br><span class="line"></span><br><span class="line"># 添加如下内容</span><br><span class="line"># set Oracle</span><br><span class="line">export ORACLE_SID=demo  #数据库实例ID    </span><br><span class="line">export ORACLE_BASE=/DBSoft/oracle #安装目录</span><br><span class="line">export ORACLE_HOME=$ORACLE_BASE/product/11.2.0/db_1 #oracle家目录</span><br><span class="line">export PATH=$ORACLE_HOME/bin:$PATH</span><br><span class="line"></span><br><span class="line"># 使配置生效</span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure>
<h2 id="安装oracle软件后，安装监听报错">安装oracle软件后，安装监听报错</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Oracle Net Services Configuration:</span><br><span class="line">#</span><br><span class="line"># An unexpected error has been detected by HotSpot Virtual Machine:</span><br><span class="line">#</span><br><span class="line"># SIGSEGV (0xb) at pc=0xa4bf5f4e, pid=11819, tid=3086902976</span><br><span class="line">#</span><br><span class="line"># Java VM: Java HotSpot(TM) Client VM (1.5.0_17-b02 mixed mode)</span><br><span class="line"># Problematic frame:</span><br><span class="line"># C [libclntsh.so.11.1+0x421f4e] snlinGetAddrInfo+0x1b2</span><br><span class="line">#</span><br><span class="line"># An error report file with more information is saved as hs_err_pid11819.log</span><br><span class="line">#</span><br><span class="line"># If you would like to submit a bug report, please visit:</span><br><span class="line">#   http://java.sun.com/webapps/bugreport/crash.jsp</span><br><span class="line">#</span><br><span class="line">/u01/oracle/bin/netca: line 178: 11819 Aborted                 $JRE $JRE_OPTIONS -classpath $CLASSPATH oracle.net.ca.NetCA $*</span><br></pre></td></tr></table></figure>
<p>原因是安装Centos的时候，默认主机名没有修改。对其进行修改。（安装centos时，计算机名必须修改）</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#修改hostname</span><br><span class="line">vi /etc/sysconfig/network</span><br><span class="line">HOSTNAME=dbserver</span><br><span class="line">#修改hosts文件</span><br><span class="line">vi /etc/hosts</span><br><span class="line">192.168.1.250   dbsrver localhost</span><br><span class="line">::1  localhost6 localhost6.localdomain6</span><br></pre></td></tr></table></figure>
<h2 id="安装完监听后，启动监听报错。">安装完监听后，启动监听报错。</h2><p>怀疑与安装监听时提示1521端口被占用有关</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[oracle@dbserver database]$ netstat -an | grep 1521</span><br><span class="line">[oracle@dbserver database]$ lsnrctl stat</span><br><span class="line"></span><br><span class="line">LSNRCTL for Linux: Version 11.2.0.3.0 - Production on 29-MAR-2015 15:09:14</span><br><span class="line"></span><br><span class="line">Copyright (c) 1991, 2011, Oracle.  All rights reserved.</span><br><span class="line"></span><br><span class="line">Connecting to (DESCRIPTION=(ADDRESS=(PROTOCOL=TCP)(PORT=1521)))</span><br><span class="line">TNS-12541: TNS:no listener</span><br><span class="line"> TNS-12560: TNS:protocol adapter error</span><br><span class="line">  TNS-00511: No listener</span><br><span class="line">   Linux Error: 111: Connection refused</span><br><span class="line">Connecting to (DESCRIPTION=(ADDRESS=(PROTOCOL=IPC)(KEY=EXTPROC1521)))</span><br><span class="line">TNS-12541: TNS:no listener</span><br><span class="line"> TNS-12560: TNS:protocol adapter error</span><br><span class="line">  TNS-00511: No listener</span><br><span class="line">   Linux Error: 2: No such file or directory</span><br></pre></td></tr></table></figure>
<p>原因是 $ORAACLE_HOME/network/admin/listener.ora 文件中的 host未定义。</p>
<h1 id="其他知识">其他知识</h1><h2 id="数据库名、实例名、SID、服务名、网络服务名">数据库名、实例名、SID、服务名、网络服务名</h2><p>数据库名：建数据库时候填写的global database name（<code>select name from v$database;</code>）<br>SID：建数据库时候填写的SID<br>实例名：与数据库名一致（<code>select instance_name from v$instance</code>）</p>
<h2 id="Linux_oracle数据库listener-ora存放路径">Linux oracle数据库listener.ora存放路径</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> /data/DBSoft/oracle/product/<span class="number">11.2</span>.<span class="number">0</span>/db_1/network/admin/listener.ora</span><br></pre></td></tr></table></figure>
<h2 id="Linux_oracle数据库tnsnames-ora存放路径">Linux oracle数据库tnsnames.ora存放路径</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> /data/DBSoft/oracle/product/<span class="number">11.2</span>.<span class="number">0</span>/db_1/network/admin/tnsnames.ora</span><br></pre></td></tr></table></figure>
<h2 id="ORACLE多个实例">ORACLE多个实例</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">LISTENER =</span><br><span class="line">  (DESCRIPTION_LIST =</span><br><span class="line">    (DESCRIPTION =</span><br><span class="line">      (ADDRESS = (PROTOCOL = TCP)(HOST = localhost)(PORT = <span class="number">1521</span>))</span><br><span class="line">      (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1521))</span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line">  </span><br><span class="line">#SID1、SID2即为<span class="number">2</span>个实例名称</span><br><span class="line">SID_LIST_LISTENER =</span><br><span class="line">  (SID_LIST =</span><br><span class="line">    (SID_DESC =</span><br><span class="line">      (GLOBAL_DBNAME = SID1)</span><br><span class="line">      (ORACLE_HOME = /data/DBSoft/oracle/product/<span class="number">11.2</span>.<span class="number">0</span>/db_1)</span><br><span class="line">      (SID_NAME = SID1)</span><br><span class="line">    )</span><br><span class="line">    (SID_DESC =</span><br><span class="line">      (GLOBAL_DBNAME = SID2)</span><br><span class="line">      (ORACLE_HOME = /data/DBSoft/oracle/product/<span class="number">11.2</span>.<span class="number">0</span>/db_1)</span><br><span class="line">      (SID_NAME = SID2)</span><br><span class="line">    )</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
<h2 id="ORACLE启动监听器">ORACLE启动监听器</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#切换至oracle安装用户（一般为oracle）</span><br><span class="line">su - oracle </span><br><span class="line">#启动监听器</span><br><span class="line">lsnrctl start </span><br><span class="line">#停止监听器</span><br><span class="line">lsnrctl <span class="keyword">stop</span></span><br></pre></td></tr></table></figure>
<h2 id="启动测试oracle">启动测试oracle</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[oracle@oracle ~]$ sqlplus /nolog</span><br><span class="line">SQL*Plus: Release 11.2.0.1.0 Production on Fri Jul 27 02:12:12 2012</span><br><span class="line">Copyright (c) 1982, 2009, Oracle. All rights reserved.</span><br><span class="line">#关闭数据库</span><br><span class="line">SQL&gt; shutdown</span><br><span class="line">#启动数据库</span><br><span class="line">SQL&gt; startup</span><br><span class="line">SQL&gt; quit</span><br></pre></td></tr></table></figure>
<p>测试的另一种方法：找一台windows平台电脑，telnet oracle主机IP地址：1521，通的话，会出现一个黑屏，光标一闪一闪。</p>
<h2 id="Linux开放1521端口允许网络连接Oracle_Listener">Linux开放1521端口允许网络连接Oracle Listener</h2><p>症状：<br>(1)TCP/IP连接是通的。可以用ping 命令测试。<br>(2)服务器上Oracle Listener已经启动。<br>lsnrctl status 查看listener状态<br>lsnrctl start 启动Oracle listener<br>(3)客户端得到的错误信息通常是：ORA-12170： TNS:连接超时<br>这时，我们基本可以肯定是服务器没有开放1521端口（假设你用默认设置）</p>
<p>解决方法：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#编辑iptables, 开放<span class="number">1521</span>端口：</span><br><span class="line"><span class="keyword">vi</span> /etc/sysconfig/iptables</span><br><span class="line">-A INPUT -<span class="keyword">p</span> tcp -<span class="keyword">m</span> state --state NEW -<span class="keyword">m</span> tcp --dport <span class="number">1521</span> -<span class="keyword">j</span> ACCEPT </span><br><span class="line"></span><br><span class="line">#保存配置，以便linux重启后依然有效</span><br><span class="line">service iptables save </span><br><span class="line">#重启防火墙,使规则生效</span><br><span class="line">service iptables restart</span><br><span class="line">#查看防火墙规则：</span><br><span class="line">iptables -L –<span class="keyword">n</span></span><br></pre></td></tr></table></figure>
<h2 id="linux下创建oracle用户表空间">linux下创建oracle用户表空间</h2><p>就是在已有的数据库实例上创建一个新的帐号，访问一些新的表<br>操作步骤如下：<br>(1)登录linux，以oracle用户登录（如果是root用户登录的，登录后用 su - oracle命令切换成oracle用户）<br>(2)以sysdba方式来打开sqlplus，命令如下： </p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sqlplus <span class="string">"/as sysdba"</span></span><br><span class="line">#使用sysdba打开可能会报ORA-<span class="number">12162</span>错误，因为ORACLE_SID未定义</span><br><span class="line">export ORACLE_SID=dbmaster</span><br></pre></td></tr></table></figure>
<p>(3)查看我们常规将用户表空间放置位置：执行如下</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sql：select name from <span class="keyword">v</span>$datafile;</span><br></pre></td></tr></table></figure>
<p>(4)创建用户表空间：<br>根据上步查询出的路径，新建用户表空间</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">create tablespace ts_UserName datafile</span><br><span class="line"><span class="string">'/data/dbdata/ewm/UserName_data01.dbf'</span> size <span class="number">2</span>G autoextend <span class="keyword">on</span> <span class="keyword">next</span> <span class="number">100</span>M maxsize <span class="number">31</span><span class="keyword">g</span>,</span><br><span class="line"><span class="string">'/data/dbdata/ewm/UserName_data02.dbf'</span> size <span class="number">2</span>G autoextend <span class="keyword">on</span> <span class="keyword">next</span> <span class="number">100</span>M maxsize <span class="number">31</span><span class="keyword">g</span>,</span><br><span class="line"><span class="string">'/data/dbdata/ewm/UserName_data03.dbf'</span> size <span class="number">2</span>G autoextend <span class="keyword">on</span> <span class="keyword">next</span> <span class="number">100</span>M maxsize <span class="number">31</span><span class="keyword">g</span>;</span><br></pre></td></tr></table></figure>
<p>(5)创建用户，指定密码和上边创建的用户表空间</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#注意：oracle有个毛病，密码必须以字母开头，如果以数字开头，它不会创建用户</span><br><span class="line">create user UserName identified by PassWord default tablespace ts_UserName <span class="keyword">profile</span> DEFAULT;</span><br></pre></td></tr></table></figure>
<p>(6)赋予权限</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">grant create database link <span class="keyword">to</span> UserName;</span><br><span class="line">grant create procedure <span class="keyword">to</span> UserName;</span><br><span class="line">grant create sequence <span class="keyword">to</span> UserName;</span><br><span class="line">grant create session <span class="keyword">to</span> UserName;</span><br><span class="line">grant create synonym <span class="keyword">to</span> UserName;</span><br><span class="line">grant create table <span class="keyword">to</span> UserName;</span><br><span class="line">grant create trigger <span class="keyword">to</span> UserName;</span><br><span class="line">grant create <span class="keyword">view</span> <span class="keyword">to</span> UserName;</span><br><span class="line">grant select any dictionary <span class="keyword">to</span> UserName;</span><br><span class="line">grant select any table <span class="keyword">to</span> UserName;</span><br><span class="line">grant unlimited tablespace <span class="keyword">to</span> UserName;</span><br><span class="line">grant <span class="keyword">update</span> any table <span class="keyword">to</span> UserName;</span><br><span class="line">grant <span class="keyword">debug</span> connect session <span class="keyword">to</span> UserName;</span><br><span class="line">grant dba <span class="keyword">to</span> UserName;</span><br></pre></td></tr></table></figure>
<p>—经过以上操作，我们就可以使用UserName/PassWord登录指定的实例，创建我们自己的表了</p>
<h2 id="设置Oracle自启动">设置Oracle自启动</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">su root</span><br><span class="line">vi /etc/oratab</span><br><span class="line">#将末尾的N修改为Y</span><br><span class="line">dbmaster:/data/DBSoft/oracle/product/11.2.0/db_1:Y</span><br><span class="line">#修改linux自启动文件</span><br><span class="line">vi /etc/rc.d/rc.local</span><br><span class="line">su oracle -lc "/data/DBSoft/oracle/product/11.2.0/db_1/bin/lsnrctl start"</span><br><span class="line"></span><br><span class="line">su oracle -lc "/data/DBSoft/oracle/product/11.2.0/db_1/bin/dbstart"</span><br></pre></td></tr></table></figure>
<p>参考博客：<br> <a href="http://www.blogjava.net/icewee/archive/2013/01/30/394943.html" target="_blank" rel="external">Linux 64bit下Oracle11g安装手册</a><br> <a href="http://www.cnblogs.com/mophee/archive/2013/06/01/3107137.html" target="_blank" rel="external">亦步亦趋完成在CentOS 6.4下安装Oracle 11gR2</a><br> <a href="http://www.xiyang-liu.com/2012/11/install-oracle-dbserver-with-xmanager-in-windows/" target="_blank" rel="external">使用远程X Server安装Oracle</a><br> <a href="http://www.cnblogs.com/linjiqin/category/349944.html" target="_blank" rel="external">oracle初级系列教程</a></p>
]]></content>
    <summary type="html">
    <![CDATA[<h1 id="安装前准备">安装前准备</h1><h2 id="安装依赖包">安装依赖包</h2><p>oracle 安装所需程序包,可以到安装步骤时，查看缺少什么程序就安装什么程序</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">binutils-<span class="number">2.17</span>.<span class="number">50.0</span>.<span class="number">6</span></span><br><span class="line">compat-libstdc++-<span class="number">33</span>-<span class="number">3.2</span>.<span class="number">3</span></span><br><span class="line">compat-libstdc++-<span class="number">33</span>-<span class="number">3.2</span>.<span class="number">3</span> (<span class="number">32</span> bit)</span><br><span class="line">elfutils-libelf-<span class="number">0.125</span></span><br><span class="line">elfutils-libelf-devel-<span class="number">0.125</span></span><br><span class="line">gcc-<span class="number">4.1</span>.<span class="number">2</span></span><br><span class="line">gcc-<span class="keyword">c</span>++-<span class="number">4.1</span>.<span class="number">2</span></span><br><span class="line">glibc-<span class="number">2.5</span>-<span class="number">24</span></span><br><span class="line">glibc-<span class="number">2.5</span>-<span class="number">24</span> (<span class="number">32</span> bit)</span><br><span class="line">glibc-common-<span class="number">2.5</span></span><br><span class="line">glibc-devel-<span class="number">2.5</span></span><br><span class="line">glibc-devel-<span class="number">2.5</span> (<span class="number">32</span> bit)</span><br><span class="line">glibc-headers-<span class="number">2.5</span></span><br><span class="line">ksh-<span class="number">20060214</span></span><br><span class="line">libaio-<span class="number">0.3</span>.<span class="number">106</span></span><br><span class="line">libaio-<span class="number">0.3</span>.<span class="number">106</span> (<span class="number">32</span> bit)</span><br><span class="line">libaio-devel-<span class="number">0.3</span>.<span class="number">106</span></span><br><span class="line">libaio-devel-<span class="number">0.3</span>.<span class="number">106</span> (<span class="number">32</span> bit)</span><br><span class="line">libgcc-<span class="number">4.1</span>.<span class="number">2</span></span><br><span class="line">libgcc-<span class="number">4.1</span>.<span class="number">2</span> (<span class="number">32</span> bit)</span><br><span class="line">libstdc++-<span class="number">4.1</span>.<span class="number">2</span></span><br><span class="line">libstdc++-<span class="number">4.1</span>.<span class="number">2</span> (<span class="number">32</span> bit)</span><br><span class="line">libstdc++-devel <span class="number">4.1</span>.<span class="number">2</span></span><br><span class="line"><span class="keyword">make</span>-<span class="number">3.81</span></span><br><span class="line">sysstat-<span class="number">7.0</span>.<span class="number">2</span></span><br><span class="line">unixODBC-<span class="number">2.2</span>.<span class="number">14</span>-<span class="number">11</span>.el6 (x86_64) <span class="built_in">or</span> <span class="keyword">later</span></span><br><span class="line">unixODBC-<span class="number">2.2</span>.<span class="number">14</span>-<span class="number">11</span>.el6.i686 <span class="built_in">or</span> <span class="keyword">later</span></span><br><span class="line">unixODBC-devel-<span class="number">2.2</span>.<span class="number">14</span>-<span class="number">11</span>.el6 (x86_64) <span class="built_in">or</span> <span class="keyword">later</span></span><br><span class="line">unixODBC-devel-<span class="number">2.2</span>.<span class="number">14</span>-<span class="number">11</span>.el6.i686 <span class="built_in">or</span> <span class="keyword">later</span></span><br><span class="line">libXp</span><br></pre></td></tr></table></figure>
<p>使用命令 yum install -y ‘package name’ 安装所缺的程序包，pdksh包除外</p>
<p>安装pdksh包，使用rz命令上传pdksh-5.2.14-37.el5_8.1.x86_64.rpm文件到/opt/目录下</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 注意：该程序包与ksh冲突，如果已经安装ksh，建议使用命令 rpm -<span class="keyword">e</span> ksh-* 卸载</span><br><span class="line"></span><br><span class="line">rpm -ivh pdksh-<span class="number">5.2</span>.<span class="number">14</span>-<span class="number">37</span>.el5_8.<span class="number">1</span>.x86_64.rpm</span><br></pre></td></tr></table></figure>]]>
    
    </summary>
    
      <category term="Oracle" scheme="http://www.mr-wang.cn/tags/Oracle/"/>
    
      <category term="技术" scheme="http://www.mr-wang.cn/categories/%E6%8A%80%E6%9C%AF/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[TIPS]]></title>
    <link href="http://www.mr-wang.cn/2015/07/16/Shell-Study/"/>
    <id>http://www.mr-wang.cn/2015/07/16/Shell-Study/</id>
    <published>2015-07-16T12:26:27.000Z</published>
    <updated>2016-04-01T05:03:41.000Z</updated>
    <content type="html"><![CDATA[<h2 id="OPS运维工具">OPS运维工具</h2><p><a href="http://mr-wang.qiniudn.com/Ansible-notes.pdf" target="_blank" rel="external">Ansible中文手册</a></p>
<p><a href="http://www.cnblogs.com/deerchao/archive/2006/08/24/zhengzhe30fengzhongjiaocheng.html" target="_blank" rel="external">正则表达式30分钟入门教程</a></p>
<h2 id="性能调优">性能调优</h2><p><a href="http://mr-wang.qiniudn.com/performance-optimization.pdf" target="_blank" rel="external">性能分析笔记</a></p>
<p><a href="http://www.linuxprocess.com/" target="_blank" rel="external">Linux进程</a></p>
<h2 id="运维相关">运维相关</h2><p><a href="http://mr-wang.qiniudn.com/UnixToolbox-zh_CN.html" target="_blank" rel="external">Linux Shell命令</a></p>
<p><a href="http://linux.51yip.com/" target="_blank" rel="external">Linux 命令手册</a></p>
<p><a href="http://www.gslb.cn/list.htm" target="_blank" rel="external">GSLB全局负载均衡系统是如何构建</a></p>
]]></content>
    <summary type="html">
    <![CDATA[<h2 id="OPS运维工具">OPS运维工具</h2><p><a href="http://mr-wang.qiniudn.com/Ansible-notes.pdf" target="_blank" rel="external">Ansible中文手册</a></p>
<p]]>
    </summary>
    
      <category term="Linux" scheme="http://www.mr-wang.cn/tags/Linux/"/>
    
      <category term="资源" scheme="http://www.mr-wang.cn/categories/%E8%B5%84%E6%BA%90/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Nginx+Tomcat+Memcached集群]]></title>
    <link href="http://www.mr-wang.cn/2015/07/16/Nginx-Tomcat-Memcached-Cluster/"/>
    <id>http://www.mr-wang.cn/2015/07/16/Nginx-Tomcat-Memcached-Cluster/</id>
    <published>2015-07-16T12:26:27.000Z</published>
    <updated>2016-04-01T06:25:11.311Z</updated>
    <content type="html"><![CDATA[<h2 id="部署环境">部署环境</h2><p>系统：Centos<br>软件及依赖包：<br>Nginx:<br>nginx-1.6.2.tar.gz<br>(<a href="http://nginx.org/download/nginx-1.6.2.tar.gz" target="_blank" rel="external">http://nginx.org/download/nginx-1.6.2.tar.gz</a>)<br>pcre-8.36.tar.gz (ftp://ftp.csx.cam.ac.uk/pub/software/programming/pcre/pcre-8.36.tar.gz)<br>zlib-1.2.8.tar.gz(<a href="http://zlib.net/zlib-1.2.8.tar.gz" target="_blank" rel="external">http://zlib.net/zlib-1.2.8.tar.gz</a>)</p>
<p>memcached：<br>memcached-1.4.22.tar.gz(<a href="http://memcached.org/files/memcached-1.4.22.tar.gz" target="_blank" rel="external">http://memcached.org/files/memcached-1.4.22.tar.gz</a>)<br>libevent-2.0.22-stable.tar.gz(<a href="http://libevent.org/" target="_blank" rel="external">http://libevent.org/</a>)</p>
<p>memcached-session-manager：<br><a href="http://repo1.maven.org/maven2/de/javakaffee/msm/" target="_blank" rel="external">下载地址</a></p>
<p>Tomcat：<br>apache-tomcat-7.0.59.tar.gz (<a href="http://mirrors.cnnic.cn/apache/tomcat/tomcat-7/v7.0.59/bin/apache-tomcat-7.0.59.tar.gz" target="_blank" rel="external">http://mirrors.cnnic.cn/apache/tomcat/tomcat-7/v7.0.59/bin/apache-tomcat-7.0.59.tar.gz</a>)<br>jdk-7u72-linux-x64.tar.gz</p>
<p>jar包：<br>我采用的是截止目前最新的版本，其中序列化方式是可选的。<br>序列化方式使用kryo时,jar包：<a href="http://wy-uploads.qiniudn.com/MSM_kryo.zip" target="_blank" rel="external">下载地址</a><br><img src="http://wy-uploads.qiniudn.com/MSM_1.png" alt="此处输入图片的描述"></p>
<p>序列化方式使用javolution时,jar包：<a href="http://wy-uploads.qiniudn.com/MSM_javolution.zip" target="_blank" rel="external">下载地址</a><br><img src="http://wy-uploads.qiniudn.com/MSM_2.png" alt="此处输入图片的描述"></p>
<p>了解到kryo序列化方式效率最高。</p>
<p>相关序列方式，所需不同jar包，可参考<a href="https://code.google.com/p/memcached-session-manager/wiki/SetupAndConfiguration" target="_blank" rel="external">官方文档</a></p>
<a id="more"></a>
<h2 id="Nginx安装">Nginx安装</h2><h3 id="安装gcc-c++">安装gcc-c++</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -<span class="keyword">y</span> install gcc-<span class="keyword">c</span>++</span><br></pre></td></tr></table></figure>
<h3 id="安装pcre库">安装pcre库</h3><p>pcre库是为了使nginx支持http rewrite模块</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/src/</span><br><span class="line">wget ftp://ftp.csx.cam.ac.uk/pub/software/programming/pcre/pcre-8.36.tar.gz</span><br><span class="line">tar -xzvf pcre-8.36.tar.gz</span><br><span class="line">cd pcre-8.36</span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<h3 id="安装zlib库">安装zlib库</h3><p>zlib库是为了使nginx支持gzip压缩</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/src</span><br><span class="line">wget http://zlib.net/zlib-1.2.8.tar.gz</span><br><span class="line">tar -xzvf zlib-1.2.8.tar.gz</span><br><span class="line">cd zlib-1.2.8</span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<h3 id="安装Nginx">安装Nginx</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/</span><br><span class="line">wget http://nginx.org/download/nginx-1.6.2.tar.gz</span><br><span class="line">tar -zxvf nginx-1.6.2.tar.gz</span><br><span class="line">cd nginx-1.6.2</span><br><span class="line">./configure --prefix=/usr/local/nginx --with-pcre=/usr/local/src/pcre-8.36 --with-zlib=/usr/local/src/zlib-1.2.8</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<h3 id="配置nginx-conf">配置nginx.conf</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#user  nobody;</span><br><span class="line">worker_processes  1;</span><br><span class="line"></span><br><span class="line">#error_log  logs/error.log;</span><br><span class="line">#error_log  logs/error.log  notice;</span><br><span class="line">#error_log  logs/error.log  info;</span><br><span class="line"></span><br><span class="line">#pid        logs/nginx.pid;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    #log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '</span><br><span class="line">    #                  '$status $body_bytes_sent "$http_referer" '</span><br><span class="line">    #                  '"$http_user_agent" "$http_x_forwarded_for"';</span><br><span class="line"></span><br><span class="line">    #access_log  logs/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    #tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">    #keepalive_timeout  0;</span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    gzip  on;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    #配置后端服务器群组信息</span><br><span class="line">    upstream web_server &#123;</span><br><span class="line">	server	localhost:8080;</span><br><span class="line">	server	localhost:8081;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  localhost;</span><br><span class="line"></span><br><span class="line">        charset utf-8;</span><br><span class="line"></span><br><span class="line">        #access_log  logs/host.access.log  main;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">            root              html;</span><br><span class="line">            index             index.html index.htm;</span><br><span class="line">	        #代理设置</span><br><span class="line">	        proxy_pass        http://web_server;</span><br><span class="line">	        proxy_set_header  X-Real-IP  $remote_addr;</span><br><span class="line">            client_max_body_size 100m;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        #error_page  404              /404.html;</span><br><span class="line"></span><br><span class="line">        # redirect server error pages to the static page /50x.html</span><br><span class="line">        #</span><br><span class="line">        error_page   500 502 503 504  /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="安装memcached">安装memcached</h2><p>先安装libevent-2.0.22-stable.tar.gz依赖包</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tar zxvf libevent-<span class="number">2.0</span>.<span class="number">22</span>-stable.tar.gz </span><br><span class="line"><span class="keyword">cd</span> libevent-<span class="number">2.0</span>.<span class="number">22</span>-stable </span><br><span class="line">./configure --prefix=/usr/local/libevent-<span class="number">2.0</span>.<span class="number">22</span></span><br><span class="line"><span class="keyword">make</span></span><br><span class="line"><span class="keyword">make</span> install</span><br></pre></td></tr></table></figure>
<p>再安装memcached-1.4.22.tar.gz<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">tar zxvf memcached-<span class="number">1.4</span>.<span class="number">22</span>.tar.gz </span><br><span class="line"><span class="keyword">cd</span> memcached-<span class="number">1.4</span>.<span class="number">22</span> </span><br><span class="line">./configure --prefix=/usr/local/memcached-<span class="number">1.4</span>.<span class="number">22</span> --with-libevent=/usr/local/libevent-<span class="number">2.0</span>.<span class="number">22</span>/ </span><br><span class="line"><span class="keyword">make</span> </span><br><span class="line"><span class="keyword">make</span> install</span><br><span class="line"></span><br><span class="line">#以守护进程的方式启动，监听于 <span class="number">127.0</span>.<span class="number">0.1</span> 的<span class="number">11211</span>端口，使用root用户，最大使用<span class="number">512</span>M内存，日志输出到/tmp/memcached.<span class="built_in">log</span>下</span><br><span class="line">/usr/local/memcached-<span class="number">1.4</span>.<span class="number">22</span>/bin/memcached -<span class="keyword">d</span> -<span class="keyword">m</span> <span class="number">512</span> -<span class="keyword">l</span> <span class="number">127.0</span>.<span class="number">0.1</span> -<span class="keyword">p</span> <span class="number">11211</span> -<span class="keyword">u</span> root -vv &gt;&gt; /tmp/memcached.<span class="built_in">log</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span></span><br><span class="line">#启动后，可以telnet上去看下状态</span><br><span class="line">telnet <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">11211</span></span><br><span class="line"></span><br><span class="line">stats</span><br></pre></td></tr></table></figure></p>
<h2 id="安装tomcat">安装tomcat</h2><h3 id="安装JDK_环境">安装JDK 环境</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">#查询是否安装java</span><br><span class="line">rpm -qa | grep java</span><br><span class="line">#卸载openjdk</span><br><span class="line">rpm -e java-1.6.0-openjdk-1.6.0.0-1.45.1.11.1.el6.x86_64</span><br><span class="line">rpm -e tzdata-java-2012c-1.el6.noarch</span><br><span class="line"></span><br><span class="line">#安装java</span><br><span class="line">mkdir /usr/java</span><br><span class="line">cd /usr/java</span><br><span class="line">wget http://.../jdk-7u72-linux-x64.tar.gz</span><br><span class="line">tar -xzvf jdk-7u72-linux-x64.tar.gz</span><br><span class="line"></span><br><span class="line">#修改系统环境变量文件</span><br><span class="line">vi /etc/profile</span><br><span class="line"></span><br><span class="line">#添加如下内容</span><br><span class="line">#Set java JDK</span><br><span class="line">JAVA_HOME=/usr/local/jdk1.7.0_72</span><br><span class="line">JRE_HOME=/usr/local/jdk1.7.0_72/jre</span><br><span class="line">PATH=$PATH:$JAVA_HOME/bin:$JRE_home/bin</span><br><span class="line">CLASSPATH=$JAVA_HOME/lib/tools.jar:$JAVA_HOME/lib/dt.jar</span><br><span class="line">export JAVA_HOME</span><br><span class="line">export JRE_HOME</span><br><span class="line">export PATH</span><br><span class="line">export CLASSPATH</span><br><span class="line"></span><br><span class="line">#使修改马上生效</span><br><span class="line">source /etc/profile</span><br><span class="line"></span><br><span class="line">#验证是否安装成功</span><br><span class="line">java -version</span><br></pre></td></tr></table></figure>
<h3 id="安装Tomcat应用服务器">安装Tomcat应用服务器</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local</span><br><span class="line">wget http://.../apache-tomcat-7.0.56.tar.gz</span><br><span class="line">tar -xzvf apache-tomcat-7.0.56.tar.gz</span><br><span class="line">mv apache-tomcat-7.0.56 tomcat1</span><br><span class="line">cp -R tomcat1 tomcat2</span><br></pre></td></tr></table></figure>
<h3 id="配置Tomact的server-conf">配置Tomact的server.conf</h3><p>8080端口实例的tomcat1配置：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;Server port=<span class="string">"8005"</span> shutdown=<span class="string">"SHUTDOWN"</span>&gt;</span><br><span class="line">&lt;Connector port=<span class="string">"8080"</span> protocol=<span class="string">"HTTP/1.1"</span> connectionTimeout=<span class="string">"20000"</span> redirectPort=<span class="string">"8443"</span> /&gt;</span><br><span class="line">&lt;Connector port=<span class="string">"8009"</span> protocol=<span class="string">"AJP/1.3"</span> redirectPort=<span class="string">"8443"</span> /&gt;</span><br><span class="line"></span><br><span class="line">&lt;Engine name=<span class="string">"Catalina"</span> defaultHost=<span class="string">"localhost"</span> jvmRoute=<span class="string">"tomcat1"</span>&gt;</span><br><span class="line">...</span><br><span class="line">&lt;Context path=<span class="string">""</span> docBase=<span class="string">"/home/imcc/web"</span> <span class="keyword">debug</span>=<span class="string">"0"</span> reloadable=<span class="string">"true"</span> crossContext=<span class="string">"true"</span>&gt;    </span><br><span class="line">	&lt;Manager </span><br><span class="line">	  className=<span class="string">"de.javakaffee.web.msm.MemcachedBackupSessionManager"</span></span><br><span class="line">      memcachedNodes=<span class="string">"n1:localhost:11211"</span></span><br><span class="line">	  requestUriIgnorePattern=<span class="string">".*\.(png|gif|jpg|css|js|ico|jpeg|htm|html)$"</span></span><br><span class="line">	  sessionBackupAsync=<span class="string">"false"</span></span><br><span class="line">	  sessionBackupTimeout=<span class="string">"100"</span></span><br><span class="line">	  copyCollectionsForSerialization=<span class="string">"false"</span></span><br><span class="line">	  transcoderFactoryClass=<span class="string">"de.javakaffee.web.msm.serializer.kryo.KryoTranscoderFactory"</span> /&gt;</span><br><span class="line">&lt;/Context&gt;</span><br></pre></td></tr></table></figure>
<p>8081端口实例的tomcat1配置：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;Server port=<span class="string">"8006"</span> shutdown=<span class="string">"SHUTDOWN"</span>&gt;</span><br><span class="line">&lt;Connector port=<span class="string">"8081"</span> protocol=<span class="string">"HTTP/1.1"</span> connectionTimeout=<span class="string">"20000"</span> redirectPort=<span class="string">"8443"</span> /&gt;</span><br><span class="line">&lt;Connector port=<span class="string">"9009"</span> protocol=<span class="string">"AJP/1.3"</span> redirectPort=<span class="string">"8443"</span> /&gt;</span><br><span class="line"></span><br><span class="line">&lt;Engine name=<span class="string">"Catalina"</span> defaultHost=<span class="string">"localhost"</span> jvmRoute=<span class="string">"tomcat2"</span>&gt;</span><br><span class="line">...</span><br><span class="line">&lt;Context path=<span class="string">""</span> docBase=<span class="string">"/home/imcc/web"</span> <span class="keyword">debug</span>=<span class="string">"0"</span> reloadable=<span class="string">"true"</span> crossContext=<span class="string">"true"</span>&gt;    </span><br><span class="line">	&lt;Manager </span><br><span class="line">	  className=<span class="string">"de.javakaffee.web.msm.MemcachedBackupSessionManager"</span></span><br><span class="line">      memcachedNodes=<span class="string">"n1:localhost:11211"</span></span><br><span class="line">	  requestUriIgnorePattern=<span class="string">".*\.(png|gif|jpg|css|js|ico|jpeg|htm|html)$"</span></span><br><span class="line">	  sessionBackupAsync=<span class="string">"false"</span></span><br><span class="line">	  sessionBackupTimeout=<span class="string">"100"</span></span><br><span class="line">	  copyCollectionsForSerialization=<span class="string">"false"</span></span><br><span class="line">	  transcoderFactoryClass=<span class="string">"de.javakaffee.web.msm.serializer.kryo.KryoTranscoderFactory"</span> /&gt;</span><br><span class="line">&lt;/Context&gt;</span><br></pre></td></tr></table></figure>
<p>备注：</p>
<p>Manager标签属性说明:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">className  必须</span><br><span class="line">类名：de.javakaffee.web.msm.MemcachedBackupSessionManager</span><br><span class="line"></span><br><span class="line">memcachedNodes  必须</span><br><span class="line">memcached节点：此属性应该包含所有运行的memcached节点或者membase bucket的uri地址，每一个memcached节点的属性定义格式为&lt;id&gt;:&lt;host&gt;:&lt;port&gt;，多个节点定义直接使用空格或者逗号分隔，形如：memcachedNodes="n1:app01:11211,n2:app02:11211"，如果只有单个的memcached节点，则&lt;id&gt;是可选项，只需配置&lt;host&gt;:&lt;port&gt;即可，形如：memcachedNodes="localhost:11211"。</span><br><span class="line">如果我们配置的是membase，那么从1.6.0版本开始，我们可以配置指定一个或者多个membase bucket uris，形如：http://host1:8091/pools,http://host2:8091/pools。Bucket 名称和密码通过属性username,password来定义。membase buckets连接需要遵循memcached协议，传输数据通过二进制流方式。</span><br><span class="line"></span><br><span class="line">failoverNodes 可选项</span><br><span class="line">故障转移节点：可选项，对非黏性session不可用，属性必须包含memcached节点集群的所有ids。节点id之间用空格或者逗号分隔。</span><br><span class="line"></span><br><span class="line">username 可选项</span><br><span class="line">从1.6.0版开始使用，并且是可选的。用来进行membase bucket或者SASL验证，密码可以为空。</span><br><span class="line"></span><br><span class="line">password 可选项</span><br><span class="line">从1.6.0版开始使用，并且是可选的。用来进行membase bucket或者SASL验证，密码可以为空。</span><br><span class="line"></span><br><span class="line">memcachedProtocol    可选项</span><br><span class="line">定义memcached协议，默认使用text文本，出属性指明memcached使用的存储协议。只支持text或者binary。</span><br><span class="line"></span><br><span class="line">sticky    可选项</span><br><span class="line">定义session方式为黏性或非黏性，默认为true，多个tomcat时需使用非黏性</span><br><span class="line"></span><br><span class="line">lockingMode    可选项</span><br><span class="line">只有非黏性session才使用，默认值为none</span><br><span class="line">none: 从不对session进行锁定</span><br><span class="line">all: session将一直被锁定，直到请求结束</span><br><span class="line">auto: 对于只读请求，session将不会被锁定，如果是非只读请求，则session会被锁定</span><br><span class="line">uriPattern:&lt;regexp&gt;: 通过正则表达式的方式来对请求uri以及查询字符串进行匹配，只有匹配上的才会被锁定。</span><br><span class="line"></span><br><span class="line">requestUriIgnorePattern   可选项</span><br><span class="line">此属性是那些不能改备份Session的请求的正则表达式。如果像css,javascript,图片等静态文件被同一个Tomcat和同一个应用上下文来提供，这些请求也会通过memcached-session-manager。但是这些请求在一个http会话中几乎没什么改变，所以他们没必要触发Session备份。所以那些静态文件没必要触发Session备份，你就可以使用此属性定义。此属性必须符合java regex正则规范。</span><br><span class="line">    如：".*\.(png|gif|jpg|css|js)$" </span><br><span class="line"></span><br><span class="line">sessionBackupAsync   可选项</span><br><span class="line">指定Session是否应该被异步保存到Memcached中。 如果被设置为true，backupThreadCount设置起作用，如果设置false，通过sessionBackupTimeout设置的过期时间起作用。</span><br><span class="line"></span><br><span class="line">backupThreadCount    可选项</span><br><span class="line">用来异步保存Session的线程数，(如果sessionBackupAsync="true")。默认值为cup的内核数。</span><br><span class="line"></span><br><span class="line">sessionBackupTimeout    可选项</span><br><span class="line">设置备份一个Session所用的时间，如果操作超过时间那么保存失败。此属性只sessionBackupAsync="false"是起作用。默认100毫秒</span><br><span class="line"></span><br><span class="line">operationTimeout    可选项</span><br><span class="line">从1.6.0版开始使用， 默认值为1000</span><br><span class="line"></span><br><span class="line">sessionAttributeFilter    可选项</span><br><span class="line">此属性是用来控制Session中的那个属性值保存到Memcached中的正则表达式。正则表达式被用来匹配Session中属性名称。如sessionAttributeFilter="^(userName|sessionHistory)$" 指定了只有"userName"和"sessionHistory"属性保存到Memcached中。依赖于选择的序列化策略。</span><br><span class="line"></span><br><span class="line">transcoderFactoryClass    可选项</span><br><span class="line">此属性值是创建序列化和反序列化保存到Memcached中的Session的编码转换器的工厂类名。这个指定的类必须实现了de.javakaffee.web.msm.TranscoderFactory和提供一个无参的构造方法。例如其他的有效的实现在其他packages/jars中提供如：msm-kryo-serializer,msm-xstrea-serializer和msm-javolution-serializer.</span><br><span class="line">默认为 de.javakaffee.web.msm.JavaSerializationTranscoderFactory</span><br><span class="line"></span><br><span class="line">copyCollectionsForSerialization    可选项</span><br><span class="line">默认值为false。</span><br><span class="line"></span><br><span class="line">customConverter    可选项</span><br><span class="line">自己定义特殊的类注册到kryo自定义转换器中，实现序列化</span><br><span class="line"></span><br><span class="line">enableStatistics    可选项</span><br><span class="line">用来指定是否进行统计。 默认值为true。</span><br><span class="line"></span><br><span class="line">enabled   可选项</span><br><span class="line">指定Session保存到Memcached中是否可用和是否可以通过JMX进行改变。只用于粘性Session。 默认值为true。</span><br></pre></td></tr></table></figure>
<p>添加memcached-session-manager的依赖包到$TOMCATHOME/lib目录下</p>
<h2 id="测试">测试</h2><p>添加测试页面<code>/home/imcc/web/index.jsp</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SessionID:&lt;%=session.getId()%&gt;  </span><br><span class="line">&lt;BR&gt;  </span><br><span class="line">SessionIP:&lt;%=request.getServerName()%&gt;  </span><br><span class="line">&lt;BR&gt;  </span><br><span class="line">SessionPort:&lt;%=request.getServerPort()%&gt;  </span><br><span class="line">&lt;%  </span><br><span class="line">out.println("This is Tomcat Server!");  </span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>
<p>通过浏览器访问,并刷新:<br><img src="http://wy-uploads.qiniudn.com/MSM_3.png" alt="此处输入图片的描述"><br><img src="http://wy-uploads.qiniudn.com/MSM_4.png" alt="此处输入图片的描述"></p>
<p>查看memcached日志：<br><img src="http://wy-uploads.qiniudn.com/MSM_5.png" alt="此处输入图片的描述"><br>通过观察SessionID没有发生变化，证明session共享成功。</p>
<p>参考：<br><a href="http://www.iteye.com/topic/1125301" target="_blank" rel="external">MSM—Memcached_Session_Manager介绍及使用</a><br><a href="http://blog.csdn.net/wh0426/article/details/44699449" target="_blank" rel="external">交易系统架构之会话篇：tomcat msm部署</a><br><a href="http://blog.csdn.net/shimiso/article/details/8979044" target="_blank" rel="external">Nginx+Tomcat+Memcached集群Session共享</a><br><a href="http://passover.blog.51cto.com/2431658/648182" target="_blank" rel="external">利用nginx+tomcat+memcached组建web服务器负载均衡</a><br><a href="http://www.cnblogs.com/phirothing/archive/2013/12/05/3459814.html" target="_blank" rel="external">Nginx+Tomcat+Memcached集群</a></p>
]]></content>
    <summary type="html">
    <![CDATA[<h2 id="部署环境">部署环境</h2><p>系统：Centos<br>软件及依赖包：<br>Nginx:<br>nginx-1.6.2.tar.gz<br>(<a href="http://nginx.org/download/nginx-1.6.2.tar.gz">http://nginx.org/download/nginx-1.6.2.tar.gz</a>)<br>pcre-8.36.tar.gz (ftp://ftp.csx.cam.ac.uk/pub/software/programming/pcre/pcre-8.36.tar.gz)<br>zlib-1.2.8.tar.gz(<a href="http://zlib.net/zlib-1.2.8.tar.gz">http://zlib.net/zlib-1.2.8.tar.gz</a>)</p>
<p>memcached：<br>memcached-1.4.22.tar.gz(<a href="http://memcached.org/files/memcached-1.4.22.tar.gz">http://memcached.org/files/memcached-1.4.22.tar.gz</a>)<br>libevent-2.0.22-stable.tar.gz(<a href="http://libevent.org/">http://libevent.org/</a>)</p>
<p>memcached-session-manager：<br><a href="http://repo1.maven.org/maven2/de/javakaffee/msm/">下载地址</a></p>
<p>Tomcat：<br>apache-tomcat-7.0.59.tar.gz (<a href="http://mirrors.cnnic.cn/apache/tomcat/tomcat-7/v7.0.59/bin/apache-tomcat-7.0.59.tar.gz">http://mirrors.cnnic.cn/apache/tomcat/tomcat-7/v7.0.59/bin/apache-tomcat-7.0.59.tar.gz</a>)<br>jdk-7u72-linux-x64.tar.gz</p>
<p>jar包：<br>我采用的是截止目前最新的版本，其中序列化方式是可选的。<br>序列化方式使用kryo时,jar包：<a href="http://wy-uploads.qiniudn.com/MSM_kryo.zip">下载地址</a><br><img src="http://wy-uploads.qiniudn.com/MSM_1.png" alt="此处输入图片的描述"></p>
<p>序列化方式使用javolution时,jar包：<a href="http://wy-uploads.qiniudn.com/MSM_javolution.zip">下载地址</a><br><img src="http://wy-uploads.qiniudn.com/MSM_2.png" alt="此处输入图片的描述"></p>
<p>了解到kryo序列化方式效率最高。</p>
<p>相关序列方式，所需不同jar包，可参考<a href="https://code.google.com/p/memcached-session-manager/wiki/SetupAndConfiguration">官方文档</a></p>]]>
    
    </summary>
    
      <category term="集群" scheme="http://www.mr-wang.cn/tags/%E9%9B%86%E7%BE%A4/"/>
    
      <category term="技术" scheme="http://www.mr-wang.cn/categories/%E6%8A%80%E6%9C%AF/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[linux的运行级别及自启动程序]]></title>
    <link href="http://www.mr-wang.cn/2015/07/16/Linux-Boot-Sequence/"/>
    <id>http://www.mr-wang.cn/2015/07/16/Linux-Boot-Sequence/</id>
    <published>2015-07-16T12:26:27.000Z</published>
    <updated>2016-04-01T06:23:23.654Z</updated>
    <content type="html"><![CDATA[<h2 id="Linux运行级别：">Linux运行级别：</h2><p>Linux运行级别有七种：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span> - 停机（千万不能把initdefault 设置为<span class="number">0</span> ）</span><br><span class="line"><span class="number">1</span> - 单用户模式</span><br><span class="line"><span class="number">2</span> - 多用户，没有 NFS</span><br><span class="line"><span class="number">3</span> - 完全多用户模式(标准的运行级)</span><br><span class="line"><span class="number">4</span> - 没有用到</span><br><span class="line"><span class="number">5</span> - X11 （xwindow)</span><br><span class="line"><span class="number">6</span> - 重新启动 （千万不要把initdefault 设置为<span class="number">6</span> ）</span><br></pre></td></tr></table></figure>
<p>默认的运行级别在/etc/inittab文件中进行设置。</p>
<a id="more"></a>
<h2 id="加载开机启动程序">加载开机启动程序</h2><p>Linux系统启动确定运行级别后，加载运行级别下的自启动程序。</p>
<p>那么不同运行级别的，自启动程序不同，对应的启动程序目录也不同。如果需要查看3级别用户的启动程序，可以通过/etc/rc3.d 目录来查看。</p>
<p>目录名中的”rc”，表示run command（运行程序），最后的d表示directory（目录）。<br>下面让我们看看 /etc/rc3.d, 目录中到底指定了哪些程序</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@dbserver etc]# <span class="keyword">ls</span> /etc/rc3.<span class="keyword">d</span>/</span><br><span class="line">K01numad K01smartd K02oddjobd</span><br><span class="line">S01sysstat S02lvm2-monitor S08iptables</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>从目录名，我们可以看出，目录均是以“字母K或S+2位数字+程序名”的形式。<br>字母K表示：kill，从其他运行级别切换到这一级别时，需要关闭的程序。<br>字母S表示：start，需要启动的程序。<br>数字表示：表示处理顺序，数字越小，处理得越早。数字相同时，按照程序首字母顺序启动。</p>
<p>前面提到，不同运行级别的，自启动程序不同，对应的启动程序目录也不同。不难想到，如果多个”运行级别”需要启动同一个程序，那么这个程序的启动脚本，就会在每一个目录里都有一个拷贝。</p>
<p>这样会造成管理上的困扰：如果要修改启动脚本，岂不是每个目录都要改一遍？</p>
<p>Linux的解决办法，就是七个 /etc/rcN.d 目录里列出的程序，都设为链接文件，指向另外一个目录 /etc/init.d ，真正的启动脚本都统一放在这个目录中。init进程逐一加载开机启动程序，其实就是运行这个目录里的启动脚本。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@dbserver rc3.d]# ll /etc/rc3.d/</span><br><span class="line">总用量 0</span><br><span class="line">lrwxrwxrwx. 1 root root 15 3月  25 17:30 K01numad -&gt; ../init.d/numad</span><br><span class="line">lrwxrwxrwx. 1 root root 16 3月  25 17:30 K01smartd -&gt; ../init.d/smartd</span><br><span class="line">lrwxrwxrwx. 1 root root 17 3月  25 17:27 K02oddjobd -&gt; ../init.d/oddjobd</span><br><span class="line">lrwxrwxrwx. 1 root root 16 3月  25 17:31 K10psacct -&gt; ../init.d/psacct</span><br><span class="line">lrwxrwxrwx. 1 root root 19 3月  25 17:27 K10saslauthd -&gt; ../init.d/saslauthd</span><br><span class="line">lrwxrwxrwx. 1 root root 20 3月  25 17:25 K50netconsole -&gt; ../init.d/netconsole</span><br><span class="line">lrwxrwxrwx. 1 root root 13 3月  25 17:26 K60nfs -&gt; ../init.d/nfs</span><br></pre></td></tr></table></figure>
<p>再看看链接指向的init.d文件，发现还是一个链接文件。所以最终的脚本文件在/etc/rc.d/init.d</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@dbserver etc]# ll /etc/init.d</span><br><span class="line">lrwxrwxrwx. 1 root root 11 3月  25 17:15 init.d -&gt; rc.d/init.d</span><br></pre></td></tr></table></figure>
<p>链接文件目录：/etc/rcN.d<br>程序脚本文件目录：/etc/rc.d/init.d<br>用户自定义脚本：/etc/rc.d/init.d/rc.local</p>
<h2 id="Shell配置文件">Shell配置文件</h2><p>Shell的配置文件有如下五个：<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/etc/<span class="keyword">profile</span></span><br><span class="line">/etc/bashrc</span><br><span class="line">~/.bash_profile</span><br><span class="line">~/.bash_loginout</span><br><span class="line">~/.bashrc</span><br></pre></td></tr></table></figure></p>
<p>他们之间的区别：<br><code>/etc/profile</code> 这是对所有用户都有效的配置，文件修改后，需要source生效重启；<br><code>~/.bash_profile</code> 这是对当前用户有效的配置，文件修改后，需要source生效或重启；<br><code>/etc/bashrc</code> 桌面状态下，打开一个不需要登陆的Shell时调用，对所有用户都有效，文件修改后，重新打开一个Shell就生效；<br><code>~/.bashrc</code> 桌面状态下，打开一个不需要登陆的Shell时调用，对当前用户有效，文件修改后，重新打开一个Shell就生效；<br><code>~/.bash_loginout</code> 当每次退出系统(退出bash shell)时,执行该文件。</p>
<p>参考<br><a href="http://blog.csdn.net/firedb/article/details/8205136" target="_blank" rel="external">linux /etc/rc.d/init.d自启动程序说明</a><br><a href="http://www.ruanyifeng.com/blog/2013/08/linux_boot_process.html" target="_blank" rel="external">Linux系统的启动流程</a><br><a href="http://blog.csdn.net/lxlj2006/article/details/5828705" target="_blank" rel="external">系统运行级别(/etc/inittab)</a></p>
]]></content>
    <summary type="html">
    <![CDATA[<h2 id="Linux运行级别：">Linux运行级别：</h2><p>Linux运行级别有七种：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span> - 停机（千万不能把initdefault 设置为<span class="number">0</span> ）</span><br><span class="line"><span class="number">1</span> - 单用户模式</span><br><span class="line"><span class="number">2</span> - 多用户，没有 NFS</span><br><span class="line"><span class="number">3</span> - 完全多用户模式(标准的运行级)</span><br><span class="line"><span class="number">4</span> - 没有用到</span><br><span class="line"><span class="number">5</span> - X11 （xwindow)</span><br><span class="line"><span class="number">6</span> - 重新启动 （千万不要把initdefault 设置为<span class="number">6</span> ）</span><br></pre></td></tr></table></figure>
<p>默认的运行级别在/etc/inittab文件中进行设置。</p>]]>
    
    </summary>
    
      <category term="Linux" scheme="http://www.mr-wang.cn/tags/Linux/"/>
    
      <category term="技术" scheme="http://www.mr-wang.cn/categories/%E6%8A%80%E6%9C%AF/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Vsftpd安装配置]]></title>
    <link href="http://www.mr-wang.cn/2015/07/16/Install-Vsftpd/"/>
    <id>http://www.mr-wang.cn/2015/07/16/Install-Vsftpd/</id>
    <published>2015-07-16T12:26:27.000Z</published>
    <updated>2016-04-01T06:22:44.030Z</updated>
    <content type="html"><![CDATA[<p>安装vsftp</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -<span class="keyword">y</span> vsftpd</span><br></pre></td></tr></table></figure>
<p>将vsftpd加入系统自启动，并启动服务</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">service vsftpd start</span><br><span class="line">chkconfig --level <span class="number">3</span> vsftpd <span class="keyword">on</span></span><br></pre></td></tr></table></figure>
<a id="more"></a> 
<p>配置文件：</p>
<p>/etc/vsftpd/vsftpd.conf   //主配置文件<br>/etc/vsftpd/ftpusers //被禁止登录FTP的用户文件<br>/etc/vsftpd/user_list    //允许登录FTP的用户文件<br>/etc/vsftpd/userconfig   //用户目录配置文件</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line">#匿名账号是否允许登陆</span><br><span class="line">#anonymous_enable=YES</span><br><span class="line"> </span><br><span class="line">#设定本地用户可以访问。注：如使用虚拟宿主用户，在该项目设定为NO的情况下所有虚拟用户将无法访问。</span><br><span class="line">local_enable=YES</span><br><span class="line"> </span><br><span class="line">#使用户不能离开主目录</span><br><span class="line">#chroot_local_user=YES</span><br><span class="line"> </span><br><span class="line">#是否可以写入</span><br><span class="line">write_enable=YES</span><br><span class="line"> </span><br><span class="line"># Default umask for local users is 077. You may wish to change this to 022,</span><br><span class="line"># if your users expect that (022 is used by most other ftpd's)</span><br><span class="line">#设定上传后文件的权限掩码</span><br><span class="line">local_umask=022</span><br><span class="line">#</span><br><span class="line"># Uncomment this to allow the anonymous FTP user to upload files. This only</span><br><span class="line"># has an effect if the above global write enable is activated. Also, you will</span><br><span class="line"># obviously need to create a directory writable by the FTP user.</span><br><span class="line">#匿名用户是否可以上传</span><br><span class="line">#anon_upload_enable=YES</span><br><span class="line">anon_upload_enable=NO</span><br><span class="line">#</span><br><span class="line"># Uncomment this if you want the anonymous FTP user to be able to create</span><br><span class="line"># new directories.</span><br><span class="line">#匿名用户是否可以建立目录</span><br><span class="line">#anon_mkdir_write_enable=YES</span><br><span class="line">anon_mkdir_write_enable=NO</span><br><span class="line">#</span><br><span class="line"># Activate directory messages - messages given to remote users when they</span><br><span class="line"># go into a certain directory.</span><br><span class="line">#进入每个目录是否显示欢迎信息，在每个目录下建立.message文件在里面写欢迎信息</span><br><span class="line">dirmessage_enable=YES</span><br><span class="line">#</span><br><span class="line"># The target log file can be vsftpd_log_file or xferlog_file.</span><br><span class="line"># This depends on setting xferlog_std_format parameter</span><br><span class="line">#上传/下载文件时是否记录日志</span><br><span class="line">xferlog_enable=YES</span><br><span class="line">#</span><br><span class="line"># Make sure PORT transfer connections originate from port 20 (ftp-data).</span><br><span class="line">#是否使用port主动模式</span><br><span class="line">port_enable=YES</span><br><span class="line">#是否使用20端口传输数据</span><br><span class="line">connect_from_port_20=YES</span><br><span class="line">#不使用20端口时，指定port模式的端口号</span><br><span class="line">#ftp_data_port=2020</span><br><span class="line">#是否使用安全的port模式</span><br><span class="line">port_promiscuous=NO</span><br><span class="line">#</span><br><span class="line"># If you want, you can arrange for uploaded anonymous files to be owned by</span><br><span class="line"># a different user. Note! Using "root" for uploaded files is not</span><br><span class="line"># recommended!</span><br><span class="line">#匿名用户上传文件是否更改宿主</span><br><span class="line">#chown_uploads=YES</span><br><span class="line">#匿名用户上传文件宿主更改为谁</span><br><span class="line">#chown_username=whoever</span><br><span class="line">#</span><br><span class="line"># The name of log file when xferlog_enable=YES and xferlog_std_format=YES</span><br><span class="line"># WARNING - changing this filename affects /etc/logrotate.d/vsftpd.log</span><br><span class="line">#设定Vsftpd的服务日志保存路径，需手动创建该文件并有写入权限</span><br><span class="line">xferlog_file=/var/log/xferlog</span><br><span class="line">#</span><br><span class="line"># Switches between logging into vsftpd_log_file and xferlog_file files.</span><br><span class="line"># NO writes to vsftpd_log_file, YES to xferlog_file</span><br><span class="line">#设定日志使用标准的记录格式</span><br><span class="line">xferlog_std_format=YES</span><br><span class="line">#</span><br><span class="line"># You may change the default value for timing out an idle session.</span><br><span class="line">#设定空闲连接超时时间，如果不指定的话，还是使用这里的默认值600，单位秒</span><br><span class="line">#idle_session_timeout=600</span><br><span class="line">#</span><br><span class="line"># You may change the default value for timing out a data connection.</span><br><span class="line">#设定单次最大连续传输时间，如果不指定的话，还是使用这里的默认值120，单位秒</span><br><span class="line">#data_connection_timeout=120</span><br><span class="line">#</span><br><span class="line"># It is recommended that you define on your system a unique user which the</span><br><span class="line"># ftp server can use as a totally isolated and unprivileged user.</span><br><span class="line">#设定支撑Vsftpd服务的宿主用户</span><br><span class="line">#nopriv_user=ftpsecure</span><br><span class="line">#</span><br><span class="line"># Enable this and the server will recognise asynchronous ABOR requests. Not</span><br><span class="line"># recommended for security (the code is non-trivial). Not enabling it,</span><br><span class="line"># however, may confuse older FTP clients.</span><br><span class="line">#设定是否支持异步传输功能</span><br><span class="line">#async_abor_enable=YES</span><br><span class="line">#</span><br><span class="line"># By default the server will pretend to allow ASCII mode but in fact ignore</span><br><span class="line"># the request. Turn on the below options to have the server actually do ASCII</span><br><span class="line"># mangling on files when in ASCII mode.</span><br><span class="line"># Beware that on some FTP servers, ASCII support allows a denial of service</span><br><span class="line"># attack (DoS) via the command "SIZE /big/file" in ASCII mode. vsftpd</span><br><span class="line"># predicted this attack and has always been safe, reporting the size of the</span><br><span class="line"># raw file.</span><br><span class="line"># ASCII mangling is a horrible feature of the protocol.</span><br><span class="line">#设定支持ASCII模式的上传和下载功能</span><br><span class="line">ascii_upload_enable=YES</span><br><span class="line">ascii_download_enable=YES</span><br><span class="line"> </span><br><span class="line"># You may fully customise the login banner string:</span><br><span class="line">#设定Vsftpd的登陆标语</span><br><span class="line">#ftpd_banner=Welcome to blah FTP service.</span><br><span class="line">#</span><br><span class="line"># You may specify a file of disallowed anonymous e-mail addresses. Apparently</span><br><span class="line"># useful for combatting certain DoS attacks.</span><br><span class="line">#deny_email_enable=YES</span><br><span class="line"># (default follows)</span><br><span class="line">#banned_email_file=/etc/vsftpd/banned_emails</span><br><span class="line">#</span><br><span class="line"># You may specify an explicit list of local users to chroot() to their home</span><br><span class="line"># directory. If chroot_local_user is YES, then this list becomes a list of</span><br><span class="line"># users to NOT chroot().</span><br><span class="line">#是否限制所有的本地用户在自家目录</span><br><span class="line">#chroot_local_user=YES</span><br><span class="line">#是否允许chroot_list中用户登出自己的FTP主目录</span><br><span class="line">#chroot_list_enable=YES</span><br><span class="line"># (default follows)</span><br><span class="line">#配置chroot_list文件路径</span><br><span class="line">#chroot_list_file=/etc/vsftpd/chroot_list</span><br><span class="line">#</span><br><span class="line"># You may activate the "-R" option to the builtin ls. This is disabled by</span><br><span class="line"># default to avoid remote users being able to cause excessive I/O on large</span><br><span class="line"># sites. However, some broken FTP clients such as "ncftp" and "mirror" assume</span><br><span class="line"># the presence of the "-R" option, so there is a strong case for enabling it.</span><br><span class="line">#是否允许使用ls -R命令，该命令会对服务器性能造成巨大开销</span><br><span class="line">#ls_recurse_enable=YES</span><br><span class="line">#</span><br><span class="line"># When "listen" directive is enabled, vsftpd runs in standalone mode and</span><br><span class="line"># listens on IPv4 sockets. This directive cannot be used in conjunction</span><br><span class="line"># with the listen_ipv6 directive.</span><br><span class="line">#开启ipv4监听</span><br><span class="line">listen=YES</span><br><span class="line">#设定ipv4监听端口</span><br><span class="line">listen_port=2121</span><br><span class="line">#</span><br><span class="line"># This directive enables listening on IPv6 sockets. To listen on IPv4 and IPv6</span><br><span class="line"># sockets, you must run two copies of vsftpd with two configuration files.</span><br><span class="line"># Make sure, that one of the listen options is commented !!</span><br><span class="line">#开启ipv6监听</span><br><span class="line">#listen_ipv6=YES</span><br><span class="line"> </span><br><span class="line">#使用pam模块控制，vsftpd文件在/etc/pam.d目录下</span><br><span class="line">pam_service_name=vsftpd</span><br><span class="line"> </span><br><span class="line">#userlist_enable、userlist_deny配合使用，userlist_enable选项被激活后，vsftpd将读取userlist_file参数所指定的文件中的用户列表，而userlist_deny选项定义list中用户是否被禁止登陆。当列表中的用户登录FTP服务器时，该用户在提示输入密码之前就被禁止了。即该用户名输入后，vsftpd查到该用户名在列表中，vsftpd就直接禁止掉该用户，不会再进行询问密码等后续步聚</span><br><span class="line">#userlist_enable=YES</span><br><span class="line">#userlist_file=/etc/vsftpd/vsftpd.user_list</span><br><span class="line">#userlist_deny=YES</span><br><span class="line"> </span><br><span class="line">#是否允许tcp_wrappers管理</span><br><span class="line">tcp_wrappers=YES</span><br><span class="line"> </span><br><span class="line">#所有用户的根目录，，对匿名用户无效</span><br><span class="line">#local_root=/home/ftp</span><br><span class="line"> </span><br><span class="line">#匿名用户的最大传输速度，单位是Byts/s</span><br><span class="line">#anon_max_rate=1024000</span><br><span class="line"> </span><br><span class="line">#本地用户的最大传输速度，单位是Byts/s</span><br><span class="line">#local_max_rate=1024000</span><br><span class="line"> </span><br><span class="line">#是否使用pasv被动模式</span><br><span class="line">pasv_enable=YES</span><br><span class="line">#指定被动模式的最小、最大端口</span><br><span class="line">pasv_min_port=2123</span><br><span class="line">pasv_max_port=2125</span><br><span class="line">#是否屏蔽对pasv进行安全检查</span><br><span class="line">pasv_promiscuous=NO</span><br><span class="line">#被动模式是否用设置好的的地址返回给客户端</span><br><span class="line">#pasv_addr_resolve=YES</span><br><span class="line">#服务器传回的ip地址，让客户端知道</span><br><span class="line">#pasv_address=101.71.51.65</span><br></pre></td></tr></table></figure>
<p><a href="http://heylinux.com/archives/356.html" target="_blank" rel="external">基于本地用户的Vsftp配置</a><br><a href="http://heylinux.com/archives/713.html" target="_blank" rel="external">Vsftp服务器配置详解</a></p>
]]></content>
    <summary type="html">
    <![CDATA[<p>安装vsftp</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -<span class="keyword">y</span> vsftpd</span><br></pre></td></tr></table></figure>
<p>将vsftpd加入系统自启动，并启动服务</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">service vsftpd start</span><br><span class="line">chkconfig --level <span class="number">3</span> vsftpd <span class="keyword">on</span></span><br></pre></td></tr></table></figure>]]>
    
    </summary>
    
      <category term="vsftp,ftp" scheme="http://www.mr-wang.cn/tags/vsftp-ftp/"/>
    
      <category term="技术" scheme="http://www.mr-wang.cn/categories/%E6%8A%80%E6%9C%AF/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[CentOS下nginx安装]]></title>
    <link href="http://www.mr-wang.cn/2015/07/16/CentOS-nginx-installation/"/>
    <id>http://www.mr-wang.cn/2015/07/16/CentOS-nginx-installation/</id>
    <published>2015-07-16T12:26:27.000Z</published>
    <updated>2016-04-01T06:18:21.188Z</updated>
    <content type="html"><![CDATA[<p>1.最小化安装的CentOS没有安装gcc，首先安装gcc、g++和c++库；</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -<span class="keyword">y</span> install gcc-<span class="keyword">c</span>++</span><br></pre></td></tr></table></figure>
<p>2.安装pcre库，pcre库是为了使nginx支持http rewrite模块；</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/</span><br><span class="line">wget ftp://ftp.csx.cam.ac.uk/pub/software/programming/pcre/pcre-8.35.tar.gz</span><br><span class="line">tar -zxvf pcre-8.35.tar.gz</span><br><span class="line">cd pcre-8.35</span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>3.安装nginx，选择 Nginx 安装到 /usr/local/nginx 目录下；</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/</span><br><span class="line">wget http://nginx.org/download/nginx-1.2.8.tar.gz</span><br><span class="line">tar -zxvf nginx-1.6.2.tar.gz</span><br><span class="line">cd nginx-1.6.2</span><br><span class="line">./configure –prefix=/usr/local/nginx –with-http_stub_status_module –with-http_gzip_static_module</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<p>–with-http_stub_status_module可以启动Nginx的NginxStatus功能，以监控Nginx的当前状态。</p>
<p>4.启动nginx 确保系统的 80 端口没被其他程序占用；</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/sbin/nginx</span><br></pre></td></tr></table></figure>
<p>启动报错</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/sbin/nginx: error while loading shared libraries: libpcre.so.1: cannot open shared object file: No such file or directory</span><br></pre></td></tr></table></figure>
<p>解决：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ls</span> /lib/ |<span class="keyword">grep</span> pcre</span><br><span class="line">libpcre.<span class="keyword">so</span>.<span class="number">0</span></span><br><span class="line">libpcre.<span class="keyword">so</span>.<span class="number">0.0</span>.<span class="number">1</span></span><br><span class="line">#添加软连接</span><br><span class="line"><span class="keyword">ln</span> -<span class="keyword">s</span> /lib/libpcre.<span class="keyword">so</span>.<span class="number">0.0</span>.<span class="number">1</span> /lib/libpcre.<span class="keyword">so</span>.<span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>检查是否启动成功： netstat -ano|grep 80 有结果输入说明启动成功 打开浏览器访问此机器的 IP，如果浏览器出现 Welcome to nginx! 则表示 Nginx 已经安装并运行成功。</p>
<p>5./usr/local/nginx/config/nginx.conf配置文件详解：<br>Nginx的全局属性配置：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#定义Nginx运行的用户和用户组</span><br><span class="line">user nobody nobody;</span><br><span class="line">#nginx进程数，建议设置为等于CPU总核心数。</span><br><span class="line">worker_processes 4;</span><br><span class="line">#全局错误日志定义类型，[ debug | info | notice | warn | error | crit ]，其中debug输出的日志最为详细，而crit输出日志最少</span><br><span class="line">error_log /var/log/nginx/error.log info;</span><br><span class="line">#进程文件，指定进程id的存储文件位置</span><br><span class="line">pid /var/run/nginx.pid;</span><br><span class="line">#一个nginx进程打开的最多文件描述符数目，理论值应该是最多打开文件数（系统的值ulimit -n）与nginx进程数相除，但是nginx分配请求并不均匀，所以建议与ulimit -n的值保持一致。</span><br><span class="line">worker_rlimit_nofile 65535;</span><br><span class="line">#工作模式与连接数上限</span><br><span class="line">events</span><br><span class="line">&#123;</span><br><span class="line"># 参考事件模型，use [ kqueue | rtsig | epoll | /dev/poll | select | poll ]; 其中select和poll都是标准的工作模式，kqueue和epoll是高效的工作模式，不同的是epoll模型是Linux 2.6以上版本内核中的高性能网络I/O模型，如果跑在FreeBSD上面，就用kqueue模型。</span><br><span class="line">use epoll;</span><br><span class="line">#单个进程最大连接数（最大连接数=连接数*进程数）</span><br><span class="line">worker_connections 65535;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>6.http服务器配置：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">http&#123;</span><br><span class="line">#设定mime类型,类型由mime.type文件定义</span><br><span class="line">include      conf/mime.types;</span><br><span class="line">default_type  application/octet-stream;</span><br><span class="line">#设定日志格式</span><br><span class="line">log_format main ‘$remote_addr – $remote_user [$time_local] ‘</span><br><span class="line"> ‘“$request” $status $bytes_sent ‘</span><br><span class="line"> ‘“$http_referer” “$http_user_agent” ‘</span><br><span class="line"> ‘“$gzip_ratio”‘;</span><br><span class="line"> log_format download ‘$remote_addr – $remote_user [$time_local] ‘</span><br><span class="line"> ‘“$request” $status $bytes_sent ‘</span><br><span class="line"> ‘“$http_referer” “$http_user_agent” ‘</span><br><span class="line"> ‘“$http_range” “$sent_http_content_range”‘;</span><br><span class="line">#设置允许客户端请求的最大的单个文件字节数</span><br><span class="line">client_max_body_size  20m;</span><br><span class="line">#设置来自客户端请求头的headerbuffer大小，即缓存区大小</span><br><span class="line">client_header_buffer_size    32K;</span><br><span class="line">#用来指定客户端请求中较大的消息头的缓存最大数量和大小，4为个数，32k为大小，最大缓存4个32K</span><br><span class="line">large_client_header_buffers  4 32k;</span><br><span class="line">#sendfile 指令指定 nginx 是否调用 sendfile 函数（zero copy 方式）来输出文件</span><br><span class="line">#对于普通应用，必须设为 on,用来进行下载等应用磁盘IO重负载应用，可设置为 off，以平衡磁盘与网络I/O处理速度，降低系统的uptime.</span><br><span class="line">#tcp_nopush和tcp_nodely两个指令设置为on，用于防止网络阻塞</span><br><span class="line">Sendfile  on;</span><br><span class="line">tcp_nopush     on;</span><br><span class="line">tcp_nodelay    on;</span><br><span class="line">#用于设置客户端连接保持活动的超时时间，超过这个时间，服务器会关闭该连接</span><br><span class="line">keepalive_timeout 60;</span><br><span class="line">#设置客户端请求头读取超时时间。如果超过这个时间，客户端还没有发送任何数据，Nginx将返回“Request time out（408）”错误</span><br><span class="line">client_header_timeout  10;</span><br><span class="line">#设置客户端请求主体读取超时时间。如果超过这个时间，客户端还没有发送任何数据，Nginx将返回“Request time out（408）”错误，默认值是60</span><br><span class="line">client_body_timeout    10;</span><br><span class="line">#指定响应客户端的超时时间。这个超时仅限于两个连接活动之间的时间，如果超过这个时间，客户端没有任何活动，Nginx将会关闭连接</span><br><span class="line">send_timeout          10;</span><br></pre></td></tr></table></figure>
<p>6.HttpGzip模块配置<br>下面配置Nginx的HttpGzip模块。这个模块支持在线实时压缩输出数据流。要查看是否安装了此模块，需要使用下面的命令：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/sbin/nginx  -V</span><br><span class="line">nginx version: nginx/0.7.65</span><br><span class="line">configure arguments: –with-http_stub_status_module –with-http_gzip_static_module –prefix=/opt/nginx</span><br></pre></td></tr></table></figure>
<p>通过/usr/local/nginx/sbin/nginx -V命令可以查看安装Nginx时的编译选项，由输出可知，我们已经安装了HttpGzip模块。<br>下面是HttpGzip模块在Nginx配置中的相关属性设置：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#用于设置开启或者关闭gzip模块，“gzip <span class="keyword">on</span>”表示开启GZIP压缩，实时压缩输出数据流</span><br><span class="line">gzip  <span class="keyword">on</span>;</span><br><span class="line">#设置允许压缩的页面最小字节数，页面字节数从header头的Content-Length中获取。默认值是<span class="number">0</span>，不管页面多大都进行压缩。建议设置成大于<span class="number">1</span>K的字节数，小于<span class="number">1</span>K可能会越压越大。</span><br><span class="line">gzip_min_length  <span class="number">1</span><span class="keyword">k</span>;</span><br><span class="line">#表示申请<span class="number">4</span>个单位为<span class="number">16</span>K的内存作为压缩结果流缓存，默认值是申请与原始数据大小相同的内存空间来存储gzip压缩结果。</span><br><span class="line">gzip_buffers     <span class="number">4</span>  <span class="number">16</span><span class="keyword">k</span>;</span><br><span class="line">#用于设置识别HTTP协议版本，默认是<span class="number">1.1</span>，目前大部分浏览器已经支持GZIP解压，使用默认即可</span><br><span class="line">gzip_http_version  <span class="number">1.1</span>;</span><br><span class="line">#用来指定GZIP压缩比，<span class="number">1</span> 压缩比最小，处理速度最快；<span class="number">9</span> 压缩比最大，传输速度快，但处理最慢，也比较消耗cpu资源</span><br><span class="line">gzip_comp_level  <span class="number">2</span>;</span><br><span class="line">#用来指定压缩的类型，无论是否指定，“text/html”类型总是会被压缩的</span><br><span class="line">gzip_types  text/plain application/<span class="keyword">x</span>-javascript text/css application/xml;</span><br><span class="line">#让前端的缓存服务器缓存经过GZIP压缩的页面，例如用Squid缓存经过Nginx压缩的数据</span><br><span class="line">gzip_vary  <span class="keyword">on</span>;</span><br></pre></td></tr></table></figure>
<p>7.StubStatus模块</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">location /NginxStatus &#123;</span><br><span class="line">#stub_status为“on”表示启用StubStatus的工作机制</span><br><span class="line">stub_status      on;</span><br><span class="line">#access_log用来指定StubStatus模块的访问日志文件，“off”为关闭，开启加路径</span><br><span class="line">access_log       off;</span><br><span class="line">#access_log       logs/NginxStatus.log;</span><br><span class="line">#访问控制</span><br><span class="line">allow    all;</span><br><span class="line">#auth_basic是Nginx的一种认证机制，auth_basic_user_file用来指定认证密码</span><br><span class="line">#auth_basic       “Nginxstatus”;</span><br><span class="line">#auth_basic_user_file   ../htpasswd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
    <summary type="html">
    <![CDATA[<p>1.最小化安装的CentOS没有安装gcc，首先安装gcc、g++和c++库；</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -<span class="keyword">y</span> install gcc-<span class="keyword">c</span>++</span><br></pre></td></tr></table></figure>
<p>2.安装pcre库，pcre库是为了使nginx支持http rewrite模块；</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/</span><br><span class="line">wget ftp://ftp.csx.cam.ac.uk/pub/software/programming/pcre/pcre-8.35.tar.gz</span><br><span class="line">tar -zxvf pcre-8.35.tar.gz</span><br><span class="line">cd pcre-8.35</span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>]]>
    
    </summary>
    
      <category term="Linux" scheme="http://www.mr-wang.cn/tags/Linux/"/>
    
      <category term="技术" scheme="http://www.mr-wang.cn/categories/%E6%8A%80%E6%9C%AF/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[CentOS 安装与调优配置]]></title>
    <link href="http://www.mr-wang.cn/2015/07/16/CentOS-System-Performance-tuning/"/>
    <id>http://www.mr-wang.cn/2015/07/16/CentOS-System-Performance-tuning/</id>
    <published>2015-07-16T12:26:27.000Z</published>
    <updated>2016-04-01T06:22:14.161Z</updated>
    <content type="html"><![CDATA[<h2 id="分区">分区</h2><p>至少2个分区，/以及swap分区。另外设置独立/boot分区。<br>所以生产环境分3个分区。</p>
<p>分区案例：<a href="http://oldboy.blog.51cto.com/2561410/634725" target="_blank" rel="external">http://oldboy.blog.51cto.com/2561410/634725</a></p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#分区查看</span><br><span class="line">df -Th</span><br><span class="line"></span><br><span class="line">Filesystem     Type   Size  Used Avail Use% Mounted <span class="keyword">on</span></span><br><span class="line">/dev/sda2      ext4   <span class="number">8.6</span>G  <span class="number">2.5</span>G  <span class="number">5.7</span>G  <span class="number">31</span>% /</span><br><span class="line">tmpfs          tmpfs  <span class="number">242</span>M     <span class="number">0</span>  <span class="number">242</span>M   <span class="number">0</span>% /dev/shm</span><br><span class="line">/dev/sda1      ext4   <span class="number">190</span>M   <span class="number">53</span>M  <span class="number">128</span>M  <span class="number">30</span>% /boot</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="挂载新硬盘">挂载新硬盘</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># 查看新加硬盘的文件名</span><br><span class="line">fdisk -<span class="keyword">l</span></span><br><span class="line"></span><br><span class="line"># 对新硬盘进行分区</span><br><span class="line">fdisk /dev/sdb</span><br><span class="line"></span><br><span class="line"># 查看分区的格式类型</span><br><span class="line">df -Th</span><br><span class="line"></span><br><span class="line"># 对新分区进行格式化</span><br><span class="line">mkfs -<span class="keyword">t</span> ext4 /dev/sdb1</span><br><span class="line"></span><br><span class="line"># 新建目录，并将分区挂载到目录下</span><br><span class="line"><span class="built_in">mkdir</span> /data</span><br><span class="line">mount /dev/sdb1 /data</span><br><span class="line"></span><br><span class="line"># 修改/etc/fstab文件，让开机自动挂载</span><br><span class="line">/dev/sdb1   /data   ext4   defaults    <span class="number">1</span> <span class="number">2</span></span><br></pre></td></tr></table></figure>
<h2 id="IP地址，DNS设置">IP地址，DNS设置</h2><h3 id="ip地址">ip地址</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/sysconfig/network-scripts/ifcfg-eth0</span><br><span class="line"></span><br><span class="line">DEVICE=eth0</span><br><span class="line">IPADDR=192.168.1.250</span><br><span class="line">NETMASK=255.255.255.0</span><br><span class="line">GATEWAY=192.168.1.1</span><br><span class="line">HWADDR=00:0C:29:F2:14:C7</span><br><span class="line">TYPE=Ethernet</span><br><span class="line">UUID=640ec151-26d6-4966-beb4-6de0c2306beb</span><br><span class="line">ONBOOT=yes</span><br><span class="line">NM_CONTROLLED=yes</span><br><span class="line">BOOTPROTO=static</span><br></pre></td></tr></table></figure>
<h3 id="DNS设置">DNS设置</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">vi</span> /etc/resolv.<span class="keyword">conf</span></span><br><span class="line"></span><br><span class="line">nameserver <span class="number">114.114</span>.<span class="number">114.114</span></span><br></pre></td></tr></table></figure>
<h2 id="yum源修改">yum源修改</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/yum.repos.d</span><br><span class="line">mv CentOS-Base.repo CentOS-Base.repo.bk </span><br><span class="line">wget http://mirrors.aliyun.com/repo/Centos-6.repo</span><br><span class="line">mv Centos-6.repo CentOS-Base.repo</span><br><span class="line">yum makecache</span><br><span class="line"></span><br><span class="line">#更新系统</span><br><span class="line">yum update</span><br><span class="line"></span><br><span class="line">#安装lrzsz上传下载工具</span><br><span class="line">yum install lrzsz</span><br></pre></td></tr></table></figure>
<h2 id="开机启动项优化">开机启动项优化</h2><p>1、图形界面禁止或启动服务<br>使用<code>setup</code>或者<code>ntsysv</code>命令</p>
<p>2、脚本实现禁止或启动服务</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#禁止全部服务</span><br><span class="line">for service in `chkconfig --list | grep 3:启用 | awk '&#123;print $1&#125;'`;do chkconfig --level 3 $service off;done</span><br><span class="line"></span><br><span class="line">#启用需要用到的服务</span><br><span class="line">for service in crond network sysstat sshd iptables;do chkconfig --level 3 $service on;done</span><br></pre></td></tr></table></figure>
<h2 id="SSH登陆设置">SSH登陆设置</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cp</span> /etc/ssh/sshd_config /etc/ssh/sshd_config.bk</span><br><span class="line"><span class="keyword">vi</span> /etc/ssh/sshd_config </span><br><span class="line"></span><br><span class="line">###By Mr-wang <span class="number">2015</span>-<span class="number">03</span>-<span class="number">20</span>###</span><br><span class="line">    Port <span class="number">22</span></span><br><span class="line">    PermitRootLogin <span class="keyword">no</span></span><br><span class="line">    PermitEmptyPasswords <span class="keyword">no</span></span><br><span class="line">    UseDNS <span class="keyword">no</span></span><br><span class="line">###By Mr-wang <span class="number">2015</span>-<span class="number">03</span>-<span class="number">20</span>###</span><br></pre></td></tr></table></figure>
<p>sshd_config 中文手册：<a href="http://www.jinbuguo.com/openssh/sshd_config.html" target="_blank" rel="external">http://www.jinbuguo.com/openssh/sshd_config.html</a></p>
<h2 id="修改中文显示">修改中文显示</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> <span class="string">'LANG="zh_CN.UTF-8"'</span> &gt; /etc/sysconfig/i18n</span><br></pre></td></tr></table></figure>
<p>注：&gt; 代表重写入   &gt;&gt; 代表追加</p>
<h2 id="服务器时间同步">服务器时间同步</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> <span class="string">'0 0 */1 * * /usr/sbin/ntpdate 210.72.145.44 &gt; /dev/null 2&gt;&amp;1'</span> &gt;&gt; /var/spool/cron/root</span><br></pre></td></tr></table></figure>
]]></content>
    <summary type="html">
    <![CDATA[<h2 id="分区">分区</h2><p>至少2个分区，/以及swap分区。另外设置独立/boot分区。<br>所以生产环境分3个分区。</p>
<p>分区案例：<a href="http://oldboy.blog.51cto.com/2561410/634725">http://oldboy.blog.51cto.com/2561410/634725</a></p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#分区查看</span><br><span class="line">df -Th</span><br><span class="line"></span><br><span class="line">Filesystem     Type   Size  Used Avail Use% Mounted <span class="keyword">on</span></span><br><span class="line">/dev/sda2      ext4   <span class="number">8.6</span>G  <span class="number">2.5</span>G  <span class="number">5.7</span>G  <span class="number">31</span>% /</span><br><span class="line">tmpfs          tmpfs  <span class="number">242</span>M     <span class="number">0</span>  <span class="number">242</span>M   <span class="number">0</span>% /dev/shm</span><br><span class="line">/dev/sda1      ext4   <span class="number">190</span>M   <span class="number">53</span>M  <span class="number">128</span>M  <span class="number">30</span>% /boot</span><br></pre></td></tr></table></figure>]]>
    
    </summary>
    
      <category term="Linux" scheme="http://www.mr-wang.cn/tags/Linux/"/>
    
      <category term="技术" scheme="http://www.mr-wang.cn/categories/%E6%8A%80%E6%9C%AF/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[记网站服务器遭遇PHPDDOS攻击]]></title>
    <link href="http://www.mr-wang.cn/2015/07/11/The-web-server-encountered-PHPDDOS/"/>
    <id>http://www.mr-wang.cn/2015/07/11/The-web-server-encountered-PHPDDOS/</id>
    <published>2015-07-11T12:26:27.000Z</published>
    <updated>2016-04-01T06:25:40.280Z</updated>
    <content type="html"><![CDATA[<p>2014年4月10–11日，公司web服务器遭遇PHPDDOS攻击，导致服务器宽带被大量占用，网络延迟很大，无法远程登陆服务器管理。</p>
<p>开始以为是访问量太大导致的，10日发现服务器始终向某一固定IP发送UDP 53的包。采用iptables禁用IP。</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -I OUTPUT -<span class="keyword">s</span> <span class="number">119.42</span>.<span class="number">149.69</span> -<span class="keyword">j</span> DROP</span><br></pre></td></tr></table></figure>
<p>然而服务器故障依旧，后来查询资料，发现原来服务器web网站被挂马，PHPDDOS。</p>
<a id="more"></a>
<p>现分享解决方法：</p>
<p>1.在linux服务器中输入如下命令：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">iptables -I OUTPUT -<span class="keyword">p</span> udp –-dport <span class="number">53</span> -<span class="keyword">d</span> <span class="number">202.103</span>.<span class="number">44.150</span> -<span class="keyword">j</span> ACCEPT</span><br><span class="line">iptables -I OUTPUT -<span class="keyword">p</span> udp –-dport <span class="number">53</span> -<span class="keyword">d</span> <span class="number">202.103</span>.<span class="number">24.68</span> -<span class="keyword">j</span> ACCEPT</span><br><span class="line">iptables -A OUTPUT -<span class="keyword">p</span> udp -<span class="keyword">j</span> REJECT</span><br><span class="line">/etc/rc.<span class="keyword">d</span>/init.<span class="keyword">d</span>/iptables save</span><br><span class="line">service iptables restart</span><br></pre></td></tr></table></figure>
<p>暂时通过iptables来屏蔽服务器向外发包。</p>
<p>2.查看网站日志，在日志中搜索IP：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">grep</span>  ‘<span class="number">119.42</span>.<span class="number">149.69</span>’  /usr/local/nginx/logs/access.<span class="built_in">log</span></span><br></pre></td></tr></table></figure>
<p>寻找服务器中的攻击文件，删除。</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>2014年4月10–11日，公司web服务器遭遇PHPDDOS攻击，导致服务器宽带被大量占用，网络延迟很大，无法远程登陆服务器管理。</p>
<p>开始以为是访问量太大导致的，10日发现服务器始终向某一固定IP发送UDP 53的包。采用iptables禁用IP。</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -I OUTPUT -<span class="keyword">s</span> <span class="number">119.42</span>.<span class="number">149.69</span> -<span class="keyword">j</span> DROP</span><br></pre></td></tr></table></figure>
<p>然而服务器故障依旧，后来查询资料，发现原来服务器web网站被挂马，PHPDDOS。</p>]]>
    
    </summary>
    
      <category term="Iptables" scheme="http://www.mr-wang.cn/tags/Iptables/"/>
    
      <category term="技术" scheme="http://www.mr-wang.cn/categories/%E6%8A%80%E6%9C%AF/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[让AMH虚拟主机支持PATHINFO]]></title>
    <link href="http://www.mr-wang.cn/2015/07/11/Let-AMH-virtual-host-support-PATHINFO/"/>
    <id>http://www.mr-wang.cn/2015/07/11/Let-AMH-virtual-host-support-PATHINFO/</id>
    <published>2015-07-11T12:26:27.000Z</published>
    <updated>2016-04-01T06:23:05.010Z</updated>
    <content type="html"><![CDATA[<p>现在公司许多程序是在基于ThinkPHP框架上进行开发的， 然而基于此框架开发的程序，URL访问形式如下：</p>
<p><a href="http://it.ctwoo.com/index.php/Login/index" target="_blank" rel="external">http://it.ctwoo.com/index.php/Login/index</a></p>
<p>默认Nginx是不支持PATHINFO的。</p>
<p>AMH虚拟主机支持PATHINFO更改方法,更改需要支持PATHINFO的主机的配置文件：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">vi</span> /usr/local/nginx/<span class="keyword">conf</span>/vhost/domain.<span class="keyword">com</span>.<span class="keyword">conf</span></span><br></pre></td></tr></table></figure>
<p>参考配置：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">location ~ ^(.+\.php)(.*)$</span><br><span class="line">&#123;</span><br><span class="line">    fastcgi_pass  unix:/tmp/php-cgi-e-uncommon.com.sock;</span><br><span class="line">    fastcgi_index index.php;</span><br><span class="line">    //begin</span><br><span class="line">    fastcgi_split_path_info ^(.+\.php)(.*)$;</span><br><span class="line">    fastcgi_param PATH_INFO $fastcgi_path_info;</span><br><span class="line">    //end</span><br><span class="line">    include fcgi-host.conf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Esc :wq 保存退出。</p>
<p>进入AMH后台重启Nginx即可。</p>
<a id="more"></a>
<p>2014年10月30日补充：<br>问题1：thinkphp在nginx环境下，不支持pathinfo。</p>
<p>pathinfo模式，举个例子：</p>
<p><a href="http://www.geekpark.net/read/view/171078" target="_blank" rel="external">http://www.geekpark.net/read/view/171078</a></p>
<p>首先会访问到 www.geekpark.net/index.php文件</p>
<p>然后 通过php文件get到参数 就会获取到 read/view/171078</p>
<p>通过拆分成数组就是</p>
<p>array(0=&gt;’read’,1=&gt;’view’,2=&gt;171078)</p>
<p>那么系统就会去 include read.php 然后在实例化 read</p>
<p>然后访问read对象内的 view方法</p>
<p>然后 view方法 get到171078这条参数进行数据库查询…..</p>
<p>很简单的理解为</p>
<p>read /view/ 171078</p>
<p>控制器 方法 参数</p>
<p>而thinkphp支持4种模式，将官网的讲解粘贴如下：</p>
<hr>
<p>一、普通模式：设置URL_MODEL 为0</p>
<p>采用传统的URL参数模式</p>
<p><a href="http://serverName/appName/?m=module&amp;a=action&amp;id=1" target="_blank" rel="external">http://serverName/appName/?m=module&amp;a=action&amp;id=1</a></p>
<p>二、PATHINFO模式（默认模式）：设置URL_MODEL 为1</p>
<p>默认情况使用PATHINFO模式，ThinkPHP内置强大的PATHINFO支持，提供灵活和友好URL支持。PATHINFO模式自动识别模块和操作，例如</p>
<p><a href="http://serverName/appName/module/action/id/1/" target="_blank" rel="external">http://serverName/appName/module/action/id/1/</a></p>
<p>或者</p>
<p><a href="http://serverName/appName/module,action,id,1/" target="_blank" rel="external">http://serverName/appName/module,action,id,1/</a></p>
<p>在不考虑路由的情况下，第一个参数会被解析成模块名称（如果启用了分组的话，则依次往后递推），第二个参数会被解析成操作，后面的参数是显式传递的，而且必须成对出现，例如：</p>
<p><a href="http://serverName/appName/module/action/year/2008/month/09/day/21/" target="_blank" rel="external">http://serverName/appName/module/action/year/2008/month/09/day/21/</a></p>
<p>其中参数之间的分割符号由URL_PATHINFO_DEPR参数设置，默认为”/”，例如我们设置URL_PATHINFO_DEPR为“-”的话，就可以使用下面的URL访问</p>
<p><a href="http://serverName/appName/module-action-id-1/" target="_blank" rel="external">http://serverName/appName/module-action-id-1/</a></p>
<p>注意不要使用”:” 和”&amp;”符号进行分割，该符号有特殊用途。</p>
<p>略加修改，就可以展示出富有诗意的URL，呵呵～</p>
<p>如果想要简化URL的形式可以通过路由功能（后面会有描述）以及空模块和空操作。</p>
<p>在PATH_INFO模式下面，会把相关参数转换成GET变量，以及并入REQUEST变量，因此不妨碍URL里面的GET和REQUEST变量获取。</p>
<p>三、REWRITE模式： 设置URL_MODEL 为2</p>
<p>该URL模式和PATHINFO模式功能一样，除了可以不需要在URL里面写入口文件，和可以定义.htaccess<br>文件外。在开启了Apache的URL_REWRITE模块后，就可以启用REWRITE模式了，具体参考下面的URL重写部分。</p>
<p>四、兼容模式： 设置URL_MODEL 为3</p>
<p>兼容模式是普通模式和PATHINFO模式的结合，并且可以让应用在需要的时候直接切换到PATHINFO模式而不需要更改模板和程序，还可以和URL_WRITE模式整合。兼容模式URL可以支持任何的运行环境。</p>
<p>兼容模式的效果是：</p>
<p><a href="http://serverName/appName/?s=/module/action/id/1/" target="_blank" rel="external">http://serverName/appName/?s=/module/action/id/1/</a></p>
<p>并且也可以支持参数分割符号的定义，例如在URL_PATHINFO_DEPR为~的情况下，下面的URL有效：</p>
<p><a href="http://serverName/appName/?s=module~action~id~1" target="_blank" rel="external">http://serverName/appName/?s=module~action~id~1</a></p>
<p>其实是利用了VAR_PATHINFO参数，用普通模式的实现模拟了PATHINFO的模式。但是兼容模式并不需要自己传s变量，而是由系统自动完成URL部分。正是由于这个特性，兼容模式可以和PATHINFO模式之间直接切换，而不需更改模板文件里面的URL地址连接。</p>
<p>某些服务器环境不能良好的支持PATHINFO，但是在大多数环境下面ThinkPHP可以进行兼容判断，如果你的服务器环境或者空间仍然无法识别PAHTINFO的话，或者需要自己增加识别方法或者可以选择普通模式或者兼容模式URL运行。</p>
<hr>
<p>前面AMH（nginx环境)支持pathinfo相关设置有讲到</p>
<p>实际使用发现新版的thinkphp设置后，不能成功。</p>
<p>后来尝试，使用如下方法解决：</p>
<p>1、将thinkphp模式设置为rewrite模式；</p>
<p>2、在AMH下，通过AMRewrite模块，新建一个rewrite规则，内容如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">if (!-e $request_filename) &#123;</span><br><span class="line">rewrite ^(.*)$ /index.php?s=$1 last;</span><br><span class="line">break;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">location /Apps/crm7/ &#123;</span><br><span class="line">if (!-e $request_filename) &#123;</span><br><span class="line">rewrite ^/Apps/crm7/(.*)$ /Apps/crm7/index.php?s=$1 last;</span><br><span class="line">break;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">location /Apps/zhiansys/ &#123;</span><br><span class="line">if (!-e $request_filename) &#123;</span><br><span class="line">rewrite ^/Apps/zhiansys/(.*)$ /Apps/zhiansys/index.php?s=$1 last;</span><br><span class="line">break;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">location /Apps/it/ &#123;</span><br><span class="line">if (!-e $request_filename) &#123;</span><br><span class="line">rewrite ^/Apps/it/(.*)$ /Apps/it/index.php?s=$1 last;</span><br><span class="line">break;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3、将规则应用到对应网址，重启nginx。</p>
<p>问题2：AMH环境下访问sqlserver数据库，返回数据编码有误，导致返回数据均为问号</p>
<p>首先，AMH环境下安装mssql模块：</p>
<p>1、安装freetds</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/</span><br><span class="line">wget http://mirrors.xmu.edu.cn/ubuntu/archive/pool/main/f/freetds/freetds_0.82.orig.tar.gz</span><br><span class="line">tar zxf freetds_0.82.orig.tar.gz</span><br><span class="line">cd freetds-0.82</span><br><span class="line">./configure –prefix=/usr/local/freetds –with-tdsver=8.0 –enable-msdblib –enable-dbmfix –with-gnu-ld –enable-shared –enable-static</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<p>2、下载php源码，安装mssql模块</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> php-<span class="number">5.3</span>.<span class="number">27</span>/ext/mssql</span><br><span class="line">/usr/local/php/bin/phpize;</span><br><span class="line">./configure –with-php-config=/usr/local/php/bin/php-config  –with-mssql=/usr/local/freetds</span><br><span class="line"><span class="keyword">make</span> &amp;&amp; <span class="keyword">make</span> install</span><br><span class="line"><span class="keyword">vi</span> /etc/php.ini</span><br><span class="line">extension = /usr/local/php/lib/php/extensions/<span class="keyword">no</span>-<span class="keyword">debug</span>-non-zts-<span class="number">20090626</span>/mssql.<span class="keyword">so</span></span><br></pre></td></tr></table></figure>
<p>3、重启面板php、虚拟主机php</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">amh php restart amh-web <span class="keyword">y</span></span><br><span class="line">amh php restart</span><br></pre></td></tr></table></figure>
<p>其次，修改php.ini</p>
<p>添加mssql.charset = “UTF8″</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>现在公司许多程序是在基于ThinkPHP框架上进行开发的， 然而基于此框架开发的程序，URL访问形式如下：</p>
<p><a href="http://it.ctwoo.com/index.php/Login/index">http://it.ctwoo.com/index.php/Login/index</a></p>
<p>默认Nginx是不支持PATHINFO的。</p>
<p>AMH虚拟主机支持PATHINFO更改方法,更改需要支持PATHINFO的主机的配置文件：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">vi</span> /usr/local/nginx/<span class="keyword">conf</span>/vhost/domain.<span class="keyword">com</span>.<span class="keyword">conf</span></span><br></pre></td></tr></table></figure>
<p>参考配置：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">location ~ ^(.+\.php)(.*)$</span><br><span class="line">&#123;</span><br><span class="line">    fastcgi_pass  unix:/tmp/php-cgi-e-uncommon.com.sock;</span><br><span class="line">    fastcgi_index index.php;</span><br><span class="line">    //begin</span><br><span class="line">    fastcgi_split_path_info ^(.+\.php)(.*)$;</span><br><span class="line">    fastcgi_param PATH_INFO $fastcgi_path_info;</span><br><span class="line">    //end</span><br><span class="line">    include fcgi-host.conf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Esc :wq 保存退出。</p>
<p>进入AMH后台重启Nginx即可。</p>]]>
    
    </summary>
    
      <category term="Nginx" scheme="http://www.mr-wang.cn/tags/Nginx/"/>
    
      <category term="技术" scheme="http://www.mr-wang.cn/categories/%E6%8A%80%E6%9C%AF/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[2013年版通达OA与飞信集成]]></title>
    <link href="http://www.mr-wang.cn/2015/07/11/The-tongda-of-OA-with-Fetion-integrated-access/"/>
    <id>http://www.mr-wang.cn/2015/07/11/The-tongda-of-OA-with-Fetion-integrated-access/</id>
    <published>2015-07-11T12:26:27.000Z</published>
    <updated>2016-04-01T06:28:18.575Z</updated>
    <content type="html"><![CDATA[<p>基于PHP-fetion进行修改。</p>
<p>作者博客：<a href="http://blog.quanhz.com/" target="_blank" rel="external">http://blog.quanhz.com/</a></p>
<p>PHP-fetion代码：<a href="https://code.google.com/p/php-fetion/" target="_blank" rel="external">https://code.google.com/p/php-fetion/</a></p>
<p>对定时发送页面做了修改：</p>
<p>fetion_send_sms.php(2013年版通达OA)</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&lt;?</span><br><span class="line">//定时任务发送飞信手机短信</span><br><span class="line">    include_once (“inc/conn.php”);</span><br><span class="line">    include_once (“inc/fetion.php”); //账号密码</span><br><span class="line">    require_once (“inc/class.fetion.php”); //飞信发送类</span><br><span class="line">    require_once (“inc/class.gateway.php”); //其他API接口发送</span><br><span class="line">    $cur_time = date(“Y-m-d H:i:s”); //获得当前时间</span><br><span class="line">    $query = “SELECT `SMS_ID`,`PHONE`,`CONTENT` FROM `SMS2` WHERE `SEND_TIME` &lt;= ‘&#123;$cur_time&#125;’ AND `SEND_FLAG` = ‘3’ LIMIT 1″; //检测短信时间及状态</span><br><span class="line">    $cursor = exequery($connection, $query); //连接数据库</span><br><span class="line">    //无短信需要发送</span><br><span class="line">    if (0 == mysql_num_rows($cursor)) &#123;</span><br><span class="line">        echo “No message to send”;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">    //发送飞信</span><br><span class="line">    $ROW = mysql_fetch_array($cursor);</span><br><span class="line">    $PHONE = $ROW['PHONE'];</span><br><span class="line">    $CONTENT = $ROW['CONTENT'];</span><br><span class="line">    $SMS_ID = $ROW['SMS_ID'];</span><br><span class="line">    //登陆飞信</span><br><span class="line">    $fetion = new PHPFetion($mobile, $password);</span><br><span class="line">    //发送飞信短信</span><br><span class="line">    $result = $fetion-&gt;send($PHONE, iconv(“gbk”, “utf-8″, $CONTENT));</span><br><span class="line">    //发送短信读取手机号，及信息内容转换代码</span><br><span class="line">    $result = iconv(“utf-8″, “gbk”, $result); //返回值</span><br><span class="line">    //判定飞信发送是否成功</span><br><span class="line">    if (strpos($result, “成功”) === FALSE) &#123;</span><br><span class="line">        $JIEGUO = 0; //失败，状态更新至待网关发送</span><br><span class="line">        echo “One message to sent by MAS”;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        $JIEGUO = 1; //成功</span><br><span class="line">        echo “One message to sent by Fetion”;</span><br><span class="line">    &#125;</span><br><span class="line">    //更新短信发送状态</span><br><span class="line">    $query2 = “UPDATE `SMS2` SET `SEND_FLAG` = ‘&#123;$JIEGUO&#125;’ WHERE `SMS_ID`='&#123;$SMS_ID&#125;'”;</span><br><span class="line">    exequery($connection, $query2);</span><br><span class="line">    //结束会话</span><br><span class="line">    $fetion-&gt;_logout();</span><br><span class="line">    &#125;</span><br><span class="line">    /* End of the file */</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>其余代码，点击下载：<a href="http://mr-wang.qiniudn.com/2013%E5%B9%B4%E7%89%88OA%E4%B8%8E%E9%A3%9E%E4%BF%A1%E9%9B%86%E6%88%90%E6%96%B9%E6%A1%88.zip" target="_blank" rel="external">2013年版OA与飞信集成方案</a></p>
<p>将文件在OA服务器wwwroot目录下进行覆盖，将task目录下的fetion_send_sms.php加入到通达OA的定时任务中。</p>
<p>注：OA自带的定时任务的最小时间间隔为1分钟，飞信发送缓慢。</p>
<p>这里提供2种解决方案：</p>
<p>1、windows下</p>
<p>创建一个cron.bat的批处理文件并用记事本打开输入：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@echo off</span><br><span class="line">:fetion</span><br><span class="line">ping -n 2 127.0.0.1 &gt;&gt;nul</span><br><span class="line">start http://188.188.0.9/fetion_send_sms.php</span><br><span class="line">ping -n 3 127.0.0.1 &gt;&gt;nul</span><br><span class="line">taskkill /f /im "iexplore.exe"</span><br><span class="line">goto fetion</span><br><span class="line">pause</span><br></pre></td></tr></table></figure>
<p>2.linux下</p>
<p>在/root/shell下创建一个fetion.sh的shell脚本</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">curl http://188.188.0.9/fetion_send_sms.php</span><br><span class="line">#局域网访问php代码的地址</span><br></pre></td></tr></table></figure>
<p>然后，每隔5s钟访问指定php脚本。</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">crontab -<span class="keyword">e</span></span><br><span class="line">* * * * * /root/<span class="keyword">shell</span>/fetion.<span class="keyword">sh</span></span><br><span class="line">* * * * * <span class="keyword">sleep</span> <span class="number">5</span> &amp;amp;&amp;amp; /root/<span class="keyword">shell</span>/fetion.<span class="keyword">sh</span></span><br><span class="line">* * * * * <span class="keyword">sleep</span> <span class="number">10</span> &amp;amp;&amp;amp; /root/<span class="keyword">shell</span>/fetion.<span class="keyword">sh</span></span><br><span class="line">* * * * * <span class="keyword">sleep</span> <span class="number">15</span> &amp;amp;&amp;amp; /root/<span class="keyword">shell</span>/fetion.<span class="keyword">sh</span></span><br><span class="line">* * * * * <span class="keyword">sleep</span> <span class="number">20</span> &amp;amp;&amp;amp; /root/<span class="keyword">shell</span>/fetion.<span class="keyword">sh</span></span><br><span class="line">* * * * * <span class="keyword">sleep</span> <span class="number">25</span> &amp;amp;&amp;amp; /root/<span class="keyword">shell</span>/fetion.<span class="keyword">sh</span></span><br><span class="line">* * * * * <span class="keyword">sleep</span> <span class="number">30</span> &amp;amp;&amp;amp; /root/<span class="keyword">shell</span>/fetion.<span class="keyword">sh</span></span><br><span class="line">* * * * * <span class="keyword">sleep</span> <span class="number">35</span> &amp;amp;&amp;amp; /root/<span class="keyword">shell</span>/fetion.<span class="keyword">sh</span></span><br><span class="line">* * * * * <span class="keyword">sleep</span> <span class="number">40</span> &amp;amp;&amp;amp; /root/<span class="keyword">shell</span>/fetion.<span class="keyword">sh</span></span><br><span class="line">* * * * * <span class="keyword">sleep</span> <span class="number">45</span> &amp;amp;&amp;amp; /root/<span class="keyword">shell</span>/fetion.<span class="keyword">sh</span></span><br><span class="line">* * * * * <span class="keyword">sleep</span> <span class="number">50</span> &amp;amp;&amp;amp; /root/<span class="keyword">shell</span>/fetion.<span class="keyword">sh</span></span><br><span class="line">* * * * * <span class="keyword">sleep</span> <span class="number">55</span> &amp;amp;&amp;amp; /root/<span class="keyword">shell</span>/fetion.<span class="keyword">sh</span></span><br></pre></td></tr></table></figure>
<p>2014.5.18日，更新统计飞信、mas发送次数，删除root邮件。</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/<span class="keyword">sh</span></span><br><span class="line">Fetion_DateName=Fetion_Date_$(date +“%Y%<span class="keyword">m</span>%<span class="keyword">d</span>”).txt</span><br><span class="line">MAS_DateName=MAS_Date_$(date +“%Y%<span class="keyword">m</span>%<span class="keyword">d</span>”).txt</span><br><span class="line"><span class="keyword">grep</span> ‘One message <span class="keyword">to</span> sent by Fetion’ /var/spool/mail/root | wc -<span class="keyword">l</span> &gt;&gt; /root/<span class="keyword">shell</span>/Date_Fetion/$Fetion_DateName</span><br><span class="line"><span class="keyword">grep</span> ‘One message <span class="keyword">to</span> sent by MAS’ /var/spool/mail/root | wc -<span class="keyword">l</span> &gt;&gt; /root/<span class="keyword">shell</span>/Date_Fetion/$MAS_DateName</span><br><span class="line"><span class="keyword">cat</span> /dev/null &gt; /var/spool/mail/root</span><br></pre></td></tr></table></figure>
]]></content>
    <summary type="html">
    <![CDATA[<p>基于PHP-fetion进行修改。</p>
<p>作者博客：<a href="http://blog.quanhz.com/">http://blog.quanhz.com/</a></p>
<p>PHP-fetion代码：<a href="https://code.google.com/p/php-fetion/">https://code.google.com/p/php-fetion/</a></p>
<p>对定时发送页面做了修改：</p>
<p>fetion_send_sms.php(2013年版通达OA)</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&lt;?</span><br><span class="line">//定时任务发送飞信手机短信</span><br><span class="line">    include_once (“inc/conn.php”);</span><br><span class="line">    include_once (“inc/fetion.php”); //账号密码</span><br><span class="line">    require_once (“inc/class.fetion.php”); //飞信发送类</span><br><span class="line">    require_once (“inc/class.gateway.php”); //其他API接口发送</span><br><span class="line">    $cur_time = date(“Y-m-d H:i:s”); //获得当前时间</span><br><span class="line">    $query = “SELECT `SMS_ID`,`PHONE`,`CONTENT` FROM `SMS2` WHERE `SEND_TIME` &lt;= ‘&#123;$cur_time&#125;’ AND `SEND_FLAG` = ‘3’ LIMIT 1″; //检测短信时间及状态</span><br><span class="line">    $cursor = exequery($connection, $query); //连接数据库</span><br><span class="line">    //无短信需要发送</span><br><span class="line">    if (0 == mysql_num_rows($cursor)) &#123;</span><br><span class="line">        echo “No message to send”;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">    //发送飞信</span><br><span class="line">    $ROW = mysql_fetch_array($cursor);</span><br><span class="line">    $PHONE = $ROW['PHONE'];</span><br><span class="line">    $CONTENT = $ROW['CONTENT'];</span><br><span class="line">    $SMS_ID = $ROW['SMS_ID'];</span><br><span class="line">    //登陆飞信</span><br><span class="line">    $fetion = new PHPFetion($mobile, $password);</span><br><span class="line">    //发送飞信短信</span><br><span class="line">    $result = $fetion-&gt;send($PHONE, iconv(“gbk”, “utf-8″, $CONTENT));</span><br><span class="line">    //发送短信读取手机号，及信息内容转换代码</span><br><span class="line">    $result = iconv(“utf-8″, “gbk”, $result); //返回值</span><br><span class="line">    //判定飞信发送是否成功</span><br><span class="line">    if (strpos($result, “成功”) === FALSE) &#123;</span><br><span class="line">        $JIEGUO = 0; //失败，状态更新至待网关发送</span><br><span class="line">        echo “One message to sent by MAS”;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        $JIEGUO = 1; //成功</span><br><span class="line">        echo “One message to sent by Fetion”;</span><br><span class="line">    &#125;</span><br><span class="line">    //更新短信发送状态</span><br><span class="line">    $query2 = “UPDATE `SMS2` SET `SEND_FLAG` = ‘&#123;$JIEGUO&#125;’ WHERE `SMS_ID`='&#123;$SMS_ID&#125;'”;</span><br><span class="line">    exequery($connection, $query2);</span><br><span class="line">    //结束会话</span><br><span class="line">    $fetion-&gt;_logout();</span><br><span class="line">    &#125;</span><br><span class="line">    /* End of the file */</span><br></pre></td></tr></table></figure>]]>
    
    </summary>
    
      <category term="通达OA" scheme="http://www.mr-wang.cn/tags/%E9%80%9A%E8%BE%BEOA/"/>
    
      <category term="技术" scheme="http://www.mr-wang.cn/categories/%E6%8A%80%E6%9C%AF/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Nginx下dedecms安全设置]]></title>
    <link href="http://www.mr-wang.cn/2015/07/11/dedecms-security-settings-on-Nginx/"/>
    <id>http://www.mr-wang.cn/2015/07/11/dedecms-security-settings-on-Nginx/</id>
    <published>2015-07-11T12:26:27.000Z</published>
    <updated>2016-04-01T06:22:27.042Z</updated>
    <content type="html"><![CDATA[<h2 id="目录权限设置">目录权限设置</h2><p>织梦可读写、不可执行权限，禁止运行php程序目录：</p>
<ul>
<li>templets</li>
<li>uploads</li>
<li>data</li>
<li>images</li>
<li>a</li>
</ul>
<p>具体目录，可以通过后台一键更新时，寻找需要写入权限的目录</p>
<p>思路：<br>web服务器(AMH)运行的用户应该是www，那么网站的所有者就应该不能设置为www，而应该设置为不同的用户，这里设置为ftpuser用户。同时www、ftpuser用户应该为同一组，这里设置同为www组。</p>
<a id="more"></a>
<p>1、那么我们将网站目录的所有者设置为ftpuser，用户组设置为www，目录权限设置为为750，文件权限设置为640。这里以AMH控制面板为例：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd /home/wwwroot/$web_site</span><br><span class="line">chown -R ftpuser.www web</span><br><span class="line">find web -type d -exec chmod 750 &#123;&#125; \;</span><br><span class="line">find web -not -type d -exec chmod 640 &#123;&#125; \;</span><br></pre></td></tr></table></figure>
<p>2、针对需要有读写权限的目录，templets、uploads、data、images、a等</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> web</span><br><span class="line">chmod -R <span class="number">770</span> templets uploads data images <span class="keyword">a</span></span><br></pre></td></tr></table></figure>
<h2 id="禁止执行PHP文件">禁止执行PHP文件</h2><p>针对有读写权限的目录，禁止运行PHP</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vi /usr/local/nginx/conf/vhost/$web_site.conf</span><br><span class="line">#追加如下</span><br><span class="line">location ~* ^/(templets|uploads|data|images|a)/.*\.(php|php5)$</span><br><span class="line">&#123;</span><br><span class="line">	deny all;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Shell增加变量">Shell增加变量</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">#dede_safe.sh</span><br><span class="line">#$1指网站目录</span><br><span class="line">cd /home/wwwroot/$1</span><br><span class="line">chown -R ftpuser.www web</span><br><span class="line">find web -type d -exec chmod 750 &#123;&#125; \;</span><br><span class="line">find web -type f -exec chmod 640 &#123;&#125; \;</span><br><span class="line"></span><br><span class="line">#$2指有读写权限的目录名称（目录名称之间用空格隔开）</span><br><span class="line">cd web</span><br><span class="line">chmod -R 770 $2</span><br><span class="line"></span><br><span class="line">#$3指有读写权限的目录名称（目录名称之间用|隔开）</span><br><span class="line">cd /usr/local/nginx/conf/vhost/</span><br><span class="line">sed -i '/php\$/i\\ \tlocation ~* ^/('"$3"')/.*\.(php|php5)$\n\t&#123;\n\t\tdeny all;\n\t&#125;\n' "$1".conf sed -i '/php\$/i\\ \tlocation ~* ^/('"$3"')/.*\.(php|php5)$\n\t&#123;\n\t\tdeny all;\n\t&#125;\n' "$1".conf</span><br></pre></td></tr></table></figure>
<p>如何来调用：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./dede_safe.<span class="keyword">sh</span> <span class="string">"www.wangyi.com"</span> <span class="string">"templets uploads"</span> <span class="string">"templets|uploads"</span></span><br></pre></td></tr></table></figure>
<p>在sed中使用变量</p>
<p>通常，我们使用sed进行变量替换的时候，替换和被替换变量都是hard-coded的。例如：</p>
<p><code>sed -n ‘/comm/p’ /tmp/test.log</code></p>
<p>如果我们用一变量var，它的值根据上下文变化</p>
<p><code>$ var=”comm”</code>，定义了变量，那么我们在sed的使用中这样使用变量</p>
<p><code>$ sed -n ‘/’”$var”‘/p’ /tmp/test.log</code></p>
<p>注意，是用单引号包含双引号来引用变量。</p>
]]></content>
    <summary type="html">
    <![CDATA[<h2 id="目录权限设置">目录权限设置</h2><p>织梦可读写、不可执行权限，禁止运行php程序目录：</p>
<ul>
<li>templets</li>
<li>uploads</li>
<li>data</li>
<li>images</li>
<li>a</li>
</ul>
<p>具体目录，可以通过后台一键更新时，寻找需要写入权限的目录</p>
<p>思路：<br>web服务器(AMH)运行的用户应该是www，那么网站的所有者就应该不能设置为www，而应该设置为不同的用户，这里设置为ftpuser用户。同时www、ftpuser用户应该为同一组，这里设置同为www组。</p>]]>
    
    </summary>
    
      <category term="Nginx" scheme="http://www.mr-wang.cn/tags/Nginx/"/>
    
      <category term="技术" scheme="http://www.mr-wang.cn/categories/%E6%8A%80%E6%9C%AF/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[AMH重新编译Nginx，使其支持静态页面post]]></title>
    <link href="http://www.mr-wang.cn/2015/07/11/To-compile-Nginx-which-supports-static-post-pages/"/>
    <id>http://www.mr-wang.cn/2015/07/11/To-compile-Nginx-which-supports-static-post-pages/</id>
    <published>2015-07-11T12:26:27.000Z</published>
    <updated>2016-04-01T06:25:55.112Z</updated>
    <content type="html"><![CDATA[<p>在实际使用AMH的过程中，公司出现通过post请求静态页面；默认的nginx上，是拒绝通过post方式访问静态页面的。</p>
<p>网上有2种方法解决这个问题，但是在实际的过程中，发现方法1不奏效,于是使用方法2，重新编译nginx解决问题。</p>
<a id="more"></a>
<p>方法1：</p>
<p>修改nginc.conf配置文件，改变“405错误”为“200 ok”，并配置location来解决</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">vi</span> /usr/local/nginx/<span class="keyword">conf</span>/vhost/domain.<span class="keyword">com</span>.<span class="keyword">conf</span></span><br></pre></td></tr></table></figure>
<p>添加：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">error_page 405 =200 @405;</span><br><span class="line">location @405</span><br><span class="line">&#123;</span><br><span class="line">    root /home/wwwroot/web/doamin.com;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>方法2：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cd /home/amh_install/</span><br><span class="line">wget http://code.amysql.com/files/nginx-1.4.4.tar.gz</span><br><span class="line">tar zxvf nginx-1.4.4.tar.gz</span><br><span class="line">cd nginx-1.4.4/src/http/modules/</span><br><span class="line"></span><br><span class="line">vi ngx_http_static_module.c</span><br><span class="line">#将这段屏蔽掉；</span><br><span class="line">/*</span><br><span class="line">if (r-&gt;method &amp; NGX_HTTP_POST) &#123;</span><br><span class="line">     return NGX_HTTP_NOT_ALLOWED;</span><br><span class="line">&#125;</span><br><span class="line">*/</span><br></pre></td></tr></table></figure>
<p>重新编译：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./configure –prefix=/usr/local/nginx –user=www –group=www –with-http_ssl_module –with-http_static_module –with-http_gzip_static_module –without-mail_pop3_module –without-mail_imap_module –without-mail_smtp_module –without-http_uwsgi_module –without-http_scgi_module</span><br><span class="line"><span class="keyword">make</span></span><br></pre></td></tr></table></figure>
<p>编译完成后不要再执行 make install，不然会把原有的配置文件覆盖，正确的方法是直接删除旧的，把新的复制过去后再执行make upgrade。</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mv /usr/local/nginx/sbin/nginx /usr/local/nginx/sbin/nginx.bak</span><br><span class="line"><span class="keyword">cp</span> ./objs/nginx /usr/local/nginx/sbin/</span><br><span class="line"><span class="keyword">make</span> upgrade</span><br></pre></td></tr></table></figure>
<p>重载一下nginx</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.<span class="keyword">d</span>/nginx reload</span><br></pre></td></tr></table></figure>
]]></content>
    <summary type="html">
    <![CDATA[<p>在实际使用AMH的过程中，公司出现通过post请求静态页面；默认的nginx上，是拒绝通过post方式访问静态页面的。</p>
<p>网上有2种方法解决这个问题，但是在实际的过程中，发现方法1不奏效,于是使用方法2，重新编译nginx解决问题。</p>]]>
    
    </summary>
    
      <category term="Nginx" scheme="http://www.mr-wang.cn/tags/Nginx/"/>
    
      <category term="技术" scheme="http://www.mr-wang.cn/categories/%E6%8A%80%E6%9C%AF/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Netbois协议导致网络阻塞]]></title>
    <link href="http://www.mr-wang.cn/2015/07/11/Netbois-protocol-leads-to-network-congestion/"/>
    <id>http://www.mr-wang.cn/2015/07/11/Netbois-protocol-leads-to-network-congestion/</id>
    <published>2015-07-11T12:26:27.000Z</published>
    <updated>2016-04-01T05:03:41.000Z</updated>
    <content type="html"><![CDATA[<p>办公室有台电脑，经常导致办公室网络中断。使用抓包工具分析，该电脑在网络组始终在使用Netbois协议进行域名查询，导致网络阻塞。</p>
<p>在网上有这样的解释：</p>
<p>最近也发现很多接入交换机出现类似的情况，因为接入交换机端口所属VLAN在核心交换机上也有，最终竟然导致接入交换机和汇聚交换机、核心交换机间的链路阻塞，使得网络变得基本不通。<br>初步分析了一下捕获到的数据，基本认定原因在于好多个人计算机内包含恶意/流氓软件，会不停地访问btamail.net、bar.baidu.com、 sobar.baidu.com等域名，同时，windows的名字解析机制的顺序是：</p>
<ol>
<li>hosts</li>
<li>net bios, wins, lmhosts</li>
<li>dns<br>所以，就会在网络中产生大量nbns的数据包</li>
</ol>
<p>然后，在那台电脑上杀进程，找到恶意软件。</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>办公室有台电脑，经常导致办公室网络中断。使用抓包工具分析，该电脑在网络组始终在使用Netbois协议进行域名查询，导致网络阻塞。</p>
<p>在网上有这样的解释：</p>
<p>最近也发现很多接入交换机出现类似的情况，因为接入交换机端口所属VLAN在核心交换机上也有，最终]]>
    </summary>
    
      <category term="网络" scheme="http://www.mr-wang.cn/tags/%E7%BD%91%E7%BB%9C/"/>
    
      <category term="技术" scheme="http://www.mr-wang.cn/categories/%E6%8A%80%E6%9C%AF/"/>
    
  </entry>
  
</feed>