<?xml version="1.0" encoding="utf-8"?>
<search> 
  
    
    <entry>
      <title><![CDATA[PyQt实现WebView]]></title>
      <url>/2016/09/08/PyQt-WebView/</url>
      <content type="html"><![CDATA[<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div></pre></td><td class="code"><pre><div class="line">#!/usr/bin/env <span class="keyword">python</span></div><div class="line"># __*__ codin<span class="variable">g:utf</span>-<span class="number">8</span> __*__</div><div class="line"></div><div class="line">import sys,time</div><div class="line">from PyQt4.Qt import *</div><div class="line">from PyQt4.QtWebKit import *</div><div class="line">from PyQt4.QtCore import *</div><div class="line">from PyQt4 import QtGui</div><div class="line">import ConfigParser</div><div class="line"></div><div class="line"></div><div class="line">class WebView(QWebView):</div><div class="line">    def __init__(self):</div><div class="line">        super(WebView,self).__init__()</div><div class="line"></div><div class="line">        #读取配置文件，配置文件管理访问的url及窗口是否全屏</div><div class="line">        <span class="keyword">cf</span> = ConfigParser.ConfigParser()</div><div class="line">        <span class="keyword">cf</span>.<span class="keyword">read</span>(<span class="string">'WeChat.conf'</span>)</div><div class="line">        url = <span class="keyword">cf</span>.<span class="built_in">get</span>(<span class="string">'WeChat'</span>,<span class="string">'url'</span>)</div><div class="line">        showFullScreen_enable = <span class="keyword">cf</span>.<span class="built_in">get</span>(<span class="string">'WeChat'</span>,<span class="string">'showFullScreen_enable'</span>)</div><div class="line"></div><div class="line">        #打开url</div><div class="line">        self.load(QUrl(url))</div><div class="line">        self.page().setLinkDelegationPolicy(QWebPage.DelegateAllLinks)</div><div class="line">        self.page().linkClicked.connect(self.linkClicked)</div><div class="line"></div><div class="line">        #设置窗口标题、图标</div><div class="line">        self.setWindowTitle(<span class="keyword">u</span><span class="string">'二维码扫码'</span>)</div><div class="line">        self.setWindowIcon(QtGui.QIcon(<span class="string">'WeChat.png'</span>))</div><div class="line"></div><div class="line">        #创建托盘</div><div class="line">        self.createTrayIcon()</div><div class="line">        #托盘点击事件</div><div class="line">        self.trayIcon.activated.connect(self.iconActivated)</div><div class="line"></div><div class="line">        <span class="keyword">if</span> showFullScreen_enable == <span class="string">'True'</span>:</div><div class="line">            self.showFullScreen()</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            pass</div><div class="line"></div><div class="line">        self.show()</div><div class="line"></div><div class="line"></div><div class="line">    def linkClicked(self, url):</div><div class="line">        self.load(QUrl(url))</div><div class="line"></div><div class="line">    def closeEvent(self, event):</div><div class="line">        QtGui.QMessageBox.about(self,<span class="keyword">u</span><span class="string">'提示 '</span>,<span class="keyword">u</span><span class="string">'不允许关闭! '</span>)</div><div class="line">        event.ignore()</div><div class="line"></div><div class="line">    def focusOutEvent(self, QFocusEvent):</div><div class="line">        self.trayIcon.showMessage(<span class="string">"警告"</span>, <span class="string">"窗口已失焦"</span>, <span class="number">2</span>)</div><div class="line"></div><div class="line">    def focusInEvent(self, QFocusEvent):</div><div class="line">        self.trayIcon.showMessage(<span class="string">"提示"</span>, <span class="string">"窗口已聚焦"</span>, <span class="number">1</span>)</div><div class="line"></div><div class="line">    def createTrayIcon(self):</div><div class="line">         icon = QtGui.QIcon(<span class="string">'WeChat.png'</span>)</div><div class="line">         self.trayIcon = QtGui.QSystemTrayIcon(self)</div><div class="line">         self.trayIcon.setIcon(icon)</div><div class="line">         self.trayIcon.setToolTip(self.<span class="keyword">tr</span>(<span class="string">"二维码扫码"</span>))</div><div class="line">         self.trayIcon.setVisible(True)</div><div class="line"></div><div class="line">    def iconActivated(self, reason):</div><div class="line">        <span class="keyword">if</span> reason in (QtGui.QSystemTrayIcon.Trigger, QtGui.QSystemTrayIcon.DoubleClick):</div><div class="line">            self.showFullScreen()</div><div class="line">        elif reason == QtGui.QSystemTrayIcon.MiddleClick:</div><div class="line">            self.showFullScreen()</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line"></div><div class="line">    app = QApplication(sys.<span class="built_in">argv</span>)</div><div class="line"></div><div class="line">    #解决打包<span class="keyword">exe</span>后，页面中文乱码问题</div><div class="line">    app.Encoding(QApplication.UnicodeUTF8)</div><div class="line">    utfcodec = QTextCodec.codecForName(<span class="string">"UTF-8"</span>)</div><div class="line">    QTextCodec.setCodecForTr(utfcodec)</div><div class="line">    QTextCodec.setCodecForLocale(utfcodec)</div><div class="line">    QTextCodec.setCodecForCStrings(utfcodec)</div><div class="line"></div><div class="line">    webView = WebView()</div><div class="line"></div><div class="line">    sys.<span class="keyword">exit</span>(app.exec_())</div></pre></td></tr></table></figure>]]></content>
      
        <categories>
            
            <category> 技术 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Python </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Mysql主从复制及读写分离的实现-MyCat]]></title>
      <url>/2016/03/10/Mysql-Master-slave-Read-Write-Splitting-MyCat/</url>
      <content type="html"><![CDATA[<h1 id="MyCat介绍"><a href="#MyCat介绍" class="headerlink" title="MyCat介绍"></a>MyCat介绍</h1><h2 id="什么是MyCat"><a href="#什么是MyCat" class="headerlink" title="什么是MyCat"></a>什么是MyCat</h2><ul>
<li>一个彻底开源的，面向企业应用开发的大数据库集群</li>
<li>支持事务、ACID、可以替代MySQL的加强版数据库</li>
<li>一个可以视为MySQL集群的企业级数据库，用来替代昂贵的Oracle集群</li>
<li>一个融合内存缓存技术、NoSQL技术、HDFS大数据的新型SQL Server</li>
<li>结合传统数据库和新型分布式数据仓库的新一代企业级数据库产品</li>
<li>一个新颖的数据库中间件产品</li>
</ul>
<p>MyCat官网：<a href="http://www.mycat.org.cn/" target="_blank" rel="external">http://www.mycat.org.cn/</a></p>
<h2 id="优势"><a href="#优势" class="headerlink" title="优势"></a>优势</h2><p>copy官方的说明：<br>基于阿里开源的Cobar产品而研发，Cobar的稳定性、可靠性、优秀的架构和性能以及众多成熟的使用案例使得MYCAT一开始就拥有一个很好的起点，站在巨人的肩膀上，我们能看到更远。业界优秀的开源项目和创新思路被广泛融入到MYCAT的基因中，使得MYCAT在很多方面都领先于目前其他一些同类的开源项目，甚至超越某些商业产品。</p>
<p>MYCAT背后有一支强大的技术团队，其参与者都是5年以上资深软件工程师、架构师、DBA等，优秀的技术团队保证了MYCAT的产品质量。</p>
<p>MYCAT并不依托于任何一个商业公司，因此不像某些开源项目，将一些重要的特性封闭在其商业产品中，使得开源项目成了一个摆设（猜测是说的淘宝的TDDL，只开源动态数据源，分表分库部分还未开源）。</p>
<a id="more"></a>
<h1 id="Mysql主从配置"><a href="#Mysql主从配置" class="headerlink" title="Mysql主从配置"></a>Mysql主从配置</h1><p>##环境介绍：</p>
<p>两台Mysql数据库实现主从配置<br>Mycat:172.16.14.1<br>Mysql Master:172.16.14.2<br>Mysql Slave:172.16.14.3</p>
<p>##在Master服务器上安装并配置Mysql</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">#安装Mysql并加入到系统服务</div><div class="line">[root@master ~]# tar xf mysql-<span class="number">5.6</span>.<span class="number">13</span>-linux-glibc2.<span class="number">5</span>-x86_64.tar.gz -C /usr/local/</div><div class="line">[root@master ~]# <span class="keyword">cd</span> /usr/local/</div><div class="line">[root@master local]# <span class="keyword">ln</span> -s mysql-<span class="number">5.6</span>.<span class="number">13</span>-linux-glibc2.<span class="number">5</span>-x86_64 mysql</div><div class="line">[root@master local]# <span class="keyword">cd</span> mysql</div><div class="line">[root@master mysql]# <span class="keyword">cp</span> support-<span class="keyword">files</span>/mysql.server /etc/init.d/mysqld</div><div class="line">[root@master mysql]# chmod +<span class="keyword">x</span> /etc/init.d/mysqld</div><div class="line">[root@master mysql]# chkconfig --<span class="built_in">add</span> mysqld</div><div class="line">[root@master mysql]# <span class="keyword">echo</span> <span class="string">"PATH=/usr/local/mysql/bin:$PATH"</span> &gt;&gt; /etc/<span class="keyword">profile</span></div><div class="line">[root@master mysql]# . /etc/<span class="keyword">profile</span></div></pre></td></tr></table></figure>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line">#提供主配置文件</div><div class="line">[root@master mysql]# <span class="keyword">vim</span> /etc/my.<span class="keyword">cnf</span></div><div class="line">[client]</div><div class="line">#定义mysql client的密码</div><div class="line">#password       = your_password</div><div class="line">port            = <span class="number">3306</span></div><div class="line">socket          = /tmp/mysql.sock</div><div class="line">[mysqld]</div><div class="line">port            = <span class="number">3306</span></div><div class="line">socket          = /tmp/mysql.sock</div><div class="line">skip-external-locking</div><div class="line">key_buffer_size = <span class="number">256</span>M</div><div class="line">max_allowed_packet = <span class="number">1</span>M</div><div class="line">table_open_cache = <span class="number">256</span></div><div class="line">sort_buffer_size = <span class="number">1</span>M</div><div class="line">read_buffer_size = <span class="number">1</span>M</div><div class="line">read_rnd_buffer_size = <span class="number">4</span>M</div><div class="line">myisam_sort_buffer_size = <span class="number">64</span>M</div><div class="line">thread_cache_size = <span class="number">8</span></div><div class="line">query_cache_size= <span class="number">16</span>M</div><div class="line">thread_concurrency = <span class="number">8</span></div><div class="line">binlog-format=ROW</div><div class="line">#开启GTID模式</div><div class="line"><span class="built_in">log</span>-slave-updates=true</div><div class="line">gtid-<span class="keyword">mode</span>=<span class="keyword">on</span></div><div class="line">enforce-gtid-consistency=true</div><div class="line"></div><div class="line">master-info-repository=TABLE</div><div class="line">relay-<span class="built_in">log</span>-info-repository=TABLE</div><div class="line"><span class="keyword">sync</span>-master-info=<span class="number">1</span></div><div class="line">slave-parallel-workers=<span class="number">2</span></div><div class="line">binlog-checksum=CRC32</div><div class="line">master-verify-checksum=<span class="number">1</span></div><div class="line">slave-sql-verify-checksum=<span class="number">1</span></div><div class="line">binlog-rows-query-log_events=<span class="number">1</span></div><div class="line">report-port=<span class="number">3306</span></div><div class="line">datadir=/data</div><div class="line">report-host=<span class="number">172.16</span>.<span class="number">14.2</span></div><div class="line"><span class="built_in">log</span>-bin=mysql-bin</div><div class="line">server-id       = <span class="number">10</span></div><div class="line">[mysqldump]</div><div class="line">quick</div><div class="line">max_allowed_packet = <span class="number">16</span>M</div><div class="line">[mysql]</div><div class="line"><span class="keyword">no</span>-auto-rehash</div><div class="line">[myisamchk]</div><div class="line">key_buffer_size = <span class="number">128</span>M</div><div class="line">sort_buffer_size = <span class="number">128</span>M</div><div class="line">read_buffer = <span class="number">2</span>M</div><div class="line">write_buffer = <span class="number">2</span>M</div><div class="line">[mysqlhotcopy]</div><div class="line">interactive-timeout</div></pre></td></tr></table></figure>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">#初始化Mysql</div><div class="line">[root@master mysql]# useradd -r mysql</div><div class="line">[root@master mysql]# <span class="built_in">mkdir</span> /data</div><div class="line">[root@master mysql]# chown -R mysql.mysql /data</div><div class="line">[root@master mysql]# chown -R root.mysql /usr/local/mysql/*</div><div class="line">[root@master mysql]# ./scripts/mysql_install_db --user=mysql --datadir=/data/</div><div class="line">[root@master ~]# service mysqld start</div></pre></td></tr></table></figure>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">#在Slave服务器上安装Mysql与在Master服务器上安装方法相同，而在Slave服务器上安装Mysql有两个参数与Master服务器不同；如下</div><div class="line">server-id=<span class="number">11</span></div><div class="line">report-host=<span class="number">172.16</span>.<span class="number">14.3</span></div><div class="line">[root@slave ~]# service mysqld start</div></pre></td></tr></table></figure>
<p>##在Master服务器上为Slave创建复制用户并测试连接<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@master ~]# mysql</div><div class="line">mysql&gt; grant replication slave,replication client on *.* to 'slave'@'172.16.%.%' identified by 'passwd';</div><div class="line">mysql&gt; flush privileges;</div><div class="line">------------------------------------------------------------------------</div><div class="line">######测试连接</div><div class="line">[root@slave ~]# mysql -uslave -ppasswd -h <span class="number">172.16</span>.<span class="number">14.2</span></div></pre></td></tr></table></figure></p>
<p>##启动从节点的复制线程<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">[root@slave ~]# mysql</div><div class="line">mysql&gt; change master to master_host='172.16.14.2',master_user='slave',master_password='passwd',master_auto_position=1;</div><div class="line">mysql&gt; start slave;</div><div class="line">mysql&gt; show slave status\G;</div><div class="line">*************************** <span class="number">1</span>. row ***************************</div><div class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master <span class="keyword">to</span> send event</div><div class="line">                  Master_Hos<span class="variable">t:</span> <span class="number">172.16</span>.<span class="number">14.2</span></div><div class="line">                  Master_User: slave</div><div class="line">                  Master_Por<span class="variable">t:</span> <span class="number">3306</span></div><div class="line">                Connect_Retry: <span class="number">60</span></div><div class="line">              Master_Log_File: mysql-bin.<span class="number">000005</span></div><div class="line">          Read_Master_Log_Po<span class="variable">s:</span> <span class="number">191</span></div><div class="line">               Relay_Log_File: slave-relay-bin.<span class="number">000003</span></div><div class="line">                Relay_Log_Po<span class="variable">s:</span> <span class="number">401</span></div><div class="line">        Relay_Master_Log_File: mysql-bin.<span class="number">000005</span></div><div class="line">             Slave_IO_Runnin<span class="variable">g:</span> Yes      #主要看这两项为“YES”说明成功</div><div class="line">            Slave_SQL_Runnin<span class="variable">g:</span> Yes</div></pre></td></tr></table></figure></p>
<p>##在Master服务器创建数据库查看Slave服务器是否更新<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[root@master ~]# mysql -<span class="keyword">e</span> <span class="string">'create database allen;'</span></div><div class="line">------------------------------------------------------------------------</div><div class="line">[root@slave ~]# mysql -<span class="keyword">e</span> <span class="string">'show databases;'</span></div><div class="line">+--------------------+</div><div class="line">| Database           |</div><div class="line">+--------------------+</div><div class="line">| information_schema |</div><div class="line">| allen              |</div><div class="line">| mysql              |</div><div class="line">| performance_schema |</div><div class="line">| test               |</div><div class="line">+--------------------+</div><div class="line">#由上可见，新创建的<span class="string">"allen"</span>数据库已成功同步</div></pre></td></tr></table></figure></p>
<p>至此Mysql 5.6 基于GTID的复制已经完成，下面将介绍如何基于Mysql的主从复制架构做读写分离</p>
<p>#读写分离配置<br>基于前面做的Mysql主从架构，然后在前端加一台服务器，用于实现Mysql的读写分离，IP地址为：172.16.14.1；由于Mycat是java程序所研发，所以需要先安装JDK程序</p>
<p>##安装JDK<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[root@amoeba ~]# tar xzvf jdk-<span class="number">7</span>u72-linux-x64.tar.gz</div><div class="line">[root@amoeba ~]# chown -R /usr/local/java</div><div class="line">[root@amoeba ~]# mv jdk1.<span class="number">7.0</span>_72 /usr/local/java</div><div class="line">[root@amoeba ~]# <span class="keyword">vim</span> /etc/<span class="keyword">profile</span></div><div class="line">export JAVA_HOME=/usr/local/java/jdk1.<span class="number">7.0</span>_72</div><div class="line">export CLASSPATH=.:$JAVA_HOME/jre/lib/rt.jar:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar</div><div class="line">export PATH=$PATH:$JAVA_HOME/bin</div><div class="line">[root@amoeba ~]# <span class="keyword">source</span> /etc/<span class="keyword">profile</span></div><div class="line">[root@amoeba ~]# java -<span class="keyword">version</span></div><div class="line">java <span class="keyword">version</span> <span class="string">"1.7.0_72"</span></div><div class="line">Java(TM) SE Runtime Environment (build <span class="number">1.7</span>.<span class="number">0</span>_72-b14)</div><div class="line">Java HotSpot(TM) <span class="number">64</span>-Bit Server VM (build <span class="number">24.72</span>-b04, mixed <span class="keyword">mode</span>)</div></pre></td></tr></table></figure></p>
<p>##安装MyCat<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@amoeba ~]# tar xzvf Mycat-server-<span class="number">1.5</span>-RELEASE-<span class="number">20160309173032</span>-linux.tar.gz </div><div class="line">[root@amoeba ~]# mv Mycat /usr/local/</div></pre></td></tr></table></figure></p>
<p>##授权Mysql用户，用于实现前端MyCat连接<br>由于上面授权的主从复制帐号不能同步”mysql”数据库，所以用户名也无法同步，要在两台数据库上同时授权，用户名密码保持一致</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">#主mysql</div><div class="line">[root@master ~]# mysql</div><div class="line">mysql&gt; grant all on *.* to 'mycat'@'172.16.%.%' identified by '123456';</div><div class="line">mysql&gt; flush privileges;</div><div class="line"></div><div class="line">#备mysql</div><div class="line">[root@slave ~]# mysql</div><div class="line">mysql&gt; grant all on *.* to 'mycat'@'172.16.%.%' identified by '123456';</div><div class="line">mysql&gt; flush privileges;</div></pre></td></tr></table></figure>
<p>##配置MyCat<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">[root@mycat ~]# <span class="keyword">cd</span> /usr/local/mycat/<span class="keyword">conf</span>/  #主要配置文件为以下两个</div><div class="line">schema.xml        #定义数据库读写分离及节点管理信息等</div><div class="line">server.xml        #保存了所有mycat需要的系统配置信息,mycat服务用户密码等</div><div class="line"></div><div class="line">[root@mycat ~]# <span class="keyword">vi</span> schema.xml</div><div class="line">&lt;?xml <span class="keyword">version</span>=<span class="string">"1.0"</span>?&gt;</div><div class="line">&lt;!DOCTYPE myca<span class="variable">t:schema</span> SYSTEM <span class="string">"schema.dtd"</span>&gt;</div><div class="line">&lt;myca<span class="variable">t:schema</span> xmln<span class="variable">s:mycat</span>=<span class="string">"http://org.opencloudb/"</span>&gt;</div><div class="line"></div><div class="line">&lt;!--schema标签用于定义MyCat实例中的逻辑库，MyCat可有多个逻辑库，每个逻辑库都有自己的相关配置。可以使用 schema 标签来划分不同的逻辑库。--&gt;</div><div class="line">&lt;!--这里定义一个TESTDB的逻辑库，包含dn1这个分片 --&gt;</div><div class="line">	&lt;schema name=<span class="string">"TESTDB"</span> checkSQLschema=<span class="string">"false"</span> sqlMaxLimit=<span class="string">"100"</span> dataNode=<span class="string">"dn1"</span>&gt;</div><div class="line">	    &lt;!--可配置分片规则,user表根据latest-month-calldate规则分片到dn2,dn3节点，其他没定义的表默认在dn1节点--&gt; </div><div class="line">		&lt;!-- auto sharding by id (long) --&gt;</div><div class="line">		&lt;!-- &lt;table name=<span class="string">"user"</span> primaryKey=<span class="string">"ID"</span> dataNode=<span class="string">"dn2，dn3"</span> rule=<span class="string">"latest-month-calldate"</span> /&gt; --&gt;</div><div class="line">	&lt;/schema&gt;</div><div class="line">	</div><div class="line">	&lt;!--定义数据分片节点，使用名字为localhost1库实例上的wytest物理数据库，就组成一个数据分片，可配置多个 --&gt;</div><div class="line">	&lt;dataNode name=<span class="string">"dn1"</span> dataHost=<span class="string">"localhost1"</span> database=<span class="string">"wytest"</span> /&gt;</div><div class="line">	&lt;!--&lt;dataNode name=<span class="string">"dn4"</span> dataHost=<span class="string">"sequoiadb1"</span> database=<span class="string">"SAMPLE"</span> /&gt;</div><div class="line">	 &lt;dataNode name=<span class="string">"jdbc_dn1"</span> dataHost=<span class="string">"jdbchost"</span> database=<span class="string">"db1"</span> /&gt; </div><div class="line">	&lt;dataNode	name=<span class="string">"jdbc_dn2"</span> dataHost=<span class="string">"jdbchost"</span> database=<span class="string">"db2"</span> /&gt; </div><div class="line">	&lt;dataNode name=<span class="string">"jdbc_dn3"</span> 	dataHost=<span class="string">"jdbchost"</span> database=<span class="string">"db3"</span> /&gt; --&gt;</div><div class="line">	</div><div class="line">	&lt;!--定义具体的数据实例--&gt;</div><div class="line">	&lt;!--balance 负载均衡类型，目前的取值有 <span class="number">3</span> 种：</div><div class="line">     <span class="number">1</span>. balance=<span class="string">"0"</span>,不开启读写分离机制，所有读操作都发送到当前可用的writeHost上。</div><div class="line">     <span class="number">2</span>. balance=<span class="string">"1"</span>，全部的readHost与stand by writeHost参与select查询的负载均衡，简单的说，当双主双从模式(M1-&gt;S1，M2-&gt;S2，并且M1与M2互为主备)，正常情冴下，M2,S1,S2 都参不 select 查询的负载均衡。</div><div class="line">     <span class="number">3</span>. balance=<span class="string">"2"</span>，所有读操作都随机的在 writeHost、readhost 上分发。</div><div class="line">     <span class="number">4</span>. balance=<span class="string">"3"</span>，所有读请求随机的分发到wiriterHost对应的readhost执行，writerHost不负担读压力，注意 balance=<span class="number">3</span> 叧在 <span class="number">1.4</span> 及其以后版本有，<span class="number">1.3</span> 没有。--&gt;</div><div class="line">	&lt;dataHost name=<span class="string">"localhost1"</span> maxCon=<span class="string">"1000"</span> minCon=<span class="string">"10"</span> balance=<span class="string">"1"</span></div><div class="line">		writeType=<span class="string">"0"</span> dbType=<span class="string">"mysql"</span> dbDriver=<span class="string">"native"</span> switchType=<span class="string">"1"</span>  slaveThreshold=<span class="string">"100"</span>&gt;</div><div class="line">		<span class="symbol">&lt;heartbeat&gt;</span>select user()&lt;/heartbeat&gt;</div><div class="line">		&lt;!-- can have multi <span class="keyword">write</span> hosts --&gt;</div><div class="line">		&lt;!--在一个dataHost内可定义多个writeHost和readHost。但是，如果writeHost指定的后端数据库宕机，那么这个writeHost绑定的所有readHost都将不可用。另一方面，由于这个writeHost宕机，系统会自动的检测到，并切换到备用的writeHost上去--&gt;</div><div class="line">		&lt;writeHost host=<span class="string">"hostM1"</span> url=<span class="string">"172.16.14.2:3306"</span> user=<span class="string">"mycat"</span> password=<span class="string">"123456"</span>&gt;</div><div class="line">		&lt;!-- can have multi <span class="keyword">read</span> hosts --&gt;</div><div class="line">        &lt;readHost host=<span class="string">"hostS1"</span> url=<span class="string">"172.16.14.3:3306"</span> user=<span class="string">"mycat"</span> password=<span class="string">"123456"</span> /&gt;</div><div class="line">		&lt;/writeHost&gt;</div><div class="line">		&lt;!-- &lt;writeHost host=<span class="string">"hostM2"</span> url=<span class="string">"localhost:3316"</span> user=<span class="string">"root"</span> password=<span class="string">"123456"</span>/&gt; --&gt;</div><div class="line">	&lt;/dataHost&gt;</div><div class="line">&lt;/myca<span class="variable">t:schema</span>&gt;</div></pre></td></tr></table></figure></p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line">[root@mycat ~]# <span class="keyword">vi</span> server.xml</div><div class="line">&lt;?xml <span class="keyword">version</span>=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</div><div class="line">&lt;!DOCTYPE myca<span class="variable">t:server</span> SYSTEM <span class="string">"server.dtd"</span>&gt;</div><div class="line">&lt;myca<span class="variable">t:server</span> xmln<span class="variable">s:mycat</span>=<span class="string">"http://org.opencloudb/"</span>&gt;</div><div class="line">	<span class="symbol">&lt;system&gt;</span></div><div class="line">	&lt;property name=<span class="string">"defaultSqlParser"</span>&gt;druidparser&lt;/property&gt;</div><div class="line">      &lt;!--  &lt;property name=<span class="string">"useCompression"</span>&gt;<span class="number">1</span>&lt;/property&gt;--&gt; &lt;!--<span class="number">1</span>为开启mysql压缩协议--&gt;</div><div class="line">	&lt;!-- &lt;property name=<span class="string">"processorBufferChunk"</span>&gt;<span class="number">40960</span>&lt;/property&gt; --&gt;</div><div class="line">	&lt;!-- </div><div class="line">	&lt;property name=<span class="string">"processors"</span>&gt;<span class="number">1</span>&lt;/property&gt; </div><div class="line">	&lt;property name=<span class="string">"processorExecutor"</span>&gt;<span class="number">32</span>&lt;/property&gt; </div><div class="line">	 --&gt;</div><div class="line">		&lt;!--默认是<span class="number">65535</span> <span class="number">64</span>K 用于sql解析时最大文本长度 --&gt;</div><div class="line">		&lt;!--&lt;property name=<span class="string">"maxStringLiteralLength"</span>&gt;<span class="number">65535</span>&lt;/property&gt;--&gt;</div><div class="line">		&lt;!--&lt;property name=<span class="string">"sequnceHandlerType"</span>&gt;<span class="number">0</span>&lt;/property&gt;--&gt;</div><div class="line">		&lt;!--&lt;property name=<span class="string">"backSocketNoDelay"</span>&gt;<span class="number">1</span>&lt;/property&gt;--&gt;</div><div class="line">		&lt;!--&lt;property name=<span class="string">"frontSocketNoDelay"</span>&gt;<span class="number">1</span>&lt;/property&gt;--&gt;</div><div class="line">		&lt;!--&lt;property name=<span class="string">"processorExecutor"</span>&gt;<span class="number">16</span>&lt;/property&gt;--&gt;</div><div class="line">		&lt;!-- </div><div class="line">			&lt;property name=<span class="string">"mutiNodeLimitType"</span>&gt;<span class="number">1</span>&lt;/property&gt; <span class="number">0</span>：开启小数量级（默认） ；<span class="number">1</span>：开启亿级数据排序</div><div class="line">	    	&lt;property name=<span class="string">"mutiNodePatchSize"</span>&gt;<span class="number">100</span>&lt;/property&gt; 亿级数量排序批量</div><div class="line">			&lt;property name=<span class="string">"processors"</span>&gt;<span class="number">32</span>&lt;/property&gt;</div><div class="line">			&lt;property name=<span class="string">"processorExecutor"</span>&gt;<span class="number">32</span>&lt;/property&gt; </div><div class="line">			&lt;property name=<span class="string">"serverPort"</span>&gt;<span class="number">8066</span>&lt;/property&gt; </div><div class="line">			&lt;property name=<span class="string">"managerPort"</span>&gt;<span class="number">9066</span>&lt;/property&gt; </div><div class="line">			&lt;property name=<span class="string">"idleTimeout"</span>&gt;<span class="number">300000</span>&lt;/property&gt; </div><div class="line">			&lt;property name=<span class="string">"bindIp"</span>&gt;<span class="number">0.0</span>.<span class="number">0.0</span>&lt;/property&gt; </div><div class="line">			&lt;property name=<span class="string">"frontWriteQueueSize"</span>&gt;<span class="number">4096</span>&lt;/property&gt; </div><div class="line">			&lt;property name=<span class="string">"processors"</span>&gt;<span class="number">32</span>&lt;/property&gt; --&gt;</div><div class="line">	&lt;/<span class="built_in">system</span>&gt;</div><div class="line">	</div><div class="line">	&lt;!--定义test用户，访问TESTDB的逻辑库(schema.xml中定义)--&gt;</div><div class="line">	&lt;user name=<span class="string">"test"</span>&gt;</div><div class="line">		&lt;property name=<span class="string">"password"</span>&gt;test&lt;/property&gt;</div><div class="line">		&lt;property name=<span class="string">"schemas"</span>&gt;TESTDB&lt;/property&gt;</div><div class="line">	&lt;/user&gt;</div><div class="line"></div><div class="line">	&lt;user name=<span class="string">"user"</span>&gt;</div><div class="line">		&lt;property name=<span class="string">"password"</span>&gt;user&lt;/property&gt;</div><div class="line">		&lt;property name=<span class="string">"schemas"</span>&gt;TESTDB&lt;/property&gt;</div><div class="line">		&lt;property name=<span class="string">"readOnly"</span>&gt;true&lt;/property&gt;</div><div class="line">	&lt;/user&gt;</div><div class="line">	</div><div class="line">	&lt;!-- </div><div class="line">	<span class="symbol">&lt;quarantine&gt;</span> </div><div class="line">	   <span class="symbol">&lt;whitehost&gt;</span></div><div class="line">	      &lt;host host=<span class="string">"127.0.0.1"</span> user=<span class="string">"mycat"</span>/&gt;</div><div class="line">	      &lt;host host=<span class="string">"127.0.0.2"</span> user=<span class="string">"mycat"</span>/&gt;</div><div class="line">	   &lt;/whitehost&gt;</div><div class="line">       &lt;blacklist check=<span class="string">"false"</span>&gt;&lt;/blacklist&gt;</div><div class="line">	&lt;/quarantine&gt;</div><div class="line">	--&gt;</div><div class="line">&lt;/myca<span class="variable">t:server</span>&gt;</div></pre></td></tr></table></figure>]]></content>
      
        <categories>
            
            <category> 技术 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Database </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Mysql主从复制及读写分离的实现-Amoeba]]></title>
      <url>/2016/03/05/Mysql-Master-slave-Read-Write-Splitting-Amoeba/</url>
      <content type="html"><![CDATA[<p>#Amoeba简介</p>
<p>Amoeba(变形虫)项目,该开源框架于2008年开始发布一款 Amoeba for Mysql软件。这个软件致力于MySQL的分布式数据库前端代理层，它主要在应用层访问MySQL的 时候充当SQL路由功能，专注于分布式数据库代理层（Database Proxy）开发。座落与 Client、DB Server(s)之间,对客户端透明。具有负载均衡、高可用性、SQL 过滤、读写分离、可路由相关的到目标数据库、可并发请求多台数据库合并结果。 通过Amoeba你能够完成多数据源的高可用、负载均衡、数据切片的功能，目前Amoeba已在很多企业的生产线上面使用</p>
<p>Amoeba优缺点<br>优点：<br>1、降低费用，简单易用<br>2、提高系统整体可用性<br>3、易于扩展处理能力与系统规模<br>4、可以直接实现读写分离及负载均衡效果，而不用修改代码<br>缺点：<br>1、不支持事务与存储过程<br>2、暂不支持分库分表，amoeba目前只做到分数据库实例<br>3、不适合从amoeba导数据的场景或者对大数据量查询的query并不合适（比如一次请求返回10w以上甚至更多数据的场合）</p>
<p>Mysql GTID<br>Mysql 5.6的新特性之一，加入了全局事务性ID(GTID:Global Transactions Identifier)来强化数据库的主备一致性，故障恢复，以及容错能力;也使得复制功能的配置、监控及管理变得更加易于实现，且更加健壮。</p>
<a id="more"></a>
<p>#Mysql主从配置</p>
<p>##环境介绍：<br>两台Mysql数据库实现主从配置<br>Amoeba:172.16.14.1<br>Mysql Master:172.16.14.2<br>Mysql Slave:172.16.14.3</p>
<p>##在Master服务器上安装并配置Mysql<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">#安装Mysql并加入到系统服务</div><div class="line">[root@master ~]# tar xf mysql-<span class="number">5.6</span>.<span class="number">13</span>-linux-glibc2.<span class="number">5</span>-x86_64.tar.gz -C /usr/local/</div><div class="line">[root@master ~]# <span class="keyword">cd</span> /usr/local/</div><div class="line">[root@master local]# <span class="keyword">ln</span> -s mysql-<span class="number">5.6</span>.<span class="number">13</span>-linux-glibc2.<span class="number">5</span>-x86_64 mysql</div><div class="line">[root@master local]# <span class="keyword">cd</span> mysql</div><div class="line">[root@master mysql]# <span class="keyword">cp</span> support-<span class="keyword">files</span>/mysql.server /etc/init.d/mysqld</div><div class="line">[root@master mysql]# chmod +<span class="keyword">x</span> /etc/init.d/mysqld</div><div class="line">[root@master mysql]# chkconfig --<span class="built_in">add</span> mysqld</div><div class="line">[root@master mysql]# <span class="keyword">echo</span> <span class="string">"PATH=/usr/local/mysql/bin:$PATH"</span> &gt;&gt; /etc/<span class="keyword">profile</span></div><div class="line">[root@master mysql]# . /etc/<span class="keyword">profile</span></div></pre></td></tr></table></figure></p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line">#提供主配置文件</div><div class="line">[root@master mysql]# <span class="keyword">vim</span> /etc/my.<span class="keyword">cnf</span></div><div class="line">[client]</div><div class="line">#password       = your_password</div><div class="line">port            = <span class="number">3306</span></div><div class="line">socket          = /tmp/mysql.sock</div><div class="line">[mysqld]</div><div class="line">port            = <span class="number">3306</span></div><div class="line">socket          = /tmp/mysql.sock</div><div class="line">skip-external-locking</div><div class="line">key_buffer_size = <span class="number">256</span>M</div><div class="line">max_allowed_packet = <span class="number">1</span>M</div><div class="line">table_open_cache = <span class="number">256</span></div><div class="line">sort_buffer_size = <span class="number">1</span>M</div><div class="line">read_buffer_size = <span class="number">1</span>M</div><div class="line">read_rnd_buffer_size = <span class="number">4</span>M</div><div class="line">myisam_sort_buffer_size = <span class="number">64</span>M</div><div class="line">thread_cache_size = <span class="number">8</span></div><div class="line">query_cache_size= <span class="number">16</span>M</div><div class="line">thread_concurrency = <span class="number">8</span></div><div class="line">binlog-format=ROW</div><div class="line"><span class="built_in">log</span>-slave-updates=true</div><div class="line">gtid-<span class="keyword">mode</span>=<span class="keyword">on</span></div><div class="line">enforce-gtid-consistency=true</div><div class="line">master-info-repository=TABLE</div><div class="line">relay-<span class="built_in">log</span>-info-repository=TABLE</div><div class="line"><span class="keyword">sync</span>-master-info=<span class="number">1</span></div><div class="line">slave-parallel-workers=<span class="number">2</span></div><div class="line">binlog-checksum=CRC32</div><div class="line">master-verify-checksum=<span class="number">1</span></div><div class="line">slave-sql-verify-checksum=<span class="number">1</span></div><div class="line">binlog-rows-query-log_events=<span class="number">1</span></div><div class="line">report-port=<span class="number">3306</span></div><div class="line">datadir=/data</div><div class="line">report-host=master.allen.<span class="keyword">com</span></div><div class="line"><span class="built_in">log</span>-bin=mysql-bin</div><div class="line">server-id       = <span class="number">10</span></div><div class="line">[mysqldump]</div><div class="line">quick</div><div class="line">max_allowed_packet = <span class="number">16</span>M</div><div class="line">[mysql]</div><div class="line"><span class="keyword">no</span>-auto-rehash</div><div class="line">[myisamchk]</div><div class="line">key_buffer_size = <span class="number">128</span>M</div><div class="line">sort_buffer_size = <span class="number">128</span>M</div><div class="line">read_buffer = <span class="number">2</span>M</div><div class="line">write_buffer = <span class="number">2</span>M</div><div class="line">[mysqlhotcopy]</div><div class="line">interactive-timeout</div></pre></td></tr></table></figure>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">#初始化Mysql</div><div class="line">[root@master mysql]# useradd -r mysql</div><div class="line">[root@master mysql]# <span class="built_in">mkdir</span> /data</div><div class="line">[root@master mysql]# chown -R mysql.mysql /data</div><div class="line">[root@master mysql]# chown -R root.mysql /usr/local/mysql/*</div><div class="line">[root@master mysql]# ./scripts/mysql_install_db --user=mysql --datadir=/data/</div><div class="line">[root@master ~]# service mysqld start</div></pre></td></tr></table></figure>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">#在Slave服务器上安装Mysql与在Master服务器上安装方法相同，而在Slave服务器上安装Mysql有两个参数与Master服务器不同；如下</div><div class="line">server-id=<span class="number">11</span></div><div class="line">report-host=slave.allen.<span class="keyword">com</span></div><div class="line">[root@slave ~]# service mysqld start</div></pre></td></tr></table></figure>
<p>##在Master服务器上为Slave创建复制用户并测试连接<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@master ~]# mysql</div><div class="line">mysql&gt; grant replication slave,replication client on *.* to 'slave'@'172.16.%.%' identified by 'passwd';</div><div class="line">mysql&gt; flush privileges;</div><div class="line">------------------------------------------------------------------------</div><div class="line">######测试连接</div><div class="line">[root@slave ~]# mysql -uslave -ppasswd -h <span class="number">172.16</span>.<span class="number">14.2</span></div></pre></td></tr></table></figure></p>
<p>##启动从节点的复制线程<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">[root@slave ~]# mysql</div><div class="line">mysql&gt; change master to master_host='172.16.14.2',master_user='slave',master_password='passwd',master_auto_position=1;</div><div class="line">mysql&gt; start slave;</div><div class="line">mysql&gt; show slave status\G;</div><div class="line">*************************** <span class="number">1</span>. row ***************************</div><div class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master <span class="keyword">to</span> send event</div><div class="line">                  Master_Hos<span class="variable">t:</span> <span class="number">172.16</span>.<span class="number">14.2</span></div><div class="line">                  Master_User: slave</div><div class="line">                  Master_Por<span class="variable">t:</span> <span class="number">3306</span></div><div class="line">                Connect_Retry: <span class="number">60</span></div><div class="line">              Master_Log_File: mysql-bin.<span class="number">000005</span></div><div class="line">          Read_Master_Log_Po<span class="variable">s:</span> <span class="number">191</span></div><div class="line">               Relay_Log_File: slave-relay-bin.<span class="number">000003</span></div><div class="line">                Relay_Log_Po<span class="variable">s:</span> <span class="number">401</span></div><div class="line">        Relay_Master_Log_File: mysql-bin.<span class="number">000005</span></div><div class="line">             Slave_IO_Runnin<span class="variable">g:</span> Yes      #主要看这两项为“YES”说明成功</div><div class="line">            Slave_SQL_Runnin<span class="variable">g:</span> Yes</div></pre></td></tr></table></figure></p>
<p>##在Master服务器创建数据库查看Slave服务器是否更新<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[root@master ~]# mysql -<span class="keyword">e</span> <span class="string">'create database allen;'</span></div><div class="line">------------------------------------------------------------------------</div><div class="line">[root@slave ~]# mysql -<span class="keyword">e</span> <span class="string">'show databases;'</span></div><div class="line">+--------------------+</div><div class="line">| Database           |</div><div class="line">+--------------------+</div><div class="line">| information_schema |</div><div class="line">| allen              |</div><div class="line">| mysql              |</div><div class="line">| performance_schema |</div><div class="line">| test               |</div><div class="line">+--------------------+</div><div class="line">#由上可见，新创建的<span class="string">"allen"</span>数据库已成功同步</div></pre></td></tr></table></figure></p>
<p>至此Mysql 5.6 基于GTID的复制已经完成，下面将介绍如何基于Mysql的主从复制架构做读写分离</p>
<p>#读写分离配置<br>基于前面做的Mysql主从架构，然后在前端加一台服务器，用于实现Mysql的读写分离，IP地址为：172.16.14.1；由于Amoeba是java程序所研发，所以需要先安装JDK程序</p>
<p>##安装JDK<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[root@amoeba ~]# tar xzvf jdk-<span class="number">7</span>u72-linux-x64.tar.gz</div><div class="line">[root@amoeba ~]# chown -R /usr/local/java</div><div class="line">[root@amoeba ~]# mv jdk1.<span class="number">7.0</span>_72 /usr/local/java</div><div class="line">[root@amoeba ~]# <span class="keyword">vim</span> /etc/<span class="keyword">profile</span></div><div class="line">export JAVA_HOME=/usr/local/java/jdk1.<span class="number">7.0</span>_72</div><div class="line">export CLASSPATH=.:$JAVA_HOME/jre/lib/rt.jar:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar</div><div class="line">export PATH=$PATH:$JAVA_HOME/bin</div><div class="line">[root@amoeba ~]# <span class="keyword">source</span> /etc/<span class="keyword">profile</span></div><div class="line">[root@amoeba ~]# java -<span class="keyword">version</span></div><div class="line">java <span class="keyword">version</span> <span class="string">"1.7.0_72"</span></div><div class="line">Java(TM) SE Runtime Environment (build <span class="number">1.7</span>.<span class="number">0</span>_72-b14)</div><div class="line">Java HotSpot(TM) <span class="number">64</span>-Bit Server VM (build <span class="number">24.72</span>-b04, mixed <span class="keyword">mode</span>)</div></pre></td></tr></table></figure></p>
<p>##安装Amoeba<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@amoeba ~]# unzip amoeba-mysql-<span class="number">3.0</span>.<span class="number">5</span>-RC-distribution.zip </div><div class="line">[root@amoeba ~]# mv amoeba /usr/local/</div></pre></td></tr></table></figure></p>
<p>##授权Mysql用户，用于实现前端Amoeba连接<br>由于上面授权的主从复制帐号不能同步”mysql”数据库，所以用户名也无法同步，要在两台数据库上同时授权，用户名密码保持一致</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">#主mysql</div><div class="line">[root@master ~]# mysql</div><div class="line">mysql&gt; grant all on *.* to 'amoeba'@'172.16.%.%' identified by 'amoebapass';</div><div class="line">mysql&gt; flush privileges;</div><div class="line"></div><div class="line">#备mysql</div><div class="line">[root@slave ~]# mysql</div><div class="line">mysql&gt; grant all on *.* to 'amoeba'@'172.16.%.%' identified by 'amoebapass';</div><div class="line">mysql&gt; flush privileges;</div></pre></td></tr></table></figure>
<p>##配置Amoeba<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line">[root@amoeba ~]# <span class="keyword">cd</span> /usr/local/amoeba/<span class="keyword">conf</span>/  #主要配置文件为以下两个</div><div class="line">amoeba.xml        #定义数据库读写分离及节点管理信息等</div><div class="line">dbServers.xml     #定义连接后端Mysql服务器信息</div><div class="line">------------------------------------------------------------------------</div><div class="line">[root@amoeba <span class="keyword">conf</span>]# <span class="keyword">vim</span> dbServers.xml</div><div class="line">&lt;?xml <span class="keyword">version</span>=<span class="string">"1.0"</span> encoding=<span class="string">"gbk"</span>?&gt;</div><div class="line">&lt;!DOCTYPE amoeb<span class="variable">a:dbServers</span> SYSTEM <span class="string">"dbserver.dtd"</span>&gt;</div><div class="line">&lt;amoeb<span class="variable">a:dbServers</span> xmln<span class="variable">s:amoeba</span>=<span class="string">"http://amoeba.meidusa.com/"</span>&gt;</div><div class="line">        &lt;!--</div><div class="line">            Each dbServer needs <span class="keyword">to</span> <span class="keyword">be</span> configured into <span class="keyword">a</span> Pool,</div><div class="line">            If you need <span class="keyword">to</span> configure multiple dbServer with load balancing that can <span class="keyword">be</span> simplified by the following configuration:</div><div class="line">             <span class="built_in">add</span> attribute with name virtual = <span class="string">"true"</span> in dbServer, but the configuration does not allow the element with name factoryConfig</div><div class="line">             such <span class="keyword">as</span> <span class="string">'multiPool'</span> dbServer</div><div class="line">        --&gt;</div><div class="line">    &lt;dbServer name=<span class="string">"abstractServer"</span> abstractive=<span class="string">"true"</span>&gt;</div><div class="line">        &lt;factoryConfig class=<span class="string">"com.meidusa.amoeba.mysql.net.MysqlServerConnectionFactory"</span>&gt;</div><div class="line">            &lt;property name=<span class="string">"manager"</span>&gt;$&#123;defaultManager&#125;&lt;/property&gt;</div><div class="line">            &lt;property name=<span class="string">"sendBufferSize"</span>&gt;<span class="number">64</span>&lt;/property&gt;</div><div class="line">            &lt;property name=<span class="string">"receiveBufferSize"</span>&gt;<span class="number">128</span>&lt;/property&gt;</div><div class="line">            &lt;!-- mysql port --&gt;</div><div class="line">            &lt;property name=<span class="string">"port"</span>&gt;<span class="number">3306</span>&lt;/property&gt;</div><div class="line">            #连接后端Mysql服务器端口</div><div class="line">            &lt;!-- mysql schema --&gt;</div><div class="line">            &lt;property name=<span class="string">"schema"</span>&gt;test&lt;/property&gt;</div><div class="line">            #连接到后端Mysql使用的默认数据库</div><div class="line">            &lt;!-- mysql user --&gt;</div><div class="line">            &lt;property name=<span class="string">"user"</span>&gt;amoeba&lt;/property&gt;</div><div class="line">            #连接后端Mysql数据库的用户名</div><div class="line">            &lt;property name=<span class="string">"password"</span>&gt;amoebapass&lt;/property&gt;</div><div class="line">                #连接后端Mysql数据库的用户名</div><div class="line">        &lt;/factoryConfig&gt;</div><div class="line">        &lt;poolConfig class=<span class="string">"com.meidusa.amoeba.net.poolable.PoolableObjectPool"</span>&gt;</div><div class="line">            &lt;property name=<span class="string">"maxActive"</span>&gt;<span class="number">500</span>&lt;/property&gt;</div><div class="line">            &lt;property name=<span class="string">"maxIdle"</span>&gt;<span class="number">500</span>&lt;/property&gt;</div><div class="line">            &lt;property name=<span class="string">"minIdle"</span>&gt;<span class="number">10</span>&lt;/property&gt;</div><div class="line">            &lt;property name=<span class="string">"minEvictableIdleTimeMillis"</span>&gt;<span class="number">600000</span>&lt;/property&gt;</div><div class="line">            &lt;property name=<span class="string">"timeBetweenEvictionRunsMillis"</span>&gt;<span class="number">600000</span>&lt;/property&gt;</div><div class="line">            &lt;property name=<span class="string">"testOnBorrow"</span>&gt;true&lt;/property&gt;</div><div class="line">            &lt;property name=<span class="string">"testOnReturn"</span>&gt;true&lt;/property&gt;</div><div class="line">            &lt;property name=<span class="string">"testWhileIdle"</span>&gt;true&lt;/property&gt;</div><div class="line">        &lt;/poolConfig&gt;</div><div class="line">    &lt;/dbServer&gt;</div><div class="line">                        #定义<span class="string">"master"</span>数据库节点,<span class="string">"name"</span>名称可以自定义</div><div class="line">    &lt;dbServer name=<span class="string">"master"</span>  parent=<span class="string">"abstractServer"</span>&gt;</div><div class="line">        <span class="symbol">&lt;factoryConfig&gt;</span></div><div class="line">            &lt;!-- mysql ip --&gt;</div><div class="line">            &lt;property name=<span class="string">"ipAddress"</span>&gt;<span class="number">172.16</span>.<span class="number">14.2</span>&lt;/property&gt;</div><div class="line">        &lt;/factoryConfig&gt;</div><div class="line">    &lt;/dbServer&gt;</div><div class="line">                       #定义<span class="string">"slave"</span>数据库节点</div><div class="line">    &lt;dbServer name=<span class="string">"slave"</span>  parent=<span class="string">"abstractServer"</span>&gt;</div><div class="line">        <span class="symbol">&lt;factoryConfig&gt;</span></div><div class="line">            &lt;!-- mysql ip --&gt;</div><div class="line">            &lt;property name=<span class="string">"ipAddress"</span>&gt;<span class="number">172.16</span>.<span class="number">14.3</span>&lt;/property&gt;</div><div class="line">        &lt;/factoryConfig&gt;</div><div class="line">    &lt;/dbServer&gt;</div><div class="line"></div><div class="line">    &lt;dbServer name=<span class="string">"multiPool"</span> virtual=<span class="string">"true"</span>&gt;</div><div class="line">        &lt;poolConfig class=<span class="string">"com.meidusa.amoeba.server.MultipleServerPool"</span>&gt;</div><div class="line">            &lt;!-- Load balancing strategy: <span class="number">1</span>=ROUNDROBIN , <span class="number">2</span>=WEIGHTBASED , <span class="number">3</span>=HA--&gt; #这里注释的为算法</div><div class="line">            &lt;property name=<span class="string">"loadbalance"</span>&gt;<span class="number">1</span>&lt;/property&gt;</div><div class="line">            #定义选择哪一种算法进行负载均衡调度</div><div class="line">            &lt;!-- Separated by commas,such <span class="keyword">a</span><span class="variable">s:</span> server1,server2,server1 --&gt;</div><div class="line">#定义数据库池,用于实现负载均衡."slave"为上面定义的从数据库节点，可以写多个用","分隔;</div><div class="line">如:"slave,slave,master"可以实现基于权重负载的效果;当然这里也可以不用定义</div><div class="line">            &lt;property name=<span class="string">"poolNames"</span>&gt;slave&lt;/property&gt;</div><div class="line">        &lt;/poolConfig&gt;</div><div class="line">    &lt;/dbServer&gt;</div><div class="line">&lt;/amoeb<span class="variable">a:dbServers</span>&gt;</div></pre></td></tr></table></figure></p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div></pre></td><td class="code"><pre><div class="line">========================================================================</div><div class="line">[root@amoeba <span class="keyword">conf</span>]# <span class="keyword">vim</span> amoeba.xml</div><div class="line">&lt;?xml <span class="keyword">version</span>=<span class="string">"1.0"</span> encoding=<span class="string">"gbk"</span>?&gt;</div><div class="line">&lt;!DOCTYPE amoeb<span class="variable">a:configuration</span> SYSTEM <span class="string">"amoeba.dtd"</span>&gt;</div><div class="line">&lt;amoeb<span class="variable">a:configuration</span> xmln<span class="variable">s:amoeba</span>=<span class="string">"http://amoeba.meidusa.com/"</span>&gt;</div><div class="line">    <span class="symbol">&lt;proxy&gt;</span></div><div class="line">        &lt;!-- service class must implements <span class="keyword">com</span>.meidusa.amoeba.service.Service --&gt;</div><div class="line">&lt;service name=<span class="string">"Amoeba for Mysql"</span> class=<span class="string">"com.meidusa.amoeba.net.ServerableConnectionManager"</span>&gt;</div><div class="line">            &lt;!-- port --&gt; #定义amoeba代理服务器的对外连接监听端口</div><div class="line">            &lt;property name=<span class="string">"port"</span>&gt;<span class="number">3306</span>&lt;/property&gt;   </div><div class="line">            &lt;!-- bind ipAddress --&gt; #定义amoeba代理服务器对外连接的监听IP</div><div class="line">            &lt;property name=<span class="string">"ipAddress"</span>&gt;<span class="number">172.16</span>.<span class="number">14.1</span>&lt;/property&gt;   </div><div class="line">            &lt;property name=<span class="string">"manager"</span>&gt;$&#123;clientConnectioneManager&#125;&lt;/property&gt;</div><div class="line">            &lt;property name=<span class="string">"connectionFactory"</span>&gt;</div><div class="line">                &lt;bean class=<span class="string">"com.meidusa.amoeba.mysql.net.MysqlClientConnectionFactory"</span>&gt;</div><div class="line">                    &lt;property name=<span class="string">"sendBufferSize"</span>&gt;<span class="number">128</span>&lt;/property&gt;</div><div class="line">                    &lt;property name=<span class="string">"receiveBufferSize"</span>&gt;<span class="number">64</span>&lt;/property&gt;</div><div class="line">                &lt;/bean&gt;</div><div class="line">            &lt;/property&gt;   </div><div class="line">            &lt;property name=<span class="string">"authenticator"</span>&gt;</div><div class="line">                &lt;bean class=<span class="string">"com.meidusa.amoeba.mysql.server.MysqlClientAuthenticator"</span>&gt;             </div><div class="line">    #定义amoeba连接用户名和密码，客户端或程序只需要使用此用户名和密码连接即可</div><div class="line">                    &lt;property name=<span class="string">"user"</span>&gt;admin&lt;/property&gt;         </div><div class="line">                    &lt;property name=<span class="string">"password"</span>&gt;password&lt;/property&gt;           </div><div class="line">                    &lt;property name=<span class="string">"filter"</span>&gt;</div><div class="line">                        &lt;bean class=<span class="string">"com.meidusa.amoeba.server.IPAccessController"</span>&gt;</div><div class="line">                    &lt;property name=<span class="string">"ipFile"</span>&gt;$&#123;amoeba.home&#125;/<span class="keyword">conf</span>/access_list.<span class="keyword">conf</span>&lt;/property&gt;</div><div class="line">                        &lt;/bean&gt;</div><div class="line">                    &lt;/property&gt;</div><div class="line">                &lt;/bean&gt;</div><div class="line">            &lt;/property&gt;   </div><div class="line">        &lt;/service&gt;</div><div class="line">        &lt;!-- server class must implements <span class="keyword">com</span>.meidusa.amoeba.service.Service --&gt;</div><div class="line">        &lt;service name=<span class="string">"Amoeba Monitor Server"</span> class=<span class="string">"com.meidusa.amoeba.monitor.MonitorServer"</span>&gt;</div><div class="line">            &lt;!-- port --&gt;</div><div class="line">            &lt;!--  default value: random <span class="keyword">number</span></div><div class="line">            &lt;property name=<span class="string">"port"</span>&gt;<span class="number">9066</span>&lt;/property&gt;</div><div class="line">            --&gt;</div><div class="line">            &lt;!-- bind ipAddress --&gt;</div><div class="line">            &lt;property name=<span class="string">"ipAddress"</span>&gt;<span class="number">127.0</span>.<span class="number">0.1</span>&lt;/property&gt;</div><div class="line">            &lt;property name=<span class="string">"daemon"</span>&gt;true&lt;/property&gt;</div><div class="line">            &lt;property name=<span class="string">"manager"</span>&gt;$&#123;clientConnectioneManager&#125;&lt;/property&gt;</div><div class="line">            &lt;property name=<span class="string">"connectionFactory"</span>&gt;</div><div class="line">            &lt;bean class=<span class="string">"com.meidusa.amoeba.monitor.net.MonitorClientConnectionFactory"</span>&gt;&lt;/bean&gt;</div><div class="line">            &lt;/property&gt;   </div><div class="line">        &lt;/service&gt;</div><div class="line">        &lt;<span class="keyword">runtime</span> class=<span class="string">"com.meidusa.amoeba.mysql.context.MysqlRuntimeContext"</span>&gt;</div><div class="line">            &lt;!-- proxy server net IO Read thread size --&gt;</div><div class="line">            &lt;property name=<span class="string">"readThreadPoolSize"</span>&gt;<span class="number">20</span>&lt;/property&gt;   </div><div class="line">            &lt;!-- proxy server client process thread size --&gt;</div><div class="line">            &lt;property name=<span class="string">"clientSideThreadPoolSize"</span>&gt;<span class="number">30</span>&lt;/property&gt;</div><div class="line">            &lt;!-- mysql server data packet process thread size --&gt;</div><div class="line">            &lt;property name=<span class="string">"serverSideThreadPoolSize"</span>&gt;<span class="number">30</span>&lt;/property&gt;</div><div class="line">            &lt;!-- per connection cache prepared statement size  --&gt;</div><div class="line">            &lt;property name=<span class="string">"statementCacheSize"</span>&gt;<span class="number">500</span>&lt;/property&gt; </div><div class="line">            &lt;!-- query timeout( defaul<span class="variable">t:</span> <span class="number">60</span> second , TimeUni<span class="variable">t:second</span>) --&gt;</div><div class="line">            &lt;property name=<span class="string">"queryTimeout"</span>&gt;<span class="number">60</span>&lt;/property&gt;</div><div class="line">        &lt;/<span class="keyword">runtime</span>&gt;</div><div class="line">    &lt;/proxy&gt;</div><div class="line">    &lt;!--</div><div class="line">        Each ConnectionManager will start <span class="keyword">as</span> thread</div><div class="line">        manager responsible <span class="keyword">for</span> the Connection IO <span class="keyword">read</span> , Death Detection</div><div class="line">    --&gt;</div><div class="line">    <span class="symbol">&lt;connectionManagerList&gt;</span></div><div class="line">    &lt;connectionManager name=<span class="string">"clientConnectioneManager"</span> class=<span class="string">"com.meidusa.amoeba.net.MultiConnectionManagerWrapper"</span>&gt;</div><div class="line">    &lt;property name=<span class="string">"subManagerClassName"</span>&gt;<span class="keyword">com</span>.meidusa.amoeba.net.ConnectionManager&lt;/property&gt;</div><div class="line">            &lt;!--</div><div class="line">              default value <span class="keyword">is</span> avaliable Processors</div><div class="line">            &lt;property name=<span class="string">"processors"</span>&gt;<span class="number">5</span>&lt;/property&gt;</div><div class="line">             --&gt;</div><div class="line">        &lt;/connectionManager&gt;</div><div class="line">&lt;connectionManager name=<span class="string">"defaultManager"</span> class=<span class="string">"com.meidusa.amoeba.net.MultiConnectionManagerWrapper"</span>&gt;</div><div class="line">&lt;property name=<span class="string">"subManagerClassName"</span>&gt;<span class="keyword">com</span>.meidusa.amoeba.net.AuthingableConnectionManager&lt;/property&gt;</div><div class="line">            &lt;!--</div><div class="line">              default value <span class="keyword">is</span> avaliable Processors</div><div class="line">            &lt;property name=<span class="string">"processors"</span>&gt;<span class="number">5</span>&lt;/property&gt;</div><div class="line">             --&gt;</div><div class="line">        &lt;/connectionManager&gt;</div><div class="line">    &lt;/connectionManagerList&gt;</div><div class="line"></div><div class="line">        &lt;!-- default using <span class="keyword">file</span> loader --&gt;</div><div class="line">    &lt;dbServerLoader class=<span class="string">"com.meidusa.amoeba.context.DBServerConfigFileLoader"</span>&gt;</div><div class="line">        &lt;property name=<span class="string">"configFile"</span>&gt;$&#123;amoeba.home&#125;/<span class="keyword">conf</span>/dbServers.xml&lt;/property&gt;</div><div class="line">    &lt;/dbServerLoader&gt;</div><div class="line">    &lt;queryRouter class=<span class="string">"com.meidusa.amoeba.mysql.parser.MysqlQueryRouter"</span>&gt;</div><div class="line">        &lt;property name=<span class="string">"ruleLoader"</span>&gt;</div><div class="line">            &lt;bean class=<span class="string">"com.meidusa.amoeba.route.TableRuleFileLoader"</span>&gt;</div><div class="line">                &lt;property name=<span class="string">"ruleFile"</span>&gt;$&#123;amoeba.home&#125;/<span class="keyword">conf</span>/rule.xml&lt;/property&gt;</div><div class="line">                &lt;property name=<span class="string">"functionFile"</span>&gt;$&#123;amoeba.home&#125;/<span class="keyword">conf</span>/ruleFunctionMap.xml&lt;/property&gt;</div><div class="line">            &lt;/bean&gt;</div><div class="line">        &lt;/property&gt;</div><div class="line">        &lt;property name=<span class="string">"sqlFunctionFile"</span>&gt;$&#123;amoeba.home&#125;/<span class="keyword">conf</span>/functionMap.xml&lt;/property&gt;</div><div class="line">        &lt;property name=<span class="string">"LRUMapSize"</span>&gt;<span class="number">1500</span>&lt;/property&gt;</div><div class="line">        &lt;property name=<span class="string">"defaultPool"</span>&gt;master&lt;/property&gt;</div><div class="line">        #定义默认池,一些sql语句默认会在此定义的服务器上执行</div><div class="line">        &lt;property name=<span class="string">"writePool"</span>&gt;master&lt;/property&gt;</div><div class="line">                #定义只写数据库</div><div class="line">        &lt;property name=<span class="string">"readPool"</span>&gt;slave&lt;/property&gt;</div><div class="line">#定义只读数据库,此处定义的是在<span class="string">"dbServer.xml"</span>文件中定义的后端服务器名称，也可以定义数据库池的名称,实现负载均衡</div><div class="line">        &lt;property name=<span class="string">"needParse"</span>&gt;true&lt;/property&gt;</div><div class="line">    &lt;/queryRouter&gt;</div><div class="line">&lt;/amoeb<span class="variable">a:configuration</span>&gt;</div></pre></td></tr></table></figure>
<p>##启动amoeba服务并连接测试<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@amoeba ~]# /usr/local/amoeba/bin/launcher &amp;</div><div class="line">[root@amoeba ~]# ss -tanlp | <span class="keyword">grep</span> <span class="number">3306</span></div><div class="line">LISTEN     <span class="number">0</span>      <span class="number">128</span>      ::ffff:<span class="number">172.16</span>.<span class="number">14.1</span>:<span class="number">3306</span>     :::*      user<span class="variable">s:</span>((<span class="string">"java"</span>,<span class="number">29448</span>,<span class="number">54</span>))</div><div class="line">#由上可见已启动成功并监听在<span class="number">3306</span>端口</div></pre></td></tr></table></figure></p>
<p>##连接到amoeba代理服务器,执行插入与查询操作,查看是否实现读写分离<br>略…</p>
]]></content>
      
        <categories>
            
            <category> 技术 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Database </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Nginx配置ngx_pagespeed]]></title>
      <url>/2016/02/08/Nginx-ngx-pagespeed/</url>
      <content type="html"><![CDATA[<h1 id="pagespeed介绍"><a href="#pagespeed介绍" class="headerlink" title="pagespeed介绍"></a>pagespeed介绍</h1><p>pagespeed是 Goolge 为 Apache 和 nginx 开发的前端优化扩展模块，其中适用 Apache 环境的叫 mod_pagespeed，适用于 nginx 环境的叫 ngx_pagespeed。</p>
<p>pagespeed 的功能包括但不限于以下方面：</p>
<p>优化传输带宽（过滤）（压缩图片、CSS、JS文件，去除html空白、注释…）、降低请求（CSS、JS文件合并、图片雪碧、识别并重定向常用JS库、缓存控制）、域名映射（支持CDN）、提升客户端体验（图片预加载、延迟加载，移动端图像优化），同时还提供对 https 的支持。</p>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p>安装方法 Google pagespeed 网站上有<a href="https://developers.google.com/speed/pagespeed/module/build_ngx_pagespeed_from_source" target="_blank" rel="external">详细介绍</a>，复制过来方便不能翻墙的朋友查看。</p>
<h2 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h2><p>RedHat, CentOS, or Fedora:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo yum install gcc-c++ pcre-devel zlib-devel make unzip</div></pre></td></tr></table></figure></p>
<p>Ubuntu or Debian:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo apt-get install build-essential zlib1g-dev libpcre3 libpcre3-dev unzip</div></pre></td></tr></table></figure></p>
<h2 id="安装ngx-pagespeed"><a href="#安装ngx-pagespeed" class="headerlink" title="安装ngx_pagespeed"></a>安装ngx_pagespeed</h2><p>目前 ngx_pagespeed 最新的版本是 1.12.34.2 beta版（要求 gcc ≥ 4.8 or clang ≥ 3.3），查看<a href="https://modpagespeed.com/doc/release_notes" target="_blank" rel="external">最新版本</a><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">cd /opt</div><div class="line">NPS_VERSION=1.12.34.2</div><div class="line">wget https://github.com/pagespeed/ngx_pagespeed/archive/v$&#123;NPS_VERSION&#125;-beta.zip</div><div class="line">unzip v$&#123;NPS_VERSION&#125;-beta.zip</div><div class="line">cd ngx_pagespeed-$&#123;NPS_VERSION&#125;-beta/</div><div class="line">wget https://dl.google.com/dl/page-speed/psol/$&#123;NPS_VERSION&#125;-x64.tar.gz</div><div class="line">tar -xzvf $&#123;NPS_VERSION&#125;-x64.tar.gz</div></pre></td></tr></table></figure></p>
<p>下载 nginx 并编译 ngx_pagespeed 模块</p>
<p>编译 ngx_pagespeed 模块</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">cd</div><div class="line"><span class="meta">#</span> check http://nginx.org/en/download.html for the latest version</div><div class="line">NGINX_VERSION=1.10.3</div><div class="line">wget http://nginx.org/download/nginx-$&#123;NGINX_VERSION&#125;.tar.gz</div><div class="line">tar -xvzf nginx-$&#123;NGINX_VERSION&#125;.tar.gz</div><div class="line">cd nginx-$&#123;NGINX_VERSION&#125;/</div><div class="line">./configure --prefix=/usr/local/nginx --with-http_stub_status_module --with-http_gzip_static_module --with-http_ssl_module --add-module=/opt/ngx_pagespeed-1.12.34.2-beta</div><div class="line">make</div><div class="line">make install</div></pre></td></tr></table></figure>
<p>因为ngx_pagespeed模块的编译需要gcc ≥ 4.8 or clang ≥ 3.3，而我们使用的centos6系列gcc源版本只有4.7。官网给了一个解决方案：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">rpm --import https://linux.web.cern.ch/linux/scientific6/docs/repository/cern/slc6X/i386/RPM-GPG-KEY-cern</div><div class="line">wget -O /etc/yum.repos.d/slc6-devtoolset.repo https://linux.web.cern.ch/linux/scientific6/docs/repository/cern/devtoolset/slc6-devtoolset.repo</div><div class="line">yum install devtoolset-2-gcc-c++ devtoolset-2-binutils</div></pre></td></tr></table></figure></p>
<p>然后编译nginx的时候使用<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">./configure --prefix=/usr/local/nginx --with-http_stub_status_module --with-http_gzip_static_module --with-http_ssl_module --add-module=/opt/ngx_pagespeed-1.12.34.2-beta --with-cc=/opt/rh/devtoolset-2/root/usr/bin/gcc</div><div class="line">make</div><div class="line">make install</div></pre></td></tr></table></figure></p>
<p>我理解的是通过yum源将高版本的gcc已经安装到了/opt/rh/devtoolset-2/root/usr/bin/gcc目录下，然后编译的时候指定由高版本的gcc来进行编译。</p>
<h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1>]]></content>
      
        <categories>
            
            <category> 技术 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Nginx </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[阅读书单]]></title>
      <url>/2015/10/15/book-list/</url>
      <content type="html"><![CDATA[<ul>
<li><p><strong>2015.07阅读清单</strong></p>
<ul>
<li style="list-style: none"><input type="checkbox" checked> Linux系统命令及Shell脚本实践指南（纸质）</li>
<li style="list-style: none"><input type="checkbox" checked> 高性能Linux服务器构建实战—-系统安全、故障排查、自动化运维与集群架构（纸质）</li>
</ul>
</li>
<li><p><strong>2015.10阅读清单</strong></p>
<ul>
<li style="list-style: none"><input type="checkbox"> 构建高性能Web站点（纸质）</li>
<li style="list-style: none"><input type="checkbox"> 深入理解Nginx（纸质）</li>
</ul>
</li>
</ul>
]]></content>
      
        <categories>
            
            <category> 读书 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> 阅读,书单 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[TIPS]]></title>
      <url>/2015/07/16/Shell-Study/</url>
      <content type="html"><![CDATA[<h2 id="OPS运维工具"><a href="#OPS运维工具" class="headerlink" title="OPS运维工具"></a>OPS运维工具</h2><p><a href="http://mr-wang.qiniudn.com/Ansible-notes.pdf" target="_blank" rel="external">Ansible中文手册</a></p>
<p><a href="http://www.cnblogs.com/deerchao/archive/2006/08/24/zhengzhe30fengzhongjiaocheng.html" target="_blank" rel="external">正则表达式30分钟入门教程</a></p>
<h2 id="性能调优"><a href="#性能调优" class="headerlink" title="性能调优"></a>性能调优</h2><p><a href="http://mr-wang.qiniudn.com/performance-optimization.pdf" target="_blank" rel="external">性能分析笔记</a></p>
<p><a href="http://www.linuxprocess.com/" target="_blank" rel="external">Linux进程</a></p>
<h2 id="运维相关"><a href="#运维相关" class="headerlink" title="运维相关"></a>运维相关</h2><p><a href="http://mr-wang.qiniudn.com/UnixToolbox-zh_CN.html" target="_blank" rel="external">Linux Shell命令</a></p>
<p><a href="http://linux.51yip.com/" target="_blank" rel="external">Linux 命令手册</a></p>
<p><a href="http://www.gslb.cn/list.htm" target="_blank" rel="external">GSLB全局负载均衡系统是如何构建</a></p>
]]></content>
      
        <categories>
            
            <category> 资源 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[linux的运行级别及自启动程序]]></title>
      <url>/2015/07/16/Linux-Boot-Sequence/</url>
      <content type="html"><![CDATA[<h2 id="Linux运行级别："><a href="#Linux运行级别：" class="headerlink" title="Linux运行级别："></a>Linux运行级别：</h2><p>Linux运行级别有七种：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="number">0</span> - 停机（千万不能把initdefault 设置为<span class="number">0</span> ）</div><div class="line"><span class="number">1</span> - 单用户模式</div><div class="line"><span class="number">2</span> - 多用户，没有 NFS</div><div class="line"><span class="number">3</span> - 完全多用户模式(标准的运行级)</div><div class="line"><span class="number">4</span> - 没有用到</div><div class="line"><span class="number">5</span> - X11 （xwindow)</div><div class="line"><span class="number">6</span> - 重新启动 （千万不要把initdefault 设置为<span class="number">6</span> ）</div></pre></td></tr></table></figure>
<p>默认的运行级别在/etc/inittab文件中进行设置。</p>
<a id="more"></a>
<h2 id="加载开机启动程序"><a href="#加载开机启动程序" class="headerlink" title="加载开机启动程序"></a>加载开机启动程序</h2><p>Linux系统启动确定运行级别后，加载运行级别下的自启动程序。</p>
<p>那么不同运行级别的，自启动程序不同，对应的启动程序目录也不同。如果需要查看3级别用户的启动程序，可以通过/etc/rc3.d 目录来查看。</p>
<p>目录名中的”rc”，表示run command（运行程序），最后的d表示directory（目录）。<br>下面让我们看看 /etc/rc3.d, 目录中到底指定了哪些程序</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@dbserver etc]# <span class="keyword">ls</span> /etc/rc3.d/</div><div class="line">K01numad K01smartd K02oddjobd</div><div class="line">S01sysstat S02lvm2-monitor S08iptables</div><div class="line">...</div></pre></td></tr></table></figure>
<p>从目录名，我们可以看出，目录均是以“字母K或S+2位数字+程序名”的形式。<br>字母K表示：kill，从其他运行级别切换到这一级别时，需要关闭的程序。<br>字母S表示：start，需要启动的程序。<br>数字表示：表示处理顺序，数字越小，处理得越早。数字相同时，按照程序首字母顺序启动。</p>
<p>前面提到，不同运行级别的，自启动程序不同，对应的启动程序目录也不同。不难想到，如果多个”运行级别”需要启动同一个程序，那么这个程序的启动脚本，就会在每一个目录里都有一个拷贝。</p>
<p>这样会造成管理上的困扰：如果要修改启动脚本，岂不是每个目录都要改一遍？</p>
<p>Linux的解决办法，就是七个 /etc/rcN.d 目录里列出的程序，都设为链接文件，指向另外一个目录 /etc/init.d ，真正的启动脚本都统一放在这个目录中。init进程逐一加载开机启动程序，其实就是运行这个目录里的启动脚本。</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[root@dbserver rc3.d]# <span class="keyword">ll</span> /etc/rc3.d/</div><div class="line">总用量 <span class="number">0</span></div><div class="line">lrwxrwxrwx. <span class="number">1</span> root root <span class="number">15</span> <span class="number">3</span>月  <span class="number">25</span> <span class="number">17</span>:<span class="number">30</span> K01numad -&gt; ../init.d/numad</div><div class="line">lrwxrwxrwx. <span class="number">1</span> root root <span class="number">16</span> <span class="number">3</span>月  <span class="number">25</span> <span class="number">17</span>:<span class="number">30</span> K01smartd -&gt; ../init.d/smartd</div><div class="line">lrwxrwxrwx. <span class="number">1</span> root root <span class="number">17</span> <span class="number">3</span>月  <span class="number">25</span> <span class="number">17</span>:<span class="number">27</span> K02oddjobd -&gt; ../init.d/oddjobd</div><div class="line">lrwxrwxrwx. <span class="number">1</span> root root <span class="number">16</span> <span class="number">3</span>月  <span class="number">25</span> <span class="number">17</span>:<span class="number">31</span> K10psacct -&gt; ../init.d/psacct</div><div class="line">lrwxrwxrwx. <span class="number">1</span> root root <span class="number">19</span> <span class="number">3</span>月  <span class="number">25</span> <span class="number">17</span>:<span class="number">27</span> K10saslauthd -&gt; ../init.d/saslauthd</div><div class="line">lrwxrwxrwx. <span class="number">1</span> root root <span class="number">20</span> <span class="number">3</span>月  <span class="number">25</span> <span class="number">17</span>:<span class="number">25</span> K50netconsole -&gt; ../init.d/netconsole</div><div class="line">lrwxrwxrwx. <span class="number">1</span> root root <span class="number">13</span> <span class="number">3</span>月  <span class="number">25</span> <span class="number">17</span>:<span class="number">26</span> K60nfs -&gt; ../init.d/nfs</div></pre></td></tr></table></figure>
<p>再看看链接指向的init.d文件，发现还是一个链接文件。所以最终的脚本文件在/etc/rc.d/init.d</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@dbserver etc]# <span class="keyword">ll</span> /etc/init.d</div><div class="line">lrwxrwxrwx. <span class="number">1</span> root root <span class="number">11</span> <span class="number">3</span>月  <span class="number">25</span> <span class="number">17</span>:<span class="number">15</span> init.d -&gt; rc.d/init.d</div></pre></td></tr></table></figure>
<p>链接文件目录：/etc/rcN.d<br>程序脚本文件目录：/etc/rc.d/init.d<br>用户自定义脚本：/etc/rc.d/init.d/rc.local</p>
<h2 id="Shell配置文件"><a href="#Shell配置文件" class="headerlink" title="Shell配置文件"></a>Shell配置文件</h2><p>Shell的配置文件有如下五个：<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">/etc/<span class="keyword">profile</span></div><div class="line">/etc/bashrc</div><div class="line">~/.bash_profile</div><div class="line">~/.bash_loginout</div><div class="line">~/.bashrc</div></pre></td></tr></table></figure></p>
<p>他们之间的区别：<br><code>/etc/profile</code> 这是对所有用户都有效的配置，文件修改后，需要source生效重启；<br><code>~/.bash_profile</code> 这是对当前用户有效的配置，文件修改后，需要source生效或重启；<br><code>/etc/bashrc</code> 桌面状态下，打开一个不需要登陆的Shell时调用，对所有用户都有效，文件修改后，重新打开一个Shell就生效；<br><code>~/.bashrc</code> 桌面状态下，打开一个不需要登陆的Shell时调用，对当前用户有效，文件修改后，重新打开一个Shell就生效；<br><code>~/.bash_loginout</code> 当每次退出系统(退出bash shell)时,执行该文件。</p>
<p>参考<br><a href="http://blog.csdn.net/firedb/article/details/8205136" target="_blank" rel="external">linux /etc/rc.d/init.d自启动程序说明</a><br><a href="http://www.ruanyifeng.com/blog/2013/08/linux_boot_process.html" target="_blank" rel="external">Linux系统的启动流程</a><br><a href="http://blog.csdn.net/lxlj2006/article/details/5828705" target="_blank" rel="external">系统运行级别(/etc/inittab)</a></p>
]]></content>
      
        <categories>
            
            <category> 技术 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Nginx+Tomcat+Memcached集群]]></title>
      <url>/2015/07/16/Nginx-Tomcat-Memcached-Cluster/</url>
      <content type="html"><![CDATA[<h2 id="部署环境"><a href="#部署环境" class="headerlink" title="部署环境"></a>部署环境</h2><p>系统：Centos<br>软件及依赖包：<br>Nginx:<br>nginx-1.6.2.tar.gz<br>(<a href="http://nginx.org/download/nginx-1.6.2.tar.gz" target="_blank" rel="external">http://nginx.org/download/nginx-1.6.2.tar.gz</a>)<br>pcre-8.36.tar.gz (ftp://ftp.csx.cam.ac.uk/pub/software/programming/pcre/pcre-8.36.tar.gz)<br>zlib-1.2.8.tar.gz(<a href="http://zlib.net/zlib-1.2.8.tar.gz" target="_blank" rel="external">http://zlib.net/zlib-1.2.8.tar.gz</a>)</p>
<p>memcached：<br>memcached-1.4.22.tar.gz(<a href="http://memcached.org/files/memcached-1.4.22.tar.gz" target="_blank" rel="external">http://memcached.org/files/memcached-1.4.22.tar.gz</a>)<br>libevent-2.0.22-stable.tar.gz(<a href="http://libevent.org/" target="_blank" rel="external">http://libevent.org/</a>)</p>
<p>memcached-session-manager：<br><a href="http://repo1.maven.org/maven2/de/javakaffee/msm/" target="_blank" rel="external">下载地址</a></p>
<p>Tomcat：<br>apache-tomcat-7.0.59.tar.gz (<a href="http://mirrors.cnnic.cn/apache/tomcat/tomcat-7/v7.0.59/bin/apache-tomcat-7.0.59.tar.gz" target="_blank" rel="external">http://mirrors.cnnic.cn/apache/tomcat/tomcat-7/v7.0.59/bin/apache-tomcat-7.0.59.tar.gz</a>)<br>jdk-7u72-linux-x64.tar.gz</p>
<p>jar包：<br>我采用的是截止目前最新的版本，其中序列化方式是可选的。<br>序列化方式使用kryo时,jar包：<a href="http://wy-uploads.qiniudn.com/MSM_kryo.zip" target="_blank" rel="external">下载地址</a><br><img src="http://wy-uploads.qiniudn.com/MSM_1.png" alt="此处输入图片的描述"></p>
<p>序列化方式使用javolution时,jar包：<a href="http://wy-uploads.qiniudn.com/MSM_javolution.zip" target="_blank" rel="external">下载地址</a><br><img src="http://wy-uploads.qiniudn.com/MSM_2.png" alt="此处输入图片的描述"></p>
<p>了解到kryo序列化方式效率最高。</p>
<p>相关序列方式，所需不同jar包，可参考<a href="https://code.google.com/p/memcached-session-manager/wiki/SetupAndConfiguration" target="_blank" rel="external">官方文档</a></p>
<a id="more"></a>
<h2 id="Nginx安装"><a href="#Nginx安装" class="headerlink" title="Nginx安装"></a>Nginx安装</h2><h3 id="安装gcc-c"><a href="#安装gcc-c" class="headerlink" title="安装gcc-c++"></a>安装gcc-c++</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum -<span class="keyword">y</span> install gcc-<span class="keyword">c</span>++</div></pre></td></tr></table></figure>
<h3 id="安装pcre库"><a href="#安装pcre库" class="headerlink" title="安装pcre库"></a>安装pcre库</h3><p>pcre库是为了使nginx支持http rewrite模块</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">cd</span> /usr/local/src/</div><div class="line">wget ftp://ftp.csx.cam.ac.uk/pub/software/programming/pcre/pcre-<span class="number">8.36</span>.tar.gz</div><div class="line">tar -xzvf pcre-<span class="number">8.36</span>.tar.gz</div><div class="line"><span class="keyword">cd</span> pcre-<span class="number">8.36</span></div><div class="line">./configure</div><div class="line"><span class="keyword">make</span></div><div class="line"><span class="keyword">make</span> install</div></pre></td></tr></table></figure>
<h3 id="安装zlib库"><a href="#安装zlib库" class="headerlink" title="安装zlib库"></a>安装zlib库</h3><p>zlib库是为了使nginx支持gzip压缩</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">cd</span> /usr/local/src</div><div class="line">wget http://zlib.net/zlib-<span class="number">1.2</span>.<span class="number">8</span>.tar.gz</div><div class="line">tar -xzvf zlib-<span class="number">1.2</span>.<span class="number">8</span>.tar.gz</div><div class="line"><span class="keyword">cd</span> zlib-<span class="number">1.2</span>.<span class="number">8</span></div><div class="line">./configure</div><div class="line"><span class="keyword">make</span></div><div class="line"><span class="keyword">make</span> install</div></pre></td></tr></table></figure>
<h3 id="安装Nginx"><a href="#安装Nginx" class="headerlink" title="安装Nginx"></a>安装Nginx</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">cd</span> /usr/local/</div><div class="line">wget http://nginx.org/download/nginx-<span class="number">1.6</span>.<span class="number">2</span>.tar.gz</div><div class="line">tar -zxvf nginx-<span class="number">1.6</span>.<span class="number">2</span>.tar.gz</div><div class="line"><span class="keyword">cd</span> nginx-<span class="number">1.6</span>.<span class="number">2</span></div><div class="line">./configure --prefix=/usr/local/nginx --with-pcre=/usr/local/src/pcre-<span class="number">8.36</span> --with-zlib=/usr/local/src/zlib-<span class="number">1.2</span>.<span class="number">8</span></div><div class="line"><span class="keyword">make</span></div><div class="line"><span class="keyword">make</span> install</div></pre></td></tr></table></figure>
<h3 id="配置nginx-conf"><a href="#配置nginx-conf" class="headerlink" title="配置nginx.conf"></a>配置nginx.conf</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">#user  nobody;</div><div class="line">worker_processes  1;</div><div class="line"></div><div class="line">#error_log  logs/error.log;</div><div class="line">#error_log  logs/error.log  notice;</div><div class="line">#error_log  logs/error.log  info;</div><div class="line"></div><div class="line">#pid        logs/nginx.pid;</div><div class="line"></div><div class="line"></div><div class="line">events &#123;</div><div class="line">    worker_connections  1024;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">http &#123;</div><div class="line">    include       mime.types;</div><div class="line">    default_type  application/octet-stream;</div><div class="line"></div><div class="line">    #log_format  main  <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></div><div class="line">    #                  <span class="string">'$status $body_bytes_sent "$http_referer" '</span></div><div class="line">    #                  '"$http_user_agent" "$http_x_forwarded_for"';</div><div class="line"></div><div class="line">    #access_log  logs/access.log  main;</div><div class="line"></div><div class="line">    sendfile        on;</div><div class="line">    #tcp_nopush     on;</div><div class="line"></div><div class="line">    #keepalive_timeout  0;</div><div class="line">    keepalive_timeout  65;</div><div class="line"></div><div class="line">    gzip  on;</div><div class="line"></div><div class="line"></div><div class="line">    #配置后端服务器群组信息</div><div class="line">    upstream web_server &#123;</div><div class="line">	server	localhost:8080;</div><div class="line">	server	localhost:8081;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    server &#123;</div><div class="line">        listen       80;</div><div class="line">        server_name  localhost;</div><div class="line"></div><div class="line">        charset utf-8;</div><div class="line"></div><div class="line">        #access_log  logs/host.access.log  main;</div><div class="line"></div><div class="line">        location / &#123;</div><div class="line">            root              html;</div><div class="line">            index             index.html index.htm;</div><div class="line">	        #代理设置</div><div class="line">	        proxy_pass        http://web_server;</div><div class="line">	        proxy_set_header  X-Real-IP  $remote_addr;</div><div class="line">            client_max_body_size 100m;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        #error_page  404              /404.html;</div><div class="line"></div><div class="line">        # redirect server error pages <span class="keyword">to</span> the static page /<span class="number">50</span><span class="keyword">x</span>.html</div><div class="line">        #</div><div class="line">        error_page   500 502 503 504  /50x.html;</div><div class="line">        location = /<span class="number">50</span><span class="keyword">x</span>.html &#123;</div><div class="line">            root   html;</div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="安装memcached"><a href="#安装memcached" class="headerlink" title="安装memcached"></a>安装memcached</h2><p>先安装libevent-2.0.22-stable.tar.gz依赖包</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">tar zxvf libevent-<span class="number">2.0</span>.<span class="number">22</span>-stable.tar.gz </div><div class="line"><span class="keyword">cd</span> libevent-<span class="number">2.0</span>.<span class="number">22</span>-stable </div><div class="line">./configure --prefix=/usr/local/libevent-<span class="number">2.0</span>.<span class="number">22</span></div><div class="line"><span class="keyword">make</span></div><div class="line"><span class="keyword">make</span> install</div></pre></td></tr></table></figure>
<p>再安装memcached-1.4.22.tar.gz<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">tar zxvf memcached-<span class="number">1.4</span>.<span class="number">22</span>.tar.gz </div><div class="line"><span class="keyword">cd</span> memcached-<span class="number">1.4</span>.<span class="number">22</span> </div><div class="line">./configure --prefix=/usr/local/memcached-<span class="number">1.4</span>.<span class="number">22</span> --with-libevent=/usr/local/libevent-<span class="number">2.0</span>.<span class="number">22</span>/ </div><div class="line"><span class="keyword">make</span> </div><div class="line"><span class="keyword">make</span> install</div><div class="line"></div><div class="line">#以守护进程的方式启动，监听于 <span class="number">127.0</span>.<span class="number">0.1</span> 的<span class="number">11211</span>端口，使用root用户，最大使用<span class="number">512</span>M内存，日志输出到/tmp/memcached.<span class="built_in">log</span>下</div><div class="line">/usr/local/memcached-<span class="number">1.4</span>.<span class="number">22</span>/bin/memcached -d -<span class="keyword">m</span> <span class="number">512</span> -<span class="keyword">l</span> <span class="number">127.0</span>.<span class="number">0.1</span> -<span class="keyword">p</span> <span class="number">11211</span> -<span class="keyword">u</span> root -vv &gt;&gt; /tmp/memcached.<span class="built_in">log</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span></div><div class="line">#启动后，可以telnet上去看下状态</div><div class="line">telnet <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">11211</span></div><div class="line"></div><div class="line">stats</div></pre></td></tr></table></figure></p>
<h2 id="安装tomcat"><a href="#安装tomcat" class="headerlink" title="安装tomcat"></a>安装tomcat</h2><h3 id="安装JDK-环境"><a href="#安装JDK-环境" class="headerlink" title="安装JDK 环境"></a>安装JDK 环境</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">#查询是否安装java</div><div class="line">rpm -<span class="keyword">qa</span> | <span class="keyword">grep</span> java</div><div class="line">#卸载openjdk</div><div class="line">rpm -<span class="keyword">e</span> java-<span class="number">1.6</span>.<span class="number">0</span>-openjdk-<span class="number">1.6</span>.<span class="number">0.0</span>-<span class="number">1.45</span>.<span class="number">1.11</span>.<span class="number">1</span>.el6.x86_64</div><div class="line">rpm -<span class="keyword">e</span> tzdata-java-<span class="number">2012</span><span class="keyword">c</span>-<span class="number">1</span>.el6.noarch</div><div class="line"></div><div class="line">#安装java</div><div class="line"><span class="built_in">mkdir</span> /usr/java</div><div class="line"><span class="keyword">cd</span> /usr/java</div><div class="line">wget http://.../jdk-<span class="number">7</span>u72-linux-x64.tar.gz</div><div class="line">tar -xzvf jdk-<span class="number">7</span>u72-linux-x64.tar.gz</div><div class="line"></div><div class="line">#修改系统环境变量文件</div><div class="line"><span class="keyword">vi</span> /etc/<span class="keyword">profile</span></div><div class="line"></div><div class="line">#添加如下内容</div><div class="line">#Set java JDK</div><div class="line">JAVA_HOME=/usr/local/jdk1.<span class="number">7.0</span>_72</div><div class="line">JRE_HOME=/usr/local/jdk1.<span class="number">7.0</span>_72/jre</div><div class="line">PATH=$PATH:$JAVA_HOME/bin:$JRE_home/bin</div><div class="line">CLASSPATH=$JAVA_HOME/lib/tools.jar:$JAVA_HOME/lib/dt.jar</div><div class="line">export JAVA_HOME</div><div class="line">export JRE_HOME</div><div class="line">export PATH</div><div class="line">export CLASSPATH</div><div class="line"></div><div class="line">#使修改马上生效</div><div class="line"><span class="keyword">source</span> /etc/<span class="keyword">profile</span></div><div class="line"></div><div class="line">#验证是否安装成功</div><div class="line">java -<span class="keyword">version</span></div></pre></td></tr></table></figure>
<h3 id="安装Tomcat应用服务器"><a href="#安装Tomcat应用服务器" class="headerlink" title="安装Tomcat应用服务器"></a>安装Tomcat应用服务器</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">cd</span> /usr/local</div><div class="line">wget http://.../apache-tomcat-<span class="number">7.0</span>.<span class="number">56</span>.tar.gz</div><div class="line">tar -xzvf apache-tomcat-<span class="number">7.0</span>.<span class="number">56</span>.tar.gz</div><div class="line">mv apache-tomcat-<span class="number">7.0</span>.<span class="number">56</span> tomcat1</div><div class="line"><span class="keyword">cp</span> -R tomcat1 tomcat2</div></pre></td></tr></table></figure>
<h3 id="配置Tomact的server-conf"><a href="#配置Tomact的server-conf" class="headerlink" title="配置Tomact的server.conf"></a>配置Tomact的server.conf</h3><p>8080端口实例的tomcat1配置：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&lt;Server port=<span class="string">"8005"</span> shutdown=<span class="string">"SHUTDOWN"</span>&gt;</div><div class="line">&lt;Connector port=<span class="string">"8080"</span> protocol=<span class="string">"HTTP/1.1"</span> connectionTimeout=<span class="string">"20000"</span> redirectPort=<span class="string">"8443"</span> /&gt;</div><div class="line">&lt;Connector port=<span class="string">"8009"</span> protocol=<span class="string">"AJP/1.3"</span> redirectPort=<span class="string">"8443"</span> /&gt;</div><div class="line"></div><div class="line">&lt;Engine name=<span class="string">"Catalina"</span> defaultHost=<span class="string">"localhost"</span> jvmRoute=<span class="string">"tomcat1"</span>&gt;</div><div class="line">...</div><div class="line">&lt;Context path=<span class="string">""</span> docBase=<span class="string">"/home/imcc/web"</span> <span class="keyword">debug</span>=<span class="string">"0"</span> reloadable=<span class="string">"true"</span> crossContext=<span class="string">"true"</span>&gt;    </div><div class="line">	&lt;Manager </div><div class="line">	  className=<span class="string">"de.javakaffee.web.msm.MemcachedBackupSessionManager"</span></div><div class="line">      memcachedNodes=<span class="string">"n1:localhost:11211"</span></div><div class="line">	  requestUriIgnorePattern=<span class="string">".*\.(png|gif|jpg|css|js|ico|jpeg|htm|html)$"</span></div><div class="line">	  sessionBackupAsync=<span class="string">"false"</span></div><div class="line">	  sessionBackupTimeout=<span class="string">"100"</span></div><div class="line">	  copyCollectionsForSerialization=<span class="string">"false"</span></div><div class="line">	  transcoderFactoryClass=<span class="string">"de.javakaffee.web.msm.serializer.kryo.KryoTranscoderFactory"</span> /&gt;</div><div class="line">&lt;/Context&gt;</div></pre></td></tr></table></figure>
<p>8081端口实例的tomcat1配置：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&lt;Server port=<span class="string">"8006"</span> shutdown=<span class="string">"SHUTDOWN"</span>&gt;</div><div class="line">&lt;Connector port=<span class="string">"8081"</span> protocol=<span class="string">"HTTP/1.1"</span> connectionTimeout=<span class="string">"20000"</span> redirectPort=<span class="string">"8443"</span> /&gt;</div><div class="line">&lt;Connector port=<span class="string">"9009"</span> protocol=<span class="string">"AJP/1.3"</span> redirectPort=<span class="string">"8443"</span> /&gt;</div><div class="line"></div><div class="line">&lt;Engine name=<span class="string">"Catalina"</span> defaultHost=<span class="string">"localhost"</span> jvmRoute=<span class="string">"tomcat2"</span>&gt;</div><div class="line">...</div><div class="line">&lt;Context path=<span class="string">""</span> docBase=<span class="string">"/home/imcc/web"</span> <span class="keyword">debug</span>=<span class="string">"0"</span> reloadable=<span class="string">"true"</span> crossContext=<span class="string">"true"</span>&gt;    </div><div class="line">	&lt;Manager </div><div class="line">	  className=<span class="string">"de.javakaffee.web.msm.MemcachedBackupSessionManager"</span></div><div class="line">      memcachedNodes=<span class="string">"n1:localhost:11211"</span></div><div class="line">	  requestUriIgnorePattern=<span class="string">".*\.(png|gif|jpg|css|js|ico|jpeg|htm|html)$"</span></div><div class="line">	  sessionBackupAsync=<span class="string">"false"</span></div><div class="line">	  sessionBackupTimeout=<span class="string">"100"</span></div><div class="line">	  copyCollectionsForSerialization=<span class="string">"false"</span></div><div class="line">	  transcoderFactoryClass=<span class="string">"de.javakaffee.web.msm.serializer.kryo.KryoTranscoderFactory"</span> /&gt;</div><div class="line">&lt;/Context&gt;</div></pre></td></tr></table></figure>
<p>备注：</p>
<p>Manager标签属性说明:</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line">className  必须</div><div class="line">类名：de.javakaffee.web.msm.MemcachedBackupSessionManager</div><div class="line"></div><div class="line">memcachedNodes  必须</div><div class="line">memcached节点：此属性应该包含所有运行的memcached节点或者membase bucket的uri地址，每一个memcached节点的属性定义格式为<span class="symbol">&lt;id&gt;</span>:<span class="symbol">&lt;host&gt;</span>:<span class="symbol">&lt;port&gt;</span>，多个节点定义直接使用空格或者逗号分隔，形如：memcachedNodes=<span class="string">"n1:app01:11211,n2:app02:11211"</span>，如果只有单个的memcached节点，则<span class="symbol">&lt;id&gt;</span>是可选项，只需配置<span class="symbol">&lt;host&gt;</span>:<span class="symbol">&lt;port&gt;</span>即可，形如：memcachedNodes=<span class="string">"localhost:11211"</span>。</div><div class="line">如果我们配置的是membase，那么从<span class="number">1.6</span>.<span class="number">0</span>版本开始，我们可以配置指定一个或者多个membase bucket uris，形如：http://host1:<span class="number">8091</span>/pools,http://host2:<span class="number">8091</span>/pools。Bucket 名称和密码通过属性username,password来定义。membase buckets连接需要遵循memcached协议，传输数据通过二进制流方式。</div><div class="line"></div><div class="line">failoverNodes 可选项</div><div class="line">故障转移节点：可选项，对非黏性session不可用，属性必须包含memcached节点集群的所有ids。节点id之间用空格或者逗号分隔。</div><div class="line"></div><div class="line">username 可选项</div><div class="line">从<span class="number">1.6</span>.<span class="number">0</span>版开始使用，并且是可选的。用来进行membase bucket或者SASL验证，密码可以为空。</div><div class="line"></div><div class="line">password 可选项</div><div class="line">从<span class="number">1.6</span>.<span class="number">0</span>版开始使用，并且是可选的。用来进行membase bucket或者SASL验证，密码可以为空。</div><div class="line"></div><div class="line">memcachedProtocol    可选项</div><div class="line">定义memcached协议，默认使用text文本，出属性指明memcached使用的存储协议。只支持text或者binary。</div><div class="line"></div><div class="line">sticky    可选项</div><div class="line">定义session方式为黏性或非黏性，默认为true，多个tomcat时需使用非黏性</div><div class="line"></div><div class="line">lockingMode    可选项</div><div class="line">只有非黏性session才使用，默认值为none</div><div class="line">none: 从不对session进行锁定</div><div class="line"><span class="keyword">al</span><span class="variable">l:</span> session将一直被锁定，直到请求结束</div><div class="line">auto: 对于只读请求，session将不会被锁定，如果是非只读请求，则session会被锁定</div><div class="line">uriPattern:<span class="symbol">&lt;regexp&gt;</span>: 通过正则表达式的方式来对请求uri以及查询字符串进行匹配，只有匹配上的才会被锁定。</div><div class="line"></div><div class="line">requestUriIgnorePattern   可选项</div><div class="line">此属性是那些不能改备份Session的请求的正则表达式。如果像css,javascript,图片等静态文件被同一个Tomcat和同一个应用上下文来提供，这些请求也会通过memcached-session-manager。但是这些请求在一个http会话中几乎没什么改变，所以他们没必要触发Session备份。所以那些静态文件没必要触发Session备份，你就可以使用此属性定义。此属性必须符合java regex正则规范。</div><div class="line">    如：<span class="string">".*\.(png|gif|jpg|css|js)$"</span> </div><div class="line"></div><div class="line">sessionBackupAsync   可选项</div><div class="line">指定Session是否应该被异步保存到Memcached中。 如果被设置为true，backupThreadCount设置起作用，如果设置false，通过sessionBackupTimeout设置的过期时间起作用。</div><div class="line"></div><div class="line">backupThreadCount    可选项</div><div class="line">用来异步保存Session的线程数，(如果sessionBackupAsync=<span class="string">"true"</span>)。默认值为cup的内核数。</div><div class="line"></div><div class="line">sessionBackupTimeout    可选项</div><div class="line">设置备份一个Session所用的时间，如果操作超过时间那么保存失败。此属性只sessionBackupAsync=<span class="string">"false"</span>是起作用。默认<span class="number">100</span>毫秒</div><div class="line"></div><div class="line">operationTimeout    可选项</div><div class="line">从<span class="number">1.6</span>.<span class="number">0</span>版开始使用， 默认值为<span class="number">1000</span></div><div class="line"></div><div class="line">sessionAttributeFilter    可选项</div><div class="line">此属性是用来控制Session中的那个属性值保存到Memcached中的正则表达式。正则表达式被用来匹配Session中属性名称。如sessionAttributeFilter=<span class="string">"^(userName|sessionHistory)$"</span> 指定了只有<span class="string">"userName"</span>和<span class="string">"sessionHistory"</span>属性保存到Memcached中。依赖于选择的序列化策略。</div><div class="line"></div><div class="line">transcoderFactoryClass    可选项</div><div class="line">此属性值是创建序列化和反序列化保存到Memcached中的Session的编码转换器的工厂类名。这个指定的类必须实现了de.javakaffee.web.msm.TranscoderFactory和提供一个无参的构造方法。例如其他的有效的实现在其他packages/jars中提供如：msm-kryo-serializer,msm-xstrea-serializer和msm-javolution-serializer.</div><div class="line">默认为 de.javakaffee.web.msm.JavaSerializationTranscoderFactory</div><div class="line"></div><div class="line">copyCollectionsForSerialization    可选项</div><div class="line">默认值为false。</div><div class="line"></div><div class="line">customConverter    可选项</div><div class="line">自己定义特殊的类注册到kryo自定义转换器中，实现序列化</div><div class="line"></div><div class="line">enableStatistics    可选项</div><div class="line">用来指定是否进行统计。 默认值为true。</div><div class="line"></div><div class="line">enabled   可选项</div><div class="line">指定Session保存到Memcached中是否可用和是否可以通过JMX进行改变。只用于粘性Session。 默认值为true。</div></pre></td></tr></table></figure>
<p>添加memcached-session-manager的依赖包到$TOMCATHOME/lib目录下</p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>添加测试页面<code>/home/imcc/web/index.jsp</code></p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">SessionID:&lt;%=session.getId()%&gt;  </div><div class="line"><span class="symbol">&lt;BR&gt;</span>  </div><div class="line">SessionIP:&lt;%=request.getServerName()%&gt;  </div><div class="line"><span class="symbol">&lt;BR&gt;</span>  </div><div class="line">SessionPor<span class="variable">t:</span>&lt;%=request.getServerPort()%&gt;  </div><div class="line">&lt;%  </div><div class="line">out.println("This is Tomcat Server!");  </div><div class="line">%&gt;</div></pre></td></tr></table></figure>
<p>通过浏览器访问,并刷新:<br><img src="http://wy-uploads.qiniudn.com/MSM_3.png" alt="此处输入图片的描述"><br><img src="http://wy-uploads.qiniudn.com/MSM_4.png" alt="此处输入图片的描述"></p>
<p>查看memcached日志：<br><img src="http://wy-uploads.qiniudn.com/MSM_5.png" alt="此处输入图片的描述"><br>通过观察SessionID没有发生变化，证明session共享成功。</p>
<p>参考：<br><a href="http://www.iteye.com/topic/1125301" target="_blank" rel="external">MSM–Memcached_Session_Manager介绍及使用</a><br><a href="http://blog.csdn.net/wh0426/article/details/44699449" target="_blank" rel="external">交易系统架构之会话篇：tomcat msm部署</a><br><a href="http://blog.csdn.net/shimiso/article/details/8979044" target="_blank" rel="external">Nginx+Tomcat+Memcached集群Session共享</a><br><a href="http://passover.blog.51cto.com/2431658/648182" target="_blank" rel="external">利用nginx+tomcat+memcached组建web服务器负载均衡</a><br><a href="http://www.cnblogs.com/phirothing/archive/2013/12/05/3459814.html" target="_blank" rel="external">Nginx+Tomcat+Memcached集群</a></p>
]]></content>
      
        <categories>
            
            <category> 技术 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> 集群 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[CentOS下Oracle安装]]></title>
      <url>/2015/07/16/CentOS-Oracle-installation/</url>
      <content type="html"><![CDATA[<h1 id="安装前准备"><a href="#安装前准备" class="headerlink" title="安装前准备"></a>安装前准备</h1><h2 id="安装依赖包"><a href="#安装依赖包" class="headerlink" title="安装依赖包"></a>安装依赖包</h2><p>oracle 安装所需程序包,可以到安装步骤时，查看缺少什么程序就安装什么程序</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">binutils-<span class="number">2.17</span>.<span class="number">50.0</span>.<span class="number">6</span></div><div class="line">compat-libstdc++-<span class="number">33</span>-<span class="number">3.2</span>.<span class="number">3</span></div><div class="line">compat-libstdc++-<span class="number">33</span>-<span class="number">3.2</span>.<span class="number">3</span> (<span class="number">32</span> bit)</div><div class="line">elfutils-libelf-<span class="number">0.125</span></div><div class="line">elfutils-libelf-devel-<span class="number">0.125</span></div><div class="line">gcc-<span class="number">4.1</span>.<span class="number">2</span></div><div class="line">gcc-<span class="keyword">c</span>++-<span class="number">4.1</span>.<span class="number">2</span></div><div class="line">glibc-<span class="number">2.5</span>-<span class="number">24</span></div><div class="line">glibc-<span class="number">2.5</span>-<span class="number">24</span> (<span class="number">32</span> bit)</div><div class="line">glibc-common-<span class="number">2.5</span></div><div class="line">glibc-devel-<span class="number">2.5</span></div><div class="line">glibc-devel-<span class="number">2.5</span> (<span class="number">32</span> bit)</div><div class="line">glibc-headers-<span class="number">2.5</span></div><div class="line">ksh-<span class="number">20060214</span></div><div class="line">libaio-<span class="number">0.3</span>.<span class="number">106</span></div><div class="line">libaio-<span class="number">0.3</span>.<span class="number">106</span> (<span class="number">32</span> bit)</div><div class="line">libaio-devel-<span class="number">0.3</span>.<span class="number">106</span></div><div class="line">libaio-devel-<span class="number">0.3</span>.<span class="number">106</span> (<span class="number">32</span> bit)</div><div class="line">libgcc-<span class="number">4.1</span>.<span class="number">2</span></div><div class="line">libgcc-<span class="number">4.1</span>.<span class="number">2</span> (<span class="number">32</span> bit)</div><div class="line">libstdc++-<span class="number">4.1</span>.<span class="number">2</span></div><div class="line">libstdc++-<span class="number">4.1</span>.<span class="number">2</span> (<span class="number">32</span> bit)</div><div class="line">libstdc++-devel <span class="number">4.1</span>.<span class="number">2</span></div><div class="line"><span class="keyword">make</span>-<span class="number">3.81</span></div><div class="line">sysstat-<span class="number">7.0</span>.<span class="number">2</span></div><div class="line">unixODBC-<span class="number">2.2</span>.<span class="number">14</span>-<span class="number">11</span>.el6 (x86_64) <span class="built_in">or</span> <span class="keyword">later</span></div><div class="line">unixODBC-<span class="number">2.2</span>.<span class="number">14</span>-<span class="number">11</span>.el6.i686 <span class="built_in">or</span> <span class="keyword">later</span></div><div class="line">unixODBC-devel-<span class="number">2.2</span>.<span class="number">14</span>-<span class="number">11</span>.el6 (x86_64) <span class="built_in">or</span> <span class="keyword">later</span></div><div class="line">unixODBC-devel-<span class="number">2.2</span>.<span class="number">14</span>-<span class="number">11</span>.el6.i686 <span class="built_in">or</span> <span class="keyword">later</span></div><div class="line">libXp</div></pre></td></tr></table></figure>
<p>使用命令 yum install -y ‘package name’ 安装所缺的程序包，pdksh包除外</p>
<p>安装pdksh包，使用rz命令上传pdksh-5.2.14-37.el5_8.1.x86_64.rpm文件到/opt/目录下</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># 注意：该程序包与ksh冲突，如果已经安装ksh，建议使用命令 rpm -<span class="keyword">e</span> ksh-* 卸载</div><div class="line"></div><div class="line">rpm -ivh pdksh-<span class="number">5.2</span>.<span class="number">14</span>-<span class="number">37</span>.el5_8.<span class="number">1</span>.x86_64.rpm</div></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="创建用户及安装目录"><a href="#创建用户及安装目录" class="headerlink" title="创建用户及安装目录"></a>创建用户及安装目录</h2><p>使用rz上传p10404530_112030_Linux-x86-64_1of7.zip、p10404530_112030_Linux-x86-64_2of7.zip到/opt/目录下</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"># 分别解压上传的文件,解压得到database文件夹</div><div class="line">unzip -<span class="keyword">x</span> p10404530_112030_Linux-x86-<span class="number">64</span>_1of7.zip</div><div class="line">unzip -<span class="keyword">x</span> p10404530_112030_Linux-x86-<span class="number">64</span>_2of7.zip</div><div class="line"></div><div class="line"># 创建oracle用户和组,并设置密码</div><div class="line">groupadd oinstall</div><div class="line">groupadd dba</div><div class="line">useradd -g oinstall -G dba oracle</div><div class="line">passwd oracle</div><div class="line"></div><div class="line"># 创建oracl安装目录，并将目录权限赋予oracle用户</div><div class="line"><span class="built_in">mkdir</span> -<span class="keyword">p</span> /data/DBSoft/oracle/product/<span class="number">11.2</span>.<span class="number">0</span>/db_1</div><div class="line">chown -R oracle:oinstall /data/DBSoft/oracle</div><div class="line">chmod -R <span class="number">755</span> /data/DBSoft/oracle</div><div class="line"></div><div class="line"># 安装时还需要设置Inventory目录，所以创建并赋予权限</div><div class="line"><span class="built_in">mkdir</span> -<span class="keyword">p</span> /data/DBSoft/oraInventory</div><div class="line">chown -R oracle:oinstall /data/DBSoft/oraInventory</div><div class="line">chmod -R <span class="number">755</span> /data/DBSoft/oraInventory</div></pre></td></tr></table></figure>
<h2 id="修改系统参数"><a href="#修改系统参数" class="headerlink" title="修改系统参数"></a>修改系统参数</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"># 修改hosts文件，将<span class="number">127.0</span>.<span class="number">0.1</span>修改为本机的ip，避免安装Oracle在Oracle Net Configuration Assistant时会失败</div><div class="line"><span class="keyword">vi</span> /etc/hosts</div><div class="line"></div><div class="line"><span class="number">192.168</span>.<span class="number">1.250</span>   dbsrver localhost</div><div class="line">::<span class="number">1</span>     localhost6 localhost6.localdomain6</div><div class="line"></div><div class="line"></div><div class="line"># 修改内核参数</div><div class="line"><span class="keyword">vi</span> /etc/sysctl.<span class="keyword">conf</span></div><div class="line"></div><div class="line">kernel.shmmni = <span class="number">4096</span></div><div class="line">kernel.sem = <span class="number">250</span> <span class="number">32000</span> <span class="number">100</span> <span class="number">128</span></div><div class="line">net.ipv4.ip_local_port_range = <span class="number">9000</span> <span class="number">65500</span></div><div class="line">fs.<span class="keyword">file</span>-<span class="built_in">max</span> = <span class="number">6815744</span></div><div class="line">net.core.rmem_default = <span class="number">262144</span></div><div class="line">net.core.rmem_max = <span class="number">4194304</span></div><div class="line">net.core.wmem_default = <span class="number">262144</span></div><div class="line">net.core.wmem_max = <span class="number">1048576</span></div><div class="line">fs.aio-<span class="built_in">max</span>-nr = <span class="number">1048576</span></div><div class="line"></div><div class="line"># 再执行以下命令使以上配置立即生效</div><div class="line">sysctl -<span class="keyword">p</span></div><div class="line"></div><div class="line"># 编辑系统资源限制配置文件</div><div class="line"><span class="keyword">vi</span> /etc/security/limits.<span class="keyword">conf</span></div><div class="line"></div><div class="line">oracle soft nproc <span class="number">2047</span></div><div class="line">oracle hard nproc <span class="number">16384</span></div><div class="line">oracle soft nofile <span class="number">1024</span></div><div class="line">oracle hard nofile <span class="number">65536</span></div></pre></td></tr></table></figure>
<h2 id="配置oracle默认安装参数"><a href="#配置oracle默认安装参数" class="headerlink" title="配置oracle默认安装参数"></a>配置oracle默认安装参数</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"># 切换到orcale用户，修改/home/oracle/.bash_profile文件</div><div class="line">su - oracle</div><div class="line"><span class="keyword">vi</span> ~/.bash_profile</div><div class="line"></div><div class="line"># 设置oracle用户环境变量，添加如下</div><div class="line">#安装目录</div><div class="line">export ORACLE_BASE=/data/DBSoft/oracle</div><div class="line">#oracle家目录</div><div class="line">export ORACLE_HOME=$ORACLE_BASE/product/<span class="number">11.2</span>.<span class="number">0</span>/db_1</div><div class="line">export PATH=$ORACLE_HOME/bin:$PATH</div><div class="line"></div><div class="line"># 保存退出后执行如下命令使以上设置立即生效,并env或者<span class="keyword">echo</span> $PATH查看下</div><div class="line"><span class="keyword">source</span> ~/.bash_profile</div></pre></td></tr></table></figure>
<h1 id="开始安装oracle"><a href="#开始安装oracle" class="headerlink" title="开始安装oracle"></a>开始安装oracle</h1><h2 id="配置远程安装环境"><a href="#配置远程安装环境" class="headerlink" title="配置远程安装环境"></a>配置远程安装环境</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"># oracle安装需要<span class="keyword">X</span>-window环境，但是考虑到最大化利用服务器性能，一般服务器中不会安装<span class="keyword">X</span>-windows环境。所以选择远程来安装oracle。</div><div class="line"></div><div class="line"># 设置语言环境LANG和LC_ALL,改为英文环境</div><div class="line">export LANG=en_US</div><div class="line">export LC_ALL=en_US</div><div class="line"></div><div class="line"># 使用Xmanager来远程显示oracle的安装界面，安装过程中可能遇到界面显示不完全的问题，因为我是在虚拟机中安装，猜测是与内存大小有关</div><div class="line">export DISPLAY=<span class="number">192.168</span>.<span class="number">1.233</span>:<span class="number">0.0</span></div><div class="line">./runInstall</div></pre></td></tr></table></figure>
<h2 id="安装数据库软件"><a href="#安装数据库软件" class="headerlink" title="安装数据库软件"></a>安装数据库软件</h2><p>1.进入图形化界面，一步步安装，取消勾选I wish…（依照个人），点击Next，弹出确认框再点Yes<br><img src="http://wy-uploads.qiniudn.com/oracle_1.png" alt="此处输入图片的描述"><br><img src="http://wy-uploads.qiniudn.com/oracle_2.png" alt="此处输入图片的描述"></p>
<p>2.询问是否软件升级，选择”Skip software updates”<br><img src="http://wy-uploads.qiniudn.com/oracle_3.png" alt="此处输入图片的描述"></p>
<p>3.选择第二项：Install database software only，只安装数据库软件<br><img src="http://wy-uploads.qiniudn.com/oracle_4.png" alt="此处输入图片的描述"></p>
<p>4.保持默认：Singel instance database installation，点击Next<br><img src="http://wy-uploads.qiniudn.com/oracle_5.png" alt="此处输入图片的描述"></p>
<p>5.选择产品语言，默认英语，附加选择了简体中文，点击Next<br><img src="http://wy-uploads.qiniudn.com/oracle_6.png" alt="此处输入图片的描述"></p>
<p>6.选择数据库版本，默认企业版，点击Next<br><img src="http://wy-uploads.qiniudn.com/oracle_7.png" alt="此处输入图片的描述"></p>
<p>7.配置Oracle安装目录，由于安装前环境变量的配置，安装程序自动读取配置，自动选择好了<br><img src="http://wy-uploads.qiniudn.com/oracle_8.png" alt="此处输入图片的描述"></p>
<p>8.同上，Oracle Inventory Directory目录也自动选择好了，oraInventory Group Name选择安装前创建的组oinstall，点击Next<br><img src="http://wy-uploads.qiniudn.com/oracle_9.png" alt="此处输入图片的描述"></p>
<p>9.保持默认，点击Next<br><img src="http://wy-uploads.qiniudn.com/oracle_10.png" alt="此处输入图片的描述"></p>
<p>10.安装检查中<br><img src="http://wy-uploads.qiniudn.com/oracle_11.png" alt="此处输入图片的描述"></p>
<p>11.检查结束，不满足条件列表,可以针对packages包进行yum install<br><img src="http://wy-uploads.qiniudn.com/oracle_12.png" alt="此处输入图片的描述"></p>
<p>12.忽略物理内存和交换分区的警告<br><img src="http://wy-uploads.qiniudn.com/oracle_13.png" alt="此处输入图片的描述"></p>
<p>13.配置确认，安装<br><img src="http://wy-uploads.qiniudn.com/oracle_14.png" alt="此处输入图片的描述"></p>
<p>14.root用户下，命令执行提示sh文件<br><img src="http://wy-uploads.qiniudn.com/oracle_15.png" alt="此处输入图片的描述"></p>
<h2 id="安装监听"><a href="#安装监听" class="headerlink" title="安装监听"></a>安装监听</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># 在oracle用户下</div><div class="line">netca</div></pre></td></tr></table></figure>
<p><img src="http://wy-uploads.qiniudn.com/oracle_31.png" alt="此处输入图片的描述"></p>
<p><img src="http://wy-uploads.qiniudn.com/oracle_32.png" alt="此处输入图片的描述"></p>
<p><img src="http://wy-uploads.qiniudn.com/oracle_33.png" alt="此处输入图片的描述"></p>
<p><img src="http://wy-uploads.qiniudn.com/oracle_34.png" alt="此处输入图片的描述"></p>
<p><img src="http://wy-uploads.qiniudn.com/oracle_35.png" alt="此处输入图片的描述"><br>提示1521端口被占用，这里是因为我安装过程中修改过hostname，导致的<br><img src="http://wy-uploads.qiniudn.com/oracle_36.png" alt="此处输入图片的描述"></p>
<p><img src="http://wy-uploads.qiniudn.com/oracle_37.png" alt="此处输入图片的描述"></p>
<h2 id="安装数据库实例"><a href="#安装数据库实例" class="headerlink" title="安装数据库实例"></a>安装数据库实例</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># 在oracle用户下</div><div class="line">dbca</div></pre></td></tr></table></figure>
<p><img src="http://wy-uploads.qiniudn.com/oracle_16.png" alt="此处输入图片的描述"></p>
<p><img src="http://wy-uploads.qiniudn.com/oracle_17.png" alt="此处输入图片的描述"></p>
<p><img src="http://wy-uploads.qiniudn.com/oracle_18.png" alt="此处输入图片的描述"><br>配置全局数据库名称<br><img src="http://wy-uploads.qiniudn.com/oracle_19.png" alt="此处输入图片的描述"><br>取消EM管理界面<br><img src="http://wy-uploads.qiniudn.com/oracle_20.png" alt="此处输入图片的描述"></p>
<p><img src="http://wy-uploads.qiniudn.com/oracle_21.png" alt="此处输入图片的描述"><br>备配置置超级管理员密码，统一密码<br><img src="http://wy-uploads.qiniudn.com/oracle_22.png" alt="此处输入图片的描述"></p>
<p><img src="http://wy-uploads.qiniudn.com/oracle_23.png" alt="此处输入图片的描述"></p>
<p><img src="http://wy-uploads.qiniudn.com/oracle_24.png" alt="此处输入图片的描述"></p>
<p><img src="http://wy-uploads.qiniudn.com/oracle_25.png" alt="此处输入图片的描述"><br>修改数据库字符编码<br><img src="http://wy-uploads.qiniudn.com/oracle_26.png" alt="此处输入图片的描述"></p>
<p><img src="http://wy-uploads.qiniudn.com/oracle_27.png" alt="此处输入图片的描述"></p>
<p><img src="http://wy-uploads.qiniudn.com/oracle_28.png" alt="此处输入图片的描述"></p>
<p><img src="http://wy-uploads.qiniudn.com/oracle_29.png" alt="此处输入图片的描述"></p>
<p><img src="http://wy-uploads.qiniudn.com/oracle_30.png" alt="此处输入图片的描述"></p>
<h2 id="配置本地网络服务名"><a href="#配置本地网络服务名" class="headerlink" title="配置本地网络服务名"></a>配置本地网络服务名</h2><p>配置本地网络服务名（使服务器充当oracle客户端，连接自己，对数据库进行操作）</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># 在oracle用户下</div><div class="line">netca</div></pre></td></tr></table></figure>
<p><img src="http://wy-uploads.qiniudn.com/oracle_38.png" alt="此处输入图片的描述"><br><img src="http://wy-uploads.qiniudn.com/oracle_39.png" alt="此处输入图片的描述"><br>输入连接的oracle服务器的数据库的实例名，这里输入本机的。<br><img src="http://wy-uploads.qiniudn.com/oracle_40.png" alt="此处输入图片的描述"><br><img src="http://wy-uploads.qiniudn.com/oracle_41.png" alt="此处输入图片的描述"><br>输入oracle服务器的ip地址，这里输入本机的ip<br><img src="http://wy-uploads.qiniudn.com/oracle_42.png" alt="此处输入图片的描述"><br>选中测试<br><img src="http://wy-uploads.qiniudn.com/oracle_43.png" alt="此处输入图片的描述"><br>点击change Login 输入所连接oracle服务器的其中某一个用户名和密码，点击OK<br><img src="http://wy-uploads.qiniudn.com/oracle_44.png" alt="此处输入图片的描述"><br>看到此界面说明测试成功<br><img src="http://wy-uploads.qiniudn.com/oracle_45.png" alt="此处输入图片的描述"><br>为你所设置的本地网络服务名起个名字，与实例名不能相同<br><img src="http://wy-uploads.qiniudn.com/oracle_46.png" alt="此处输入图片的描述"><br><img src="http://wy-uploads.qiniudn.com/oracle_47.png" alt="此处输入图片的描述"></p>
<h1 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h1><h2 id="重启linux后，dbca命令无法找到"><a href="#重启linux后，dbca命令无法找到" class="headerlink" title="重启linux后，dbca命令无法找到"></a>重启linux后，dbca命令无法找到</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">vi</span> /etc/<span class="keyword">profile</span></div><div class="line"></div><div class="line"># 添加如下内容</div><div class="line"># <span class="keyword">set</span> Oracle</div><div class="line">export ORACLE_SID=demo  #数据库实例ID    </div><div class="line">export ORACLE_BASE=/DBSoft/oracle #安装目录</div><div class="line">export ORACLE_HOME=$ORACLE_BASE/product/<span class="number">11.2</span>.<span class="number">0</span>/db_1 #oracle家目录</div><div class="line">export PATH=$ORACLE_HOME/bin:$PATH</div><div class="line"></div><div class="line"># 使配置生效</div><div class="line"><span class="keyword">source</span> /etc/<span class="keyword">profile</span></div></pre></td></tr></table></figure>
<h2 id="安装oracle软件后，安装监听报错"><a href="#安装oracle软件后，安装监听报错" class="headerlink" title="安装oracle软件后，安装监听报错"></a>安装oracle软件后，安装监听报错</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">Oracle Net Services Configuration:</div><div class="line">#</div><div class="line"># An unexpected error <span class="built_in">has</span> been detected by HotSpot Virtual Machine:</div><div class="line">#</div><div class="line"># SIGSEGV (<span class="number">0</span>xb) at <span class="keyword">pc</span>=<span class="number">0</span>xa4bf5f4e, pid=<span class="number">11819</span>, tid=<span class="number">3086902976</span></div><div class="line">#</div><div class="line"># Java VM: Java HotSpot(TM) Client VM (<span class="number">1.5</span>.<span class="number">0</span>_17-b02 mixed <span class="keyword">mode</span>)</div><div class="line"># Problematic frame:</div><div class="line"># C [libclntsh.<span class="keyword">so</span>.<span class="number">11.1</span>+<span class="number">0</span>x421f4e] snlinGetAddrInfo+<span class="number">0</span>x1b2</div><div class="line">#</div><div class="line"># An error report <span class="keyword">file</span> with more information <span class="keyword">is</span> saved <span class="keyword">as</span> hs_err_pid11819.<span class="built_in">log</span></div><div class="line">#</div><div class="line"># If you would like <span class="keyword">to</span> submit <span class="keyword">a</span> bug report, please visi<span class="variable">t:</span></div><div class="line">#   http://java.<span class="keyword">sun</span>.<span class="keyword">com</span>/webapps/bugreport/crash.jsp</div><div class="line">#</div><div class="line">/u01/oracle/bin/netc<span class="variable">a:</span> <span class="built_in">line</span> <span class="number">178</span>: <span class="number">11819</span> Aborted                 $JRE $JRE_OPTIONS -classpath $CLASSPATH oracle.net.<span class="keyword">ca</span>.NetCA $*</div></pre></td></tr></table></figure>
<p>原因是安装Centos的时候，默认主机名没有修改。对其进行修改。（安装centos时，计算机名必须修改）</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">#修改<span class="built_in">hostname</span></div><div class="line"><span class="keyword">vi</span> /etc/sysconfig/network</div><div class="line">HOSTNAME=dbserver</div><div class="line">#修改hosts文件</div><div class="line"><span class="keyword">vi</span> /etc/hosts</div><div class="line"><span class="number">192.168</span>.<span class="number">1.250</span>   dbsrver localhost</div><div class="line">::<span class="number">1</span>  localhost6 localhost6.localdomain6</div></pre></td></tr></table></figure>
<h2 id="安装完监听后，启动监听报错。"><a href="#安装完监听后，启动监听报错。" class="headerlink" title="安装完监听后，启动监听报错。"></a>安装完监听后，启动监听报错。</h2><p>怀疑与安装监听时提示1521端口被占用有关</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">[oracle@dbserver database]$ netstat -<span class="keyword">an</span> | <span class="keyword">grep</span> <span class="number">1521</span></div><div class="line">[oracle@dbserver database]$ lsnrctl stat</div><div class="line"></div><div class="line">LSNRCTL <span class="keyword">for</span> Linux: Version <span class="number">11.2</span>.<span class="number">0.3</span>.<span class="number">0</span> - Production <span class="keyword">on</span> <span class="number">29</span>-MAR-<span class="number">2015</span> <span class="number">15</span>:<span class="number">09</span>:<span class="number">14</span></div><div class="line"></div><div class="line">Copyright (<span class="keyword">c</span>) <span class="number">1991</span>, <span class="number">2011</span>, Oracle.  All rights reserved.</div><div class="line"></div><div class="line">Connecting <span class="keyword">to</span> (DESCRIPTION=(ADDRESS=(PROTOCOL=TCP)(PORT=<span class="number">1521</span>)))</div><div class="line">TNS-<span class="number">12541</span>: TNS:<span class="keyword">no</span> listener</div><div class="line"> TNS-<span class="number">12560</span>: TNS:protocol adapter error</div><div class="line">  TNS-<span class="number">00511</span>: No listener</div><div class="line">   Linux Error: <span class="number">111</span>: Connection refused</div><div class="line">Connecting <span class="keyword">to</span> (DESCRIPTION=(ADDRESS=(PROTOCOL=IPC)(KEY=EXTPROC1521)))</div><div class="line">TNS-<span class="number">12541</span>: TNS:<span class="keyword">no</span> listener</div><div class="line"> TNS-<span class="number">12560</span>: TNS:protocol adapter error</div><div class="line">  TNS-<span class="number">00511</span>: No listener</div><div class="line">   Linux Error: <span class="number">2</span>: No such <span class="keyword">file</span> <span class="built_in">or</span> directory</div></pre></td></tr></table></figure>
<p>原因是 $ORAACLE_HOME/network/admin/listener.ora 文件中的 host未定义。</p>
<h1 id="其他知识"><a href="#其他知识" class="headerlink" title="其他知识"></a>其他知识</h1><h2 id="数据库名、实例名、SID、服务名、网络服务名"><a href="#数据库名、实例名、SID、服务名、网络服务名" class="headerlink" title="数据库名、实例名、SID、服务名、网络服务名"></a>数据库名、实例名、SID、服务名、网络服务名</h2><p>数据库名：建数据库时候填写的global database name（<code>select name from v$database;</code>）<br>SID：建数据库时候填写的SID<br>实例名：与数据库名一致（<code>select instance_name from v$instance</code>）</p>
<h2 id="Linux-oracle数据库listener-ora存放路径"><a href="#Linux-oracle数据库listener-ora存放路径" class="headerlink" title="Linux oracle数据库listener.ora存放路径"></a>Linux oracle数据库listener.ora存放路径</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">cd</span> /data/DBSoft/oracle/product/<span class="number">11.2</span>.<span class="number">0</span>/db_1/network/admin/listener.ora</div></pre></td></tr></table></figure>
<h2 id="Linux-oracle数据库tnsnames-ora存放路径"><a href="#Linux-oracle数据库tnsnames-ora存放路径" class="headerlink" title="Linux oracle数据库tnsnames.ora存放路径"></a>Linux oracle数据库tnsnames.ora存放路径</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">cd</span> /data/DBSoft/oracle/product/<span class="number">11.2</span>.<span class="number">0</span>/db_1/network/admin/tnsnames.ora</div></pre></td></tr></table></figure>
<h2 id="ORACLE多个实例"><a href="#ORACLE多个实例" class="headerlink" title="ORACLE多个实例"></a>ORACLE多个实例</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">LISTENER =</div><div class="line">  (DESCRIPTION_LIST =</div><div class="line">    (DESCRIPTION =</div><div class="line">      (ADDRESS = (PROTOCOL = TCP)(HOST = localhost)(PORT = <span class="number">1521</span>))</div><div class="line">      (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1521))</div><div class="line">    )</div><div class="line">  )</div><div class="line">  </div><div class="line">#SID1、SID2即为<span class="number">2</span>个实例名称</div><div class="line">SID_LIST_LISTENER =</div><div class="line">  (SID_LIST =</div><div class="line">    (SID_DESC =</div><div class="line">      (GLOBAL_DBNAME = SID1)</div><div class="line">      (ORACLE_HOME = /data/DBSoft/oracle/product/<span class="number">11.2</span>.<span class="number">0</span>/db_1)</div><div class="line">      (SID_NAME = SID1)</div><div class="line">    )</div><div class="line">    (SID_DESC =</div><div class="line">      (GLOBAL_DBNAME = SID2)</div><div class="line">      (ORACLE_HOME = /data/DBSoft/oracle/product/<span class="number">11.2</span>.<span class="number">0</span>/db_1)</div><div class="line">      (SID_NAME = SID2)</div><div class="line">    )</div><div class="line">  )</div></pre></td></tr></table></figure>
<h2 id="ORACLE启动监听器"><a href="#ORACLE启动监听器" class="headerlink" title="ORACLE启动监听器"></a>ORACLE启动监听器</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">#切换至oracle安装用户（一般为oracle）</div><div class="line">su - oracle </div><div class="line">#启动监听器</div><div class="line">lsnrctl start </div><div class="line">#停止监听器</div><div class="line">lsnrctl <span class="keyword">stop</span></div></pre></td></tr></table></figure>
<h2 id="启动测试oracle"><a href="#启动测试oracle" class="headerlink" title="启动测试oracle"></a>启动测试oracle</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[oracle@oracle ~]$ sqlplus /nolog</div><div class="line">SQL*Plu<span class="variable">s:</span> Release <span class="number">11.2</span>.<span class="number">0.1</span>.<span class="number">0</span> Production <span class="keyword">on</span> Fri Jul <span class="number">27</span> <span class="number">02</span>:<span class="number">12</span>:<span class="number">12</span> <span class="number">2012</span></div><div class="line">Copyright (<span class="keyword">c</span>) <span class="number">1982</span>, <span class="number">2009</span>, Oracle. All rights reserved.</div><div class="line">#关闭数据库</div><div class="line">SQL&gt; shutdown</div><div class="line">#启动数据库</div><div class="line">SQL&gt; startup</div><div class="line">SQL&gt; <span class="keyword">quit</span></div></pre></td></tr></table></figure>
<p>测试的另一种方法：找一台windows平台电脑，telnet oracle主机IP地址：1521，通的话，会出现一个黑屏，光标一闪一闪。</p>
<h2 id="Linux开放1521端口允许网络连接Oracle-Listener"><a href="#Linux开放1521端口允许网络连接Oracle-Listener" class="headerlink" title="Linux开放1521端口允许网络连接Oracle Listener"></a>Linux开放1521端口允许网络连接Oracle Listener</h2><p>症状：<br>(1)TCP/IP连接是通的。可以用ping 命令测试。<br>(2)服务器上Oracle Listener已经启动。<br>lsnrctl status 查看listener状态<br>lsnrctl start 启动Oracle listener<br>(3)客户端得到的错误信息通常是：ORA-12170： TNS:连接超时<br>这时，我们基本可以肯定是服务器没有开放1521端口（假设你用默认设置）</p>
<p>解决方法：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">#编辑iptables, 开放<span class="number">1521</span>端口：</div><div class="line"><span class="keyword">vi</span> /etc/sysconfig/iptables</div><div class="line">-A INPUT -<span class="keyword">p</span> tcp -<span class="keyword">m</span> state --state NEW -<span class="keyword">m</span> tcp --dport <span class="number">1521</span> -<span class="keyword">j</span> ACCEPT </div><div class="line"></div><div class="line">#保存配置，以便linux重启后依然有效</div><div class="line">service iptables save </div><div class="line">#重启防火墙,使规则生效</div><div class="line">service iptables restart</div><div class="line">#查看防火墙规则：</div><div class="line">iptables -L –n</div></pre></td></tr></table></figure>
<h2 id="linux下创建oracle用户表空间"><a href="#linux下创建oracle用户表空间" class="headerlink" title="linux下创建oracle用户表空间"></a>linux下创建oracle用户表空间</h2><p>就是在已有的数据库实例上创建一个新的帐号，访问一些新的表<br>操作步骤如下：<br>(1)登录linux，以oracle用户登录（如果是root用户登录的，登录后用 su - oracle命令切换成oracle用户）<br>(2)以sysdba方式来打开sqlplus，命令如下： </p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sqlplus <span class="string">"/as sysdba"</span></div><div class="line">#使用sysdba打开可能会报ORA-<span class="number">12162</span>错误，因为ORACLE_SID未定义</div><div class="line">export ORACLE_SID=dbmaster</div></pre></td></tr></table></figure>
<p>(3)查看我们常规将用户表空间放置位置：执行如下</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sql：select name from v$datafile;</div></pre></td></tr></table></figure>
<p>(4)创建用户表空间：<br>根据上步查询出的路径，新建用户表空间</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">create tablespace ts_UserName datafile</div><div class="line"><span class="string">'/data/dbdata/ewm/UserName_data01.dbf'</span> size <span class="number">2</span>G autoextend <span class="keyword">on</span> <span class="keyword">next</span> <span class="number">100</span>M maxsize <span class="number">31</span>g,</div><div class="line"><span class="string">'/data/dbdata/ewm/UserName_data02.dbf'</span> size <span class="number">2</span>G autoextend <span class="keyword">on</span> <span class="keyword">next</span> <span class="number">100</span>M maxsize <span class="number">31</span>g,</div><div class="line">'/data/dbdata/ewm/UserName_data03.dbf' size 2G autoextend on next 100M maxsize 31g;</div></pre></td></tr></table></figure>
<p>(5)创建用户，指定密码和上边创建的用户表空间</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">#注意：oracle有个毛病，密码必须以字母开头，如果以数字开头，它不会创建用户</div><div class="line">create user UserName identified by PassWord default tablespace ts_UserName profile DEFAULT;</div></pre></td></tr></table></figure>
<p>(6)赋予权限</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">grant create database link to UserName;</div><div class="line">grant create procedure to UserName;</div><div class="line">grant create sequence to UserName;</div><div class="line">grant create session to UserName;</div><div class="line">grant create synonym to UserName;</div><div class="line">grant create table to UserName;</div><div class="line">grant create trigger to UserName;</div><div class="line">grant create view to UserName;</div><div class="line">grant select any dictionary to UserName;</div><div class="line">grant select any table to UserName;</div><div class="line">grant unlimited tablespace to UserName;</div><div class="line">grant update any table to UserName;</div><div class="line">grant debug connect session to UserName;</div><div class="line">grant dba to UserName;</div></pre></td></tr></table></figure>
<p>–经过以上操作，我们就可以使用UserName/PassWord登录指定的实例，创建我们自己的表了</p>
<h2 id="设置Oracle自启动"><a href="#设置Oracle自启动" class="headerlink" title="设置Oracle自启动"></a>设置Oracle自启动</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">su root</div><div class="line"><span class="keyword">vi</span> /etc/oratab</div><div class="line">#将末尾的<span class="keyword">N</span>修改为Y</div><div class="line">dbmaster:/data/DBSoft/oracle/product/<span class="number">11.2</span>.<span class="number">0</span>/db_1:Y</div><div class="line">#修改linux自启动文件</div><div class="line"><span class="keyword">vi</span> /etc/rc.d/rc.local</div><div class="line">su oracle -<span class="keyword">lc</span> <span class="string">"/data/DBSoft/oracle/product/11.2.0/db_1/bin/lsnrctl start"</span></div><div class="line"></div><div class="line">su oracle -<span class="keyword">lc</span> <span class="string">"/data/DBSoft/oracle/product/11.2.0/db_1/bin/dbstart"</span></div></pre></td></tr></table></figure>
<p>参考博客：<br> <a href="http://www.blogjava.net/icewee/archive/2013/01/30/394943.html" target="_blank" rel="external">Linux 64bit下Oracle11g安装手册</a><br> <a href="http://www.cnblogs.com/mophee/archive/2013/06/01/3107137.html" target="_blank" rel="external">亦步亦趋完成在CentOS 6.4下安装Oracle 11gR2</a><br> <a href="http://www.xiyang-liu.com/2012/11/install-oracle-dbserver-with-xmanager-in-windows/" target="_blank" rel="external">使用远程X Server安装Oracle</a><br> <a href="http://www.cnblogs.com/linjiqin/category/349944.html" target="_blank" rel="external">oracle初级系列教程</a></p>
]]></content>
      
        <categories>
            
            <category> 技术 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Oracle </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[CentOS 安装与调优配置]]></title>
      <url>/2015/07/16/CentOS-System-Performance-tuning/</url>
      <content type="html"><![CDATA[<h2 id="分区"><a href="#分区" class="headerlink" title="分区"></a>分区</h2><p>至少2个分区，/以及swap分区。另外设置独立/boot分区。<br>所以生产环境分3个分区。</p>
<p>分区案例：<a href="http://oldboy.blog.51cto.com/2561410/634725" target="_blank" rel="external">http://oldboy.blog.51cto.com/2561410/634725</a></p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">#分区查看</div><div class="line">df -Th</div><div class="line"></div><div class="line">Filesystem     Type   Size  Used Avail Use% Mounted <span class="keyword">on</span></div><div class="line">/dev/sda2      ext4   <span class="number">8.6</span>G  <span class="number">2.5</span>G  <span class="number">5.7</span>G  <span class="number">31</span>% /</div><div class="line">tmpfs          tmpfs  <span class="number">242</span>M     <span class="number">0</span>  <span class="number">242</span>M   <span class="number">0</span>% /dev/shm</div><div class="line">/dev/sda1      ext4   <span class="number">190</span>M   <span class="number">53</span>M  <span class="number">128</span>M  <span class="number">30</span>% /boot</div></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="挂载新硬盘"><a href="#挂载新硬盘" class="headerlink" title="挂载新硬盘"></a>挂载新硬盘</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"># 查看新加硬盘的文件名</div><div class="line">fdisk -<span class="keyword">l</span></div><div class="line"></div><div class="line"># 对新硬盘进行分区</div><div class="line">fdisk /dev/sdb</div><div class="line"></div><div class="line"># 查看分区的格式类型</div><div class="line">df -Th</div><div class="line"></div><div class="line"># 对新分区进行格式化</div><div class="line">mkfs -t ext4 /dev/sdb1</div><div class="line"></div><div class="line"># 新建目录，并将分区挂载到目录下</div><div class="line"><span class="built_in">mkdir</span> /data</div><div class="line">mount /dev/sdb1 /data</div><div class="line"></div><div class="line"># 修改/etc/fstab文件，让开机自动挂载</div><div class="line">/dev/sdb1   /data   ext4   defaults    <span class="number">1</span> <span class="number">2</span></div></pre></td></tr></table></figure>
<h2 id="IP地址，DNS设置"><a href="#IP地址，DNS设置" class="headerlink" title="IP地址，DNS设置"></a>IP地址，DNS设置</h2><h3 id="ip地址"><a href="#ip地址" class="headerlink" title="ip地址"></a>ip地址</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">vi</span> /etc/sysconfig/network-scripts/ifcfg-eth0</div><div class="line"></div><div class="line">DEVICE=eth0</div><div class="line">IPADDR=<span class="number">192.168</span>.<span class="number">1.250</span></div><div class="line">NETMASK=<span class="number">255.255</span>.<span class="number">255.0</span></div><div class="line">GATEWAY=<span class="number">192.168</span>.<span class="number">1.1</span></div><div class="line">HWADDR=<span class="number">00</span>:<span class="number">0</span>C:<span class="number">29</span>:F2:<span class="number">14</span>:C7</div><div class="line">TYPE=Ethernet</div><div class="line">UUID=<span class="number">640</span>ec151-<span class="number">26</span>d6-<span class="number">4966</span>-beb4-<span class="number">6</span>de0c2306beb</div><div class="line">ONBOOT=yes</div><div class="line">NM_CONTROLLED=yes</div><div class="line">BOOTPROTO=static</div></pre></td></tr></table></figure>
<h3 id="DNS设置"><a href="#DNS设置" class="headerlink" title="DNS设置"></a>DNS设置</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">vi</span> /etc/resolv.<span class="keyword">conf</span></div><div class="line"></div><div class="line">nameserver <span class="number">114.114</span>.<span class="number">114.114</span></div></pre></td></tr></table></figure>
<h2 id="yum源修改"><a href="#yum源修改" class="headerlink" title="yum源修改"></a>yum源修改</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">cd</span> /etc/yum.repos.d</div><div class="line">mv CentOS-Base.repo CentOS-Base.repo.bk </div><div class="line">wget http://mirrors.aliyun.<span class="keyword">com</span>/repo/Centos-<span class="number">6</span>.repo</div><div class="line">mv Centos-<span class="number">6</span>.repo CentOS-Base.repo</div><div class="line">yum makecache</div><div class="line"></div><div class="line">#更新系统</div><div class="line">yum <span class="keyword">update</span></div><div class="line"></div><div class="line">#安装lrzsz上传下载工具</div><div class="line">yum install lrzsz</div></pre></td></tr></table></figure>
<h2 id="开机启动项优化"><a href="#开机启动项优化" class="headerlink" title="开机启动项优化"></a>开机启动项优化</h2><p>1、图形界面禁止或启动服务<br>使用<code>setup</code>或者<code>ntsysv</code>命令</p>
<p>2、脚本实现禁止或启动服务</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">#禁止全部服务</div><div class="line">for service in `chkconfig --list | grep 3:启用 | awk '&#123;print $1&#125;'`;do chkconfig --level 3 $service off;done</div><div class="line"></div><div class="line">#启用需要用到的服务</div><div class="line">for service in crond network sysstat sshd iptables;do chkconfig --level 3 $service on;done</div></pre></td></tr></table></figure>
<h2 id="SSH登陆设置"><a href="#SSH登陆设置" class="headerlink" title="SSH登陆设置"></a>SSH登陆设置</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">cp</span> /etc/ssh/sshd_config /etc/ssh/sshd_config.bk</div><div class="line"><span class="keyword">vi</span> /etc/ssh/sshd_config </div><div class="line"></div><div class="line">###By Mr-wang <span class="number">2015</span>-<span class="number">03</span>-<span class="number">20</span>###</div><div class="line">    Port <span class="number">22</span></div><div class="line">    PermitRootLogin <span class="keyword">no</span></div><div class="line">    PermitEmptyPasswords <span class="keyword">no</span></div><div class="line">    UseDNS <span class="keyword">no</span></div><div class="line">###By Mr-wang <span class="number">2015</span>-<span class="number">03</span>-<span class="number">20</span>###</div></pre></td></tr></table></figure>
<p>sshd_config 中文手册：<a href="http://www.jinbuguo.com/openssh/sshd_config.html" target="_blank" rel="external">http://www.jinbuguo.com/openssh/sshd_config.html</a></p>
<h2 id="修改中文显示"><a href="#修改中文显示" class="headerlink" title="修改中文显示"></a>修改中文显示</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">echo</span> <span class="string">'LANG="zh_CN.UTF-8"'</span> &gt; /etc/sysconfig/i18n</div></pre></td></tr></table></figure>
<p>注：&gt; 代表重写入   &gt;&gt; 代表追加</p>
<h2 id="服务器时间同步"><a href="#服务器时间同步" class="headerlink" title="服务器时间同步"></a>服务器时间同步</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">echo</span> <span class="string">'0 0 */1 * * /usr/sbin/ntpdate 210.72.145.44 &gt; /dev/null 2&gt;&amp;1'</span> &gt;&gt; /var/spool/cron/root</div></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> 技术 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Vsftpd安装配置]]></title>
      <url>/2015/07/16/Install-Vsftpd/</url>
      <content type="html"><![CDATA[<p>安装vsftp</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install -<span class="keyword">y</span> vsftpd</div></pre></td></tr></table></figure>
<p>将vsftpd加入系统自启动，并启动服务</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">service vsftpd start</div><div class="line">chkconfig --level <span class="number">3</span> vsftpd <span class="keyword">on</span></div></pre></td></tr></table></figure>
<a id="more"></a> 
<p>配置文件：</p>
<p>/etc/vsftpd/vsftpd.conf   //主配置文件<br>/etc/vsftpd/ftpusers //被禁止登录FTP的用户文件<br>/etc/vsftpd/user_list    //允许登录FTP的用户文件<br>/etc/vsftpd/userconfig   //用户目录配置文件</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div></pre></td><td class="code"><pre><div class="line">#匿名账号是否允许登陆</div><div class="line">#anonymous_enable=YES</div><div class="line"> </div><div class="line">#设定本地用户可以访问。注：如使用虚拟宿主用户，在该项目设定为NO的情况下所有虚拟用户将无法访问。</div><div class="line">local_enable=YES</div><div class="line"> </div><div class="line">#使用户不能离开主目录</div><div class="line">#chroot_local_user=YES</div><div class="line"> </div><div class="line">#是否可以写入</div><div class="line">write_enable=YES</div><div class="line"> </div><div class="line"># Default umask <span class="keyword">for</span> local users <span class="keyword">is</span> <span class="number">077</span>. You may wish <span class="keyword">to</span> <span class="keyword">change</span> this <span class="keyword">to</span> <span class="number">022</span>,</div><div class="line"># <span class="keyword">if</span> your users expect that (<span class="number">022</span> <span class="keyword">is</span> used by most other ftpd<span class="string">'s)</span></div><div class="line"><span class="string">#设定上传后文件的权限掩码</span></div><div class="line"><span class="string">local_umask=022</span></div><div class="line"><span class="string">#</span></div><div class="line"><span class="string"># Uncomment this to allow the anonymous FTP user to upload files. This only</span></div><div class="line"><span class="string"># has an effect if the above global write enable is activated. Also, you will</span></div><div class="line"><span class="string"># obviously need to create a directory writable by the FTP user.</span></div><div class="line"><span class="string">#匿名用户是否可以上传</span></div><div class="line"><span class="string">#anon_upload_enable=YES</span></div><div class="line"><span class="string">anon_upload_enable=NO</span></div><div class="line"><span class="string">#</span></div><div class="line"><span class="string"># Uncomment this if you want the anonymous FTP user to be able to create</span></div><div class="line"><span class="string"># new directories.</span></div><div class="line"><span class="string">#匿名用户是否可以建立目录</span></div><div class="line"><span class="string">#anon_mkdir_write_enable=YES</span></div><div class="line"><span class="string">anon_mkdir_write_enable=NO</span></div><div class="line"><span class="string">#</span></div><div class="line"><span class="string"># Activate directory messages - messages given to remote users when they</span></div><div class="line"><span class="string"># go into a certain directory.</span></div><div class="line"><span class="string">#进入每个目录是否显示欢迎信息，在每个目录下建立.message文件在里面写欢迎信息</span></div><div class="line"><span class="string">dirmessage_enable=YES</span></div><div class="line"><span class="string">#</span></div><div class="line"><span class="string"># The target log file can be vsftpd_log_file or xferlog_file.</span></div><div class="line"><span class="string"># This depends on setting xferlog_std_format parameter</span></div><div class="line"><span class="string">#上传/下载文件时是否记录日志</span></div><div class="line"><span class="string">xferlog_enable=YES</span></div><div class="line"><span class="string">#</span></div><div class="line"><span class="string"># Make sure PORT transfer connections originate from port 20 (ftp-data).</span></div><div class="line"><span class="string">#是否使用port主动模式</span></div><div class="line"><span class="string">port_enable=YES</span></div><div class="line"><span class="string">#是否使用20端口传输数据</span></div><div class="line"><span class="string">connect_from_port_20=YES</span></div><div class="line"><span class="string">#不使用20端口时，指定port模式的端口号</span></div><div class="line"><span class="string">#ftp_data_port=2020</span></div><div class="line"><span class="string">#是否使用安全的port模式</span></div><div class="line"><span class="string">port_promiscuous=NO</span></div><div class="line"><span class="string">#</span></div><div class="line"><span class="string"># If you want, you can arrange for uploaded anonymous files to be owned by</span></div><div class="line"><span class="string"># a different user. Note! Using "root" for uploaded files is not</span></div><div class="line"><span class="string"># recommended!</span></div><div class="line"><span class="string">#匿名用户上传文件是否更改宿主</span></div><div class="line"><span class="string">#chown_uploads=YES</span></div><div class="line"><span class="string">#匿名用户上传文件宿主更改为谁</span></div><div class="line"><span class="string">#chown_username=whoever</span></div><div class="line"><span class="string">#</span></div><div class="line"><span class="string"># The name of log file when xferlog_enable=YES and xferlog_std_format=YES</span></div><div class="line"><span class="string"># WARNING - changing this filename affects /etc/logrotate.d/vsftpd.log</span></div><div class="line"><span class="string">#设定Vsftpd的服务日志保存路径，需手动创建该文件并有写入权限</span></div><div class="line"><span class="string">xferlog_file=/var/log/xferlog</span></div><div class="line"><span class="string">#</span></div><div class="line"><span class="string"># Switches between logging into vsftpd_log_file and xferlog_file files.</span></div><div class="line"><span class="string"># NO writes to vsftpd_log_file, YES to xferlog_file</span></div><div class="line"><span class="string">#设定日志使用标准的记录格式</span></div><div class="line"><span class="string">xferlog_std_format=YES</span></div><div class="line"><span class="string">#</span></div><div class="line"><span class="string"># You may change the default value for timing out an idle session.</span></div><div class="line"><span class="string">#设定空闲连接超时时间，如果不指定的话，还是使用这里的默认值600，单位秒</span></div><div class="line"><span class="string">#idle_session_timeout=600</span></div><div class="line"><span class="string">#</span></div><div class="line"><span class="string"># You may change the default value for timing out a data connection.</span></div><div class="line"><span class="string">#设定单次最大连续传输时间，如果不指定的话，还是使用这里的默认值120，单位秒</span></div><div class="line"><span class="string">#data_connection_timeout=120</span></div><div class="line"><span class="string">#</span></div><div class="line"><span class="string"># It is recommended that you define on your system a unique user which the</span></div><div class="line"><span class="string"># ftp server can use as a totally isolated and unprivileged user.</span></div><div class="line"><span class="string">#设定支撑Vsftpd服务的宿主用户</span></div><div class="line"><span class="string">#nopriv_user=ftpsecure</span></div><div class="line"><span class="string">#</span></div><div class="line"><span class="string"># Enable this and the server will recognise asynchronous ABOR requests. Not</span></div><div class="line"><span class="string"># recommended for security (the code is non-trivial). Not enabling it,</span></div><div class="line"><span class="string"># however, may confuse older FTP clients.</span></div><div class="line"><span class="string">#设定是否支持异步传输功能</span></div><div class="line"><span class="string">#async_abor_enable=YES</span></div><div class="line"><span class="string">#</span></div><div class="line"><span class="string"># By default the server will pretend to allow ASCII mode but in fact ignore</span></div><div class="line"><span class="string"># the request. Turn on the below options to have the server actually do ASCII</span></div><div class="line"><span class="string"># mangling on files when in ASCII mode.</span></div><div class="line"><span class="string"># Beware that on some FTP servers, ASCII support allows a denial of service</span></div><div class="line"><span class="string"># attack (DoS) via the command "SIZE /big/file" in ASCII mode. vsftpd</span></div><div class="line"><span class="string"># predicted this attack and has always been safe, reporting the size of the</span></div><div class="line"><span class="string"># raw file.</span></div><div class="line"><span class="string"># ASCII mangling is a horrible feature of the protocol.</span></div><div class="line"><span class="string">#设定支持ASCII模式的上传和下载功能</span></div><div class="line"><span class="string">ascii_upload_enable=YES</span></div><div class="line"><span class="string">ascii_download_enable=YES</span></div><div class="line"><span class="string"> </span></div><div class="line"><span class="string"># You may fully customise the login banner string:</span></div><div class="line"><span class="string">#设定Vsftpd的登陆标语</span></div><div class="line"><span class="string">#ftpd_banner=Welcome to blah FTP service.</span></div><div class="line"><span class="string">#</span></div><div class="line"><span class="string"># You may specify a file of disallowed anonymous e-mail addresses. Apparently</span></div><div class="line"><span class="string"># useful for combatting certain DoS attacks.</span></div><div class="line"><span class="string">#deny_email_enable=YES</span></div><div class="line"><span class="string"># (default follows)</span></div><div class="line"><span class="string">#banned_email_file=/etc/vsftpd/banned_emails</span></div><div class="line"><span class="string">#</span></div><div class="line"><span class="string"># You may specify an explicit list of local users to chroot() to their home</span></div><div class="line"><span class="string"># directory. If chroot_local_user is YES, then this list becomes a list of</span></div><div class="line"><span class="string"># users to NOT chroot().</span></div><div class="line"><span class="string">#是否限制所有的本地用户在自家目录</span></div><div class="line"><span class="string">#chroot_local_user=YES</span></div><div class="line"><span class="string">#是否允许chroot_list中用户登出自己的FTP主目录</span></div><div class="line"><span class="string">#chroot_list_enable=YES</span></div><div class="line"><span class="string"># (default follows)</span></div><div class="line"><span class="string">#配置chroot_list文件路径</span></div><div class="line"><span class="string">#chroot_list_file=/etc/vsftpd/chroot_list</span></div><div class="line"><span class="string">#</span></div><div class="line"><span class="string"># You may activate the "-R" option to the builtin ls. This is disabled by</span></div><div class="line"><span class="string"># default to avoid remote users being able to cause excessive I/O on large</span></div><div class="line"><span class="string"># sites. However, some broken FTP clients such as "ncftp" and "mirror" assume</span></div><div class="line"><span class="string"># the presence of the "-R" option, so there is a strong case for enabling it.</span></div><div class="line"><span class="string">#是否允许使用ls -R命令，该命令会对服务器性能造成巨大开销</span></div><div class="line"><span class="string">#ls_recurse_enable=YES</span></div><div class="line"><span class="string">#</span></div><div class="line"><span class="string"># When "listen" directive is enabled, vsftpd runs in standalone mode and</span></div><div class="line"><span class="string"># listens on IPv4 sockets. This directive cannot be used in conjunction</span></div><div class="line"><span class="string"># with the listen_ipv6 directive.</span></div><div class="line"><span class="string">#开启ipv4监听</span></div><div class="line"><span class="string">listen=YES</span></div><div class="line"><span class="string">#设定ipv4监听端口</span></div><div class="line"><span class="string">listen_port=2121</span></div><div class="line"><span class="string">#</span></div><div class="line"><span class="string"># This directive enables listening on IPv6 sockets. To listen on IPv4 and IPv6</span></div><div class="line"><span class="string"># sockets, you must run two copies of vsftpd with two configuration files.</span></div><div class="line"><span class="string"># Make sure, that one of the listen options is commented !!</span></div><div class="line"><span class="string">#开启ipv6监听</span></div><div class="line"><span class="string">#listen_ipv6=YES</span></div><div class="line"><span class="string"> </span></div><div class="line"><span class="string">#使用pam模块控制，vsftpd文件在/etc/pam.d目录下</span></div><div class="line"><span class="string">pam_service_name=vsftpd</span></div><div class="line"><span class="string"> </span></div><div class="line"><span class="string">#userlist_enable、userlist_deny配合使用，userlist_enable选项被激活后，vsftpd将读取userlist_file参数所指定的文件中的用户列表，而userlist_deny选项定义list中用户是否被禁止登陆。当列表中的用户登录FTP服务器时，该用户在提示输入密码之前就被禁止了。即该用户名输入后，vsftpd查到该用户名在列表中，vsftpd就直接禁止掉该用户，不会再进行询问密码等后续步聚</span></div><div class="line"><span class="string">#userlist_enable=YES</span></div><div class="line"><span class="string">#userlist_file=/etc/vsftpd/vsftpd.user_list</span></div><div class="line"><span class="string">#userlist_deny=YES</span></div><div class="line"><span class="string"> </span></div><div class="line"><span class="string">#是否允许tcp_wrappers管理</span></div><div class="line"><span class="string">tcp_wrappers=YES</span></div><div class="line"><span class="string"> </span></div><div class="line"><span class="string">#所有用户的根目录，，对匿名用户无效</span></div><div class="line"><span class="string">#local_root=/home/ftp</span></div><div class="line"><span class="string"> </span></div><div class="line"><span class="string">#匿名用户的最大传输速度，单位是Byts/s</span></div><div class="line"><span class="string">#anon_max_rate=1024000</span></div><div class="line"><span class="string"> </span></div><div class="line"><span class="string">#本地用户的最大传输速度，单位是Byts/s</span></div><div class="line"><span class="string">#local_max_rate=1024000</span></div><div class="line"><span class="string"> </span></div><div class="line"><span class="string">#是否使用pasv被动模式</span></div><div class="line"><span class="string">pasv_enable=YES</span></div><div class="line"><span class="string">#指定被动模式的最小、最大端口</span></div><div class="line"><span class="string">pasv_min_port=2123</span></div><div class="line"><span class="string">pasv_max_port=2125</span></div><div class="line"><span class="string">#是否屏蔽对pasv进行安全检查</span></div><div class="line"><span class="string">pasv_promiscuous=NO</span></div><div class="line"><span class="string">#被动模式是否用设置好的的地址返回给客户端</span></div><div class="line"><span class="string">#pasv_addr_resolve=YES</span></div><div class="line"><span class="string">#服务器传回的ip地址，让客户端知道</span></div><div class="line"><span class="string">#pasv_address=101.71.51.65</span></div></pre></td></tr></table></figure>
<p><a href="http://heylinux.com/archives/356.html" target="_blank" rel="external">基于本地用户的Vsftp配置</a><br><a href="http://heylinux.com/archives/713.html" target="_blank" rel="external">Vsftp服务器配置详解</a></p>
]]></content>
      
        <categories>
            
            <category> 技术 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> vsftp,ftp </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[CentOS下nginx安装]]></title>
      <url>/2015/07/16/CentOS-nginx-installation/</url>
      <content type="html"><![CDATA[<p>1.最小化安装的CentOS没有安装gcc，首先安装gcc、g++和c++库；</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum -<span class="keyword">y</span> install gcc-<span class="keyword">c</span>++</div></pre></td></tr></table></figure>
<p>2.安装pcre库，pcre库是为了使nginx支持http rewrite模块；</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">cd</span> /usr/local/</div><div class="line">wget ftp://ftp.csx.cam.ac.uk/pub/software/programming/pcre/pcre-<span class="number">8.35</span>.tar.gz</div><div class="line">tar -zxvf pcre-<span class="number">8.35</span>.tar.gz</div><div class="line"><span class="keyword">cd</span> pcre-<span class="number">8.35</span></div><div class="line">./configure</div><div class="line"><span class="keyword">make</span></div><div class="line"><span class="keyword">make</span> install</div></pre></td></tr></table></figure>
<a id="more"></a>
<p>3.安装nginx，选择 Nginx 安装到 /usr/local/nginx 目录下；</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">cd</span> /usr/local/</div><div class="line">wget http://nginx.org/download/nginx-<span class="number">1.2</span>.<span class="number">8</span>.tar.gz</div><div class="line">tar -zxvf nginx-<span class="number">1.6</span>.<span class="number">2</span>.tar.gz</div><div class="line"><span class="keyword">cd</span> nginx-<span class="number">1.6</span>.<span class="number">2</span></div><div class="line">./configure –prefix=/usr/local/nginx –with-http_stub_status_module –with-http_gzip_static_module</div><div class="line"><span class="keyword">make</span></div><div class="line"><span class="keyword">make</span> install</div></pre></td></tr></table></figure>
<p>–with-http_stub_status_module可以启动Nginx的NginxStatus功能，以监控Nginx的当前状态。</p>
<p>4.启动nginx 确保系统的 80 端口没被其他程序占用；</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/local/nginx/sbin/nginx</div></pre></td></tr></table></figure>
<p>启动报错</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/local/nginx/sbin/nginx: error <span class="keyword">while</span> loading shared librarie<span class="variable">s:</span> libpcre.<span class="keyword">so</span>.<span class="number">1</span>: cannot <span class="keyword">open</span> shared object <span class="keyword">file</span>: No such <span class="keyword">file</span> <span class="built_in">or</span> directory</div></pre></td></tr></table></figure>
<p>解决：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">ls</span> /lib/ |<span class="keyword">grep</span> pcre</div><div class="line">libpcre.<span class="keyword">so</span>.<span class="number">0</span></div><div class="line">libpcre.<span class="keyword">so</span>.<span class="number">0.0</span>.<span class="number">1</span></div><div class="line">#添加软连接</div><div class="line"><span class="keyword">ln</span> -s /lib/libpcre.<span class="keyword">so</span>.<span class="number">0.0</span>.<span class="number">1</span> /lib/libpcre.<span class="keyword">so</span>.<span class="number">1</span></div></pre></td></tr></table></figure>
<p>检查是否启动成功： netstat -ano|grep 80 有结果输入说明启动成功 打开浏览器访问此机器的 IP，如果浏览器出现 Welcome to nginx! 则表示 Nginx 已经安装并运行成功。</p>
<p>5./usr/local/nginx/config/nginx.conf配置文件详解：<br>Nginx的全局属性配置：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">#定义Nginx运行的用户和用户组</div><div class="line">user nobody nobody;</div><div class="line">#nginx进程数，建议设置为等于CPU总核心数。</div><div class="line">worker_processes 4;</div><div class="line">#全局错误日志定义类型，[ <span class="keyword">debug</span> | info | notice | warn | error | crit ]，其中<span class="keyword">debug</span>输出的日志最为详细，而crit输出日志最少</div><div class="line">error_log /var/log/nginx/error.log info;</div><div class="line">#进程文件，指定进程id的存储文件位置</div><div class="line">pid /var/run/nginx.pid;</div><div class="line">#一个nginx进程打开的最多文件描述符数目，理论值应该是最多打开文件数（系统的值ulimit -n）与nginx进程数相除，但是nginx分配请求并不均匀，所以建议与ulimit -n的值保持一致。</div><div class="line">worker_rlimit_nofile 65535;</div><div class="line">#工作模式与连接数上限</div><div class="line">events</div><div class="line">&#123;</div><div class="line"># 参考事件模型，use [ kqueue | rtsig | epoll | /dev/poll | select | poll ]; 其中select和poll都是标准的工作模式，kqueue和epoll是高效的工作模式，不同的是epoll模型是Linux 2.6以上版本内核中的高性能网络I/O模型，如果跑在FreeBSD上面，就用kqueue模型。</div><div class="line">use epoll;</div><div class="line">#单个进程最大连接数（最大连接数=连接数*进程数）</div><div class="line">worker_connections 65535;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>6.http服务器配置：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">http&#123;</div><div class="line">#设定mime类型,类型由mime.<span class="built_in">type</span>文件定义</div><div class="line">include      conf/mime.types;</div><div class="line">default_type  application/octet-stream;</div><div class="line">#设定日志格式</div><div class="line">log_format main ‘$remote_addr – $remote_user [$time_local] ‘</div><div class="line"> ‘“$request” $status $bytes_sent ‘</div><div class="line"> ‘“$http_referer” “$http_user_agent” ‘</div><div class="line"> ‘“$gzip_ratio”‘;</div><div class="line"> log_format download ‘$remote_addr – $remote_user [$time_local] ‘</div><div class="line"> ‘“$request” $status $bytes_sent ‘</div><div class="line"> ‘“$http_referer” “$http_user_agent” ‘</div><div class="line"> ‘“$http_range” “$sent_http_content_range”‘;</div><div class="line">#设置允许客户端请求的最大的单个文件字节数</div><div class="line">client_max_body_size  20m;</div><div class="line">#设置来自客户端请求头的headerbuffer大小，即缓存区大小</div><div class="line">client_header_buffer_size    32K;</div><div class="line">#用来指定客户端请求中较大的消息头的缓存最大数量和大小，<span class="number">4</span>为个数，<span class="number">32</span><span class="keyword">k</span>为大小，最大缓存<span class="number">4</span>个<span class="number">32</span>K</div><div class="line">large_client_header_buffers  4 32k;</div><div class="line">#sendfile 指令指定 nginx 是否调用 sendfile 函数（zero <span class="keyword">copy</span> 方式）来输出文件</div><div class="line">#对于普通应用，必须设为 <span class="keyword">on</span>,用来进行下载等应用磁盘IO重负载应用，可设置为 off，以平衡磁盘与网络I/O处理速度，降低系统的uptime.</div><div class="line">#tcp_nopush和tcp_nodely两个指令设置为<span class="keyword">on</span>，用于防止网络阻塞</div><div class="line">Sendfile  on;</div><div class="line">tcp_nopush     on;</div><div class="line">tcp_nodelay    on;</div><div class="line">#用于设置客户端连接保持活动的超时时间，超过这个时间，服务器会关闭该连接</div><div class="line">keepalive_timeout 60;</div><div class="line">#设置客户端请求头读取超时时间。如果超过这个时间，客户端还没有发送任何数据，Nginx将返回“Request time out（<span class="number">408</span>）”错误</div><div class="line">client_header_timeout  10;</div><div class="line">#设置客户端请求主体读取超时时间。如果超过这个时间，客户端还没有发送任何数据，Nginx将返回“Request time out（<span class="number">408</span>）”错误，默认值是<span class="number">60</span></div><div class="line">client_body_timeout    10;</div><div class="line">#指定响应客户端的超时时间。这个超时仅限于两个连接活动之间的时间，如果超过这个时间，客户端没有任何活动，Nginx将会关闭连接</div><div class="line">send_timeout          10;</div></pre></td></tr></table></figure>
<p>6.HttpGzip模块配置<br>下面配置Nginx的HttpGzip模块。这个模块支持在线实时压缩输出数据流。要查看是否安装了此模块，需要使用下面的命令：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">/usr/local/nginx/sbin/nginx  -V</div><div class="line">nginx <span class="keyword">version</span>: nginx/<span class="number">0.7</span>.<span class="number">65</span></div><div class="line">configure <span class="keyword">argument</span><span class="variable">s:</span> –with-http_stub_status_module –with-http_gzip_static_module –prefix=/<span class="keyword">opt</span>/nginx</div></pre></td></tr></table></figure>
<p>通过/usr/local/nginx/sbin/nginx -V命令可以查看安装Nginx时的编译选项，由输出可知，我们已经安装了HttpGzip模块。<br>下面是HttpGzip模块在Nginx配置中的相关属性设置：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">#用于设置开启或者关闭gzip模块，“gzip <span class="keyword">on</span>”表示开启GZIP压缩，实时压缩输出数据流</div><div class="line">gzip  on;</div><div class="line">#设置允许压缩的页面最小字节数，页面字节数从header头的Content-Length中获取。默认值是<span class="number">0</span>，不管页面多大都进行压缩。建议设置成大于<span class="number">1</span>K的字节数，小于<span class="number">1</span>K可能会越压越大。</div><div class="line">gzip_min_length  1k;</div><div class="line">#表示申请<span class="number">4</span>个单位为<span class="number">16</span>K的内存作为压缩结果流缓存，默认值是申请与原始数据大小相同的内存空间来存储gzip压缩结果。</div><div class="line">gzip_buffers     4  16k;</div><div class="line">#用于设置识别HTTP协议版本，默认是<span class="number">1.1</span>，目前大部分浏览器已经支持GZIP解压，使用默认即可</div><div class="line">gzip_http_version  1.1;</div><div class="line">#用来指定GZIP压缩比，<span class="number">1</span> 压缩比最小，处理速度最快；<span class="number">9</span> 压缩比最大，传输速度快，但处理最慢，也比较消耗cpu资源</div><div class="line">gzip_comp_level  2;</div><div class="line">#用来指定压缩的类型，无论是否指定，“text/html”类型总是会被压缩的</div><div class="line">gzip_types  text/plain application/x-javascript text/css application/xml;</div><div class="line">#让前端的缓存服务器缓存经过GZIP压缩的页面，例如用Squid缓存经过Nginx压缩的数据</div><div class="line">gzip_vary  on;</div></pre></td></tr></table></figure>
<p>7.StubStatus模块</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">location /NginxStatus &#123;</div><div class="line">#stub_status为“<span class="keyword">on</span>”表示启用StubStatus的工作机制</div><div class="line">stub_status      on;</div><div class="line">#access_log用来指定StubStatus模块的访问日志文件，“off”为关闭，开启加路径</div><div class="line">access_log       off;</div><div class="line">#access_log       logs/NginxStatus.log;</div><div class="line">#访问控制</div><div class="line">allow    all;</div><div class="line">#auth_basic是Nginx的一种认证机制，auth_basic_user_file用来指定认证密码</div><div class="line">#auth_basic       “Nginxstatus”;</div><div class="line">#auth_basic_user_file   ../htpasswd;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> 技术 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Netbois协议导致网络阻塞]]></title>
      <url>/2015/07/11/Netbois-protocol-leads-to-network-congestion/</url>
      <content type="html"><![CDATA[<p>办公室有台电脑，经常导致办公室网络中断。使用抓包工具分析，该电脑在网络组始终在使用Netbois协议进行域名查询，导致网络阻塞。</p>
<p>在网上有这样的解释：</p>
<p>最近也发现很多接入交换机出现类似的情况，因为接入交换机端口所属VLAN在核心交换机上也有，最终竟然导致接入交换机和汇聚交换机、核心交换机间的链路阻塞，使得网络变得基本不通。<br>初步分析了一下捕获到的数据，基本认定原因在于好多个人计算机内包含恶意/流氓软件，会不停地访问btamail.net、bar.baidu.com、 sobar.baidu.com等域名，同时，windows的名字解析机制的顺序是：</p>
<ol>
<li>hosts</li>
<li>net bios, wins, lmhosts</li>
<li>dns<br>所以，就会在网络中产生大量nbns的数据包</li>
</ol>
<p>然后，在那台电脑上杀进程，找到恶意软件。</p>
]]></content>
      
        <categories>
            
            <category> 技术 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> 网络 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Nginx下dedecms安全设置]]></title>
      <url>/2015/07/11/dedecms-security-settings-on-Nginx/</url>
      <content type="html"><![CDATA[<h2 id="目录权限设置"><a href="#目录权限设置" class="headerlink" title="目录权限设置"></a>目录权限设置</h2><p>织梦可读写、不可执行权限，禁止运行php程序目录：</p>
<ul>
<li>templets</li>
<li>uploads</li>
<li>data</li>
<li>images</li>
<li>a</li>
</ul>
<p>具体目录，可以通过后台一键更新时，寻找需要写入权限的目录</p>
<p>思路：<br>web服务器(AMH)运行的用户应该是www，那么网站的所有者就应该不能设置为www，而应该设置为不同的用户，这里设置为ftpuser用户。同时www、ftpuser用户应该为同一组，这里设置同为www组。</p>
<a id="more"></a>
<p>1、那么我们将网站目录的所有者设置为ftpuser，用户组设置为www，目录权限设置为为750，文件权限设置为640。这里以AMH控制面板为例：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">cd</span> /home/wwwroot/$web_site</div><div class="line">chown -R ftpuser.www web</div><div class="line">find web -type d -exec chmod 750 &#123;&#125; \;</div><div class="line">find web -not -type d -exec chmod 640 &#123;&#125; \;</div></pre></td></tr></table></figure>
<p>2、针对需要有读写权限的目录，templets、uploads、data、images、a等</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">cd</span> web</div><div class="line">chmod -R <span class="number">770</span> templets uploads data images <span class="keyword">a</span></div></pre></td></tr></table></figure>
<h2 id="禁止执行PHP文件"><a href="#禁止执行PHP文件" class="headerlink" title="禁止执行PHP文件"></a>禁止执行PHP文件</h2><p>针对有读写权限的目录，禁止运行PHP</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">vi</span> /usr/local/nginx/<span class="keyword">conf</span>/vhost/$web_site.<span class="keyword">conf</span></div><div class="line">#追加如下</div><div class="line">location ~* ^/(templets|uploads|data|images|<span class="keyword">a</span>)/.*\.(php|php5)$</div><div class="line">&#123;</div><div class="line">	deny all;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Shell增加变量"><a href="#Shell增加变量" class="headerlink" title="Shell增加变量"></a>Shell增加变量</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">#!/bin/bash</div><div class="line">#dede_safe.<span class="keyword">sh</span></div><div class="line">#$<span class="number">1</span>指网站目录</div><div class="line"><span class="keyword">cd</span> /home/wwwroot/$<span class="number">1</span></div><div class="line">chown -R ftpuser.www web</div><div class="line">find web -type d -exec chmod 750 &#123;&#125; \;</div><div class="line">find web -type f -exec chmod 640 &#123;&#125; \;</div><div class="line"></div><div class="line">#$<span class="number">2</span>指有读写权限的目录名称（目录名称之间用空格隔开）</div><div class="line"><span class="keyword">cd</span> web</div><div class="line">chmod -R <span class="number">770</span> $<span class="number">2</span></div><div class="line"></div><div class="line">#$<span class="number">3</span>指有读写权限的目录名称（目录名称之间用|隔开）</div><div class="line"><span class="keyword">cd</span> /usr/local/nginx/<span class="keyword">conf</span>/vhost/</div><div class="line">sed -i <span class="string">'/php\$/i\\ \tlocation ~* ^/('</span><span class="string">"$3"</span><span class="string">')/.*\.(php|php5)$\n\t&#123;\n\t\tdeny all;\n\t&#125;\n'</span> <span class="string">"$1"</span>.<span class="keyword">conf</span> sed -i <span class="string">'/php\$/i\\ \tlocation ~* ^/('</span><span class="string">"$3"</span><span class="string">')/.*\.(php|php5)$\n\t&#123;\n\t\tdeny all;\n\t&#125;\n'</span> <span class="string">"$1"</span>.<span class="keyword">conf</span></div></pre></td></tr></table></figure>
<p>如何来调用：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./dede_safe.<span class="keyword">sh</span> <span class="string">"www.wangyi.com"</span> <span class="string">"templets uploads"</span> <span class="string">"templets|uploads"</span></div></pre></td></tr></table></figure>
<p>在sed中使用变量</p>
<p>通常，我们使用sed进行变量替换的时候，替换和被替换变量都是hard-coded的。例如：</p>
<p><code>sed -n ‘/comm/p’ /tmp/test.log</code></p>
<p>如果我们用一变量var，它的值根据上下文变化</p>
<p><code>$ var=”comm”</code>，定义了变量，那么我们在sed的使用中这样使用变量</p>
<p><code>$ sed -n ‘/’”$var”‘/p’ /tmp/test.log</code></p>
<p>注意，是用单引号包含双引号来引用变量。</p>
]]></content>
      
        <categories>
            
            <category> 技术 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Nginx </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[2013年版通达OA与飞信集成]]></title>
      <url>/2015/07/11/The-tongda-of-OA-with-Fetion-integrated-access/</url>
      <content type="html"><![CDATA[<p>基于PHP-fetion进行修改。</p>
<p>作者博客：<a href="http://blog.quanhz.com/" target="_blank" rel="external">http://blog.quanhz.com/</a></p>
<p>PHP-fetion代码：<a href="https://code.google.com/p/php-fetion/" target="_blank" rel="external">https://code.google.com/p/php-fetion/</a></p>
<p>对定时发送页面做了修改：</p>
<p>fetion_send_sms.php(2013年版通达OA)</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?</span></div><div class="line"><span class="comment">//定时任务发送飞信手机短信</span></div><div class="line">    <span class="keyword">include_once</span> (“inc/conn.php”);</div><div class="line">    <span class="keyword">include_once</span> (“inc/fetion.php”); <span class="comment">//账号密码</span></div><div class="line">    <span class="keyword">require_once</span> (“inc/<span class="class"><span class="keyword">class</span>.<span class="title">fetion</span>.<span class="title">php</span>”); //飞信发送类</span></div><div class="line">    require_once (“inc/class.gateway.php”); //其他API接口发送</div><div class="line">    $cur_time = date(“Y-m-d H:i:s”); <span class="comment">//获得当前时间</span></div><div class="line">    $query = “SELECT `SMS_ID`,`PHONE`,`CONTENT` FROM `SMS2` WHERE `SEND_TIME` &lt;= ‘&#123;$cur_time&#125;’ <span class="keyword">AND</span> `SEND_FLAG` = ‘<span class="number">3</span>’ LIMIT <span class="number">1</span>″; <span class="comment">//检测短信时间及状态</span></div><div class="line">    $cursor = exequery($connection, $query); <span class="comment">//连接数据库</span></div><div class="line">    <span class="comment">//无短信需要发送</span></div><div class="line">    <span class="keyword">if</span> (<span class="number">0</span> == mysql_num_rows($cursor)) &#123;</div><div class="line">        <span class="keyword">echo</span> “No message to send”;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">    <span class="comment">//发送飞信</span></div><div class="line">    $ROW = mysql_fetch_array($cursor);</div><div class="line">    $PHONE = $ROW[<span class="string">'PHONE'</span>];</div><div class="line">    $CONTENT = $ROW[<span class="string">'CONTENT'</span>];</div><div class="line">    $SMS_ID = $ROW[<span class="string">'SMS_ID'</span>];</div><div class="line">    <span class="comment">//登陆飞信</span></div><div class="line">    $fetion = <span class="keyword">new</span> PHPFetion($mobile, $password);</div><div class="line">    <span class="comment">//发送飞信短信</span></div><div class="line">    $result = $fetion-&gt;send($PHONE, iconv(“gbk”, “utf<span class="number">-8</span>″, $CONTENT));</div><div class="line">    <span class="comment">//发送短信读取手机号，及信息内容转换代码</span></div><div class="line">    $result = iconv(“utf<span class="number">-8</span>″, “gbk”, $result); <span class="comment">//返回值</span></div><div class="line">    <span class="comment">//判定飞信发送是否成功</span></div><div class="line">    <span class="keyword">if</span> (strpos($result, “成功”) === <span class="keyword">FALSE</span>) &#123;</div><div class="line">        $JIEGUO = <span class="number">0</span>; <span class="comment">//失败，状态更新至待网关发送</span></div><div class="line">        <span class="keyword">echo</span> “One message to sent by MAS”;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        $JIEGUO = <span class="number">1</span>; <span class="comment">//成功</span></div><div class="line">        <span class="keyword">echo</span> “One message to sent by Fetion”;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//更新短信发送状态</span></div><div class="line">    $query2 = “UPDATE `SMS2` SET `SEND_FLAG` = ‘&#123;$JIEGUO&#125;’ WHERE `SMS_ID`=<span class="string">'&#123;$SMS_ID&#125;'</span>”;</div><div class="line">    exequery($connection, $query2);</div><div class="line">    <span class="comment">//结束会话</span></div><div class="line">    $fetion-&gt;_logout();</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/* End of the file */</span></div></pre></td></tr></table></figure>
<a id="more"></a>
<p>其余代码，点击下载：<a href="http://mr-wang.qiniudn.com/2013%E5%B9%B4%E7%89%88OA%E4%B8%8E%E9%A3%9E%E4%BF%A1%E9%9B%86%E6%88%90%E6%96%B9%E6%A1%88.zip" target="_blank" rel="external">2013年版OA与飞信集成方案</a></p>
<p>将文件在OA服务器wwwroot目录下进行覆盖，将task目录下的fetion_send_sms.php加入到通达OA的定时任务中。</p>
<p>注：OA自带的定时任务的最小时间间隔为1分钟，飞信发送缓慢。</p>
<p>这里提供2种解决方案：</p>
<p>1、windows下</p>
<p>创建一个cron.bat的批处理文件并用记事本打开输入：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">@echo off</div><div class="line">:fetion</div><div class="line">ping -n <span class="number">2</span> <span class="number">127.0</span>.<span class="number">0.1</span> &gt;&gt;nul</div><div class="line">start http://<span class="number">188.188</span>.<span class="number">0.9</span>/fetion_send_sms.php</div><div class="line">ping -n <span class="number">3</span> <span class="number">127.0</span>.<span class="number">0.1</span> &gt;&gt;nul</div><div class="line">taskkill /<span class="keyword">f</span> /<span class="keyword">im</span> <span class="string">"iexplore.exe"</span></div><div class="line"><span class="keyword">goto</span> fetion</div><div class="line">pause</div></pre></td></tr></table></figure>
<p>2.linux下</p>
<p>在/root/shell下创建一个fetion.sh的shell脚本</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">#!/bin/<span class="keyword">sh</span></div><div class="line">curl http://<span class="number">188.188</span>.<span class="number">0.9</span>/fetion_send_sms.php</div><div class="line">#局域网访问php代码的地址</div></pre></td></tr></table></figure>
<p>然后，每隔5s钟访问指定php脚本。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">crontab -<span class="keyword">e</span></div><div class="line">* * * * * /root/<span class="keyword">shell</span>/fetion.<span class="keyword">sh</span></div><div class="line">* * * * * sleep 5 &amp;amp;&amp;amp; /root/shell/fetion.sh</div><div class="line">* * * * * sleep 10 &amp;amp;&amp;amp; /root/shell/fetion.sh</div><div class="line">* * * * * sleep 15 &amp;amp;&amp;amp; /root/shell/fetion.sh</div><div class="line">* * * * * sleep 20 &amp;amp;&amp;amp; /root/shell/fetion.sh</div><div class="line">* * * * * sleep 25 &amp;amp;&amp;amp; /root/shell/fetion.sh</div><div class="line">* * * * * sleep 30 &amp;amp;&amp;amp; /root/shell/fetion.sh</div><div class="line">* * * * * sleep 35 &amp;amp;&amp;amp; /root/shell/fetion.sh</div><div class="line">* * * * * sleep 40 &amp;amp;&amp;amp; /root/shell/fetion.sh</div><div class="line">* * * * * sleep 45 &amp;amp;&amp;amp; /root/shell/fetion.sh</div><div class="line">* * * * * sleep 50 &amp;amp;&amp;amp; /root/shell/fetion.sh</div><div class="line">* * * * * sleep 55 &amp;amp;&amp;amp; /root/shell/fetion.sh</div></pre></td></tr></table></figure>
<p>2014.5.18日，更新统计飞信、mas发送次数，删除root邮件。</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">#!/bin/<span class="keyword">sh</span></div><div class="line">Fetion_DateName=Fetion_Date_$(date +“%Y%<span class="keyword">m</span>%d”).txt</div><div class="line">MAS_DateName=MAS_Date_$(date +“%Y%<span class="keyword">m</span>%d”).txt</div><div class="line"><span class="keyword">grep</span> ‘One message <span class="keyword">to</span> sent by Fetion’ /var/spool/mail/root | wc -<span class="keyword">l</span> &gt;&gt; /root/<span class="keyword">shell</span>/Date_Fetion/$Fetion_DateName</div><div class="line"><span class="keyword">grep</span> ‘One message <span class="keyword">to</span> sent by MAS’ /var/spool/mail/root | wc -<span class="keyword">l</span> &gt;&gt; /root/<span class="keyword">shell</span>/Date_Fetion/$MAS_DateName</div><div class="line"><span class="keyword">cat</span> /dev/null &gt; /var/spool/mail/root</div></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> 技术 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> 通达OA </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[记网站服务器遭遇PHPDDOS攻击]]></title>
      <url>/2015/07/11/The-web-server-encountered-PHPDDOS/</url>
      <content type="html"><![CDATA[<p>2014年4月10–11日，公司web服务器遭遇PHPDDOS攻击，导致服务器宽带被大量占用，网络延迟很大，无法远程登陆服务器管理。</p>
<p>开始以为是访问量太大导致的，10日发现服务器始终向某一固定IP发送UDP 53的包。采用iptables禁用IP。</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -I OUTPUT -s <span class="number">119.42</span>.<span class="number">149.69</span> -<span class="keyword">j</span> DROP</div></pre></td></tr></table></figure>
<p>然而服务器故障依旧，后来查询资料，发现原来服务器web网站被挂马，PHPDDOS。</p>
<a id="more"></a>
<p>现分享解决方法：</p>
<p>1.在linux服务器中输入如下命令：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">iptables -I OUTPUT -<span class="keyword">p</span> udp –-dport <span class="number">53</span> -d <span class="number">202.103</span>.<span class="number">44.150</span> -<span class="keyword">j</span> ACCEPT</div><div class="line">iptables -I OUTPUT -<span class="keyword">p</span> udp –-dport <span class="number">53</span> -d <span class="number">202.103</span>.<span class="number">24.68</span> -<span class="keyword">j</span> ACCEPT</div><div class="line">iptables -A OUTPUT -<span class="keyword">p</span> udp -<span class="keyword">j</span> REJECT</div><div class="line">/etc/rc.d/init.d/iptables save</div><div class="line">service iptables restart</div></pre></td></tr></table></figure>
<p>暂时通过iptables来屏蔽服务器向外发包。</p>
<p>2.查看网站日志，在日志中搜索IP：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">grep</span>  ‘<span class="number">119.42</span>.<span class="number">149.69</span>’  /usr/local/nginx/logs/access.<span class="built_in">log</span></div></pre></td></tr></table></figure>
<p>寻找服务器中的攻击文件，删除。</p>
]]></content>
      
        <categories>
            
            <category> 技术 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Iptables </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[AMH重新编译Nginx，使其支持静态页面post]]></title>
      <url>/2015/07/11/To-compile-Nginx-which-supports-static-post-pages/</url>
      <content type="html"><![CDATA[<p>在实际使用AMH的过程中，公司出现通过post请求静态页面；默认的nginx上，是拒绝通过post方式访问静态页面的。</p>
<p>网上有2种方法解决这个问题，但是在实际的过程中，发现方法1不奏效,于是使用方法2，重新编译nginx解决问题。</p>
<a id="more"></a>
<p>方法1：</p>
<p>修改nginc.conf配置文件，改变“405错误”为“200 ok”，并配置location来解决</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">vi</span> /usr/local/nginx/<span class="keyword">conf</span>/vhost/domain.<span class="keyword">com</span>.<span class="keyword">conf</span></div></pre></td></tr></table></figure>
<p>添加：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">error_page 405 =200 @405;</div><div class="line">location @<span class="number">405</span></div><div class="line">&#123;</div><div class="line">    root /home/wwwroot/web/doamin.com;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>方法2：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">cd</span> /home/amh_install/</div><div class="line">wget http://code.amysql.<span class="keyword">com</span>/<span class="keyword">files</span>/nginx-<span class="number">1.4</span>.<span class="number">4</span>.tar.gz</div><div class="line">tar zxvf nginx-<span class="number">1.4</span>.<span class="number">4</span>.tar.gz</div><div class="line"><span class="keyword">cd</span> nginx-<span class="number">1.4</span>.<span class="number">4</span>/src/http/modules/</div><div class="line"></div><div class="line"><span class="keyword">vi</span> ngx_http_static_module.<span class="keyword">c</span></div><div class="line">#将这段屏蔽掉；</div><div class="line">/*</div><div class="line"><span class="keyword">if</span> (r-&gt;method &amp; NGX_HTTP_POST) &#123;</div><div class="line">     return NGX_HTTP_NOT_ALLOWED;</div><div class="line">&#125;</div><div class="line">*/</div></pre></td></tr></table></figure>
<p>重新编译：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">./configure –prefix=/usr/local/nginx –user=www –group=www –with-http_ssl_module –with-http_static_module –with-http_gzip_static_module –without-mail_pop3_module –without-mail_imap_module –without-mail_smtp_module –without-http_uwsgi_module –without-http_scgi_module</div><div class="line"><span class="keyword">make</span></div></pre></td></tr></table></figure>
<p>编译完成后不要再执行 make install，不然会把原有的配置文件覆盖，正确的方法是直接删除旧的，把新的复制过去后再执行make upgrade。</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mv /usr/local/nginx/sbin/nginx /usr/local/nginx/sbin/nginx.bak</div><div class="line"><span class="keyword">cp</span> ./objs/nginx /usr/local/nginx/sbin/</div><div class="line"><span class="keyword">make</span> upgrade</div></pre></td></tr></table></figure>
<p>重载一下nginx</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/etc/init.d/nginx reload</div></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> 技术 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Nginx </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[让AMH虚拟主机支持PATHINFO]]></title>
      <url>/2015/07/11/Let-AMH-virtual-host-support-PATHINFO/</url>
      <content type="html"><![CDATA[<p>现在公司许多程序是在基于ThinkPHP框架上进行开发的， 然而基于此框架开发的程序，URL访问形式如下：</p>
<p><a href="http://it.ctwoo.com/index.php/Login/index" target="_blank" rel="external">http://it.ctwoo.com/index.php/Login/index</a></p>
<p>默认Nginx是不支持PATHINFO的。</p>
<p>AMH虚拟主机支持PATHINFO更改方法,更改需要支持PATHINFO的主机的配置文件：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">vi</span> /usr/local/nginx/<span class="keyword">conf</span>/vhost/domain.<span class="keyword">com</span>.<span class="keyword">conf</span></div></pre></td></tr></table></figure>
<p>参考配置：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">location ~ ^(.+\.php)(.*)$</div><div class="line">&#123;</div><div class="line">    fastcgi_pass  unix:/tmp/php-cgi-e-uncommon.com.sock;</div><div class="line">    fastcgi_index index.php;</div><div class="line">    //begin</div><div class="line">    fastcgi_split_path_info ^(.+\.php)(.*)$;</div><div class="line">    fastcgi_param PATH_INFO $fastcgi_path_info;</div><div class="line">    //end</div><div class="line">    include fcgi-host.conf;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Esc :wq 保存退出。</p>
<p>进入AMH后台重启Nginx即可。</p>
<a id="more"></a>
<p>2014年10月30日补充：<br>问题1：thinkphp在nginx环境下，不支持pathinfo。</p>
<p>pathinfo模式，举个例子：</p>
<p><a href="http://www.geekpark.net/read/view/171078" target="_blank" rel="external">http://www.geekpark.net/read/view/171078</a></p>
<p>首先会访问到 www.geekpark.net/index.php文件</p>
<p>然后 通过php文件get到参数 就会获取到 read/view/171078</p>
<p>通过拆分成数组就是</p>
<p>array(0=&gt;’read’,1=&gt;’view’,2=&gt;171078)</p>
<p>那么系统就会去 include read.php 然后在实例化 read</p>
<p>然后访问read对象内的 view方法</p>
<p>然后 view方法 get到171078这条参数进行数据库查询…..</p>
<p>很简单的理解为</p>
<p>read /view/ 171078</p>
<p>控制器 方法 参数</p>
<p>而thinkphp支持4种模式，将官网的讲解粘贴如下：</p>
<hr>
<p>一、普通模式：设置URL_MODEL 为0</p>
<p>采用传统的URL参数模式</p>
<p><a href="http://serverName/appName/?m=module&amp;a=action&amp;id=1" target="_blank" rel="external">http://serverName/appName/?m=module&amp;a=action&amp;id=1</a></p>
<p>二、PATHINFO模式（默认模式）：设置URL_MODEL 为1</p>
<p>默认情况使用PATHINFO模式，ThinkPHP内置强大的PATHINFO支持，提供灵活和友好URL支持。PATHINFO模式自动识别模块和操作，例如</p>
<p><a href="http://serverName/appName/module/action/id/1/" target="_blank" rel="external">http://serverName/appName/module/action/id/1/</a></p>
<p>或者</p>
<p><a href="http://serverName/appName/module,action,id,1/" target="_blank" rel="external">http://serverName/appName/module,action,id,1/</a></p>
<p>在不考虑路由的情况下，第一个参数会被解析成模块名称（如果启用了分组的话，则依次往后递推），第二个参数会被解析成操作，后面的参数是显式传递的，而且必须成对出现，例如：</p>
<p><a href="http://serverName/appName/module/action/year/2008/month/09/day/21/" target="_blank" rel="external">http://serverName/appName/module/action/year/2008/month/09/day/21/</a></p>
<p>其中参数之间的分割符号由URL_PATHINFO_DEPR参数设置，默认为”/”，例如我们设置URL_PATHINFO_DEPR为“-”的话，就可以使用下面的URL访问</p>
<p><a href="http://serverName/appName/module-action-id-1/" target="_blank" rel="external">http://serverName/appName/module-action-id-1/</a></p>
<p>注意不要使用”:” 和”&amp;”符号进行分割，该符号有特殊用途。</p>
<p>略加修改，就可以展示出富有诗意的URL，呵呵～</p>
<p>如果想要简化URL的形式可以通过路由功能（后面会有描述）以及空模块和空操作。</p>
<p>在PATH_INFO模式下面，会把相关参数转换成GET变量，以及并入REQUEST变量，因此不妨碍URL里面的GET和REQUEST变量获取。</p>
<p>三、REWRITE模式： 设置URL_MODEL 为2</p>
<p>该URL模式和PATHINFO模式功能一样，除了可以不需要在URL里面写入口文件，和可以定义.htaccess<br>文件外。在开启了Apache的URL_REWRITE模块后，就可以启用REWRITE模式了，具体参考下面的URL重写部分。</p>
<p>四、兼容模式： 设置URL_MODEL 为3</p>
<p>兼容模式是普通模式和PATHINFO模式的结合，并且可以让应用在需要的时候直接切换到PATHINFO模式而不需要更改模板和程序，还可以和URL_WRITE模式整合。兼容模式URL可以支持任何的运行环境。</p>
<p>兼容模式的效果是：</p>
<p><a href="http://serverName/appName/?s=/module/action/id/1/" target="_blank" rel="external">http://serverName/appName/?s=/module/action/id/1/</a></p>
<p>并且也可以支持参数分割符号的定义，例如在URL_PATHINFO_DEPR为~的情况下，下面的URL有效：</p>
<p><a href="http://serverName/appName/?s=module~action~id~1" target="_blank" rel="external">http://serverName/appName/?s=module~action~id~1</a></p>
<p>其实是利用了VAR_PATHINFO参数，用普通模式的实现模拟了PATHINFO的模式。但是兼容模式并不需要自己传s变量，而是由系统自动完成URL部分。正是由于这个特性，兼容模式可以和PATHINFO模式之间直接切换，而不需更改模板文件里面的URL地址连接。</p>
<p>某些服务器环境不能良好的支持PATHINFO，但是在大多数环境下面ThinkPHP可以进行兼容判断，如果你的服务器环境或者空间仍然无法识别PAHTINFO的话，或者需要自己增加识别方法或者可以选择普通模式或者兼容模式URL运行。</p>
<hr>
<p>前面AMH（nginx环境)支持pathinfo相关设置有讲到</p>
<p>实际使用发现新版的thinkphp设置后，不能成功。</p>
<p>后来尝试，使用如下方法解决：</p>
<p>1、将thinkphp模式设置为rewrite模式；</p>
<p>2、在AMH下，通过AMRewrite模块，新建一个rewrite规则，内容如下：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">location / &#123;</div><div class="line"><span class="keyword">if</span> (!-<span class="keyword">e</span> $request_filename) &#123;</div><div class="line">rewrite ^(.*)$ /index.php?s=$1 last;</div><div class="line">break;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">location /Apps/crm7/ &#123;</div><div class="line"><span class="keyword">if</span> (!-<span class="keyword">e</span> $request_filename) &#123;</div><div class="line">rewrite ^/Apps/crm7/(.*)$ /Apps/crm7/index.php?s=$1 last;</div><div class="line">break;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">location /Apps/zhiansys/ &#123;</div><div class="line"><span class="keyword">if</span> (!-<span class="keyword">e</span> $request_filename) &#123;</div><div class="line">rewrite ^/Apps/zhiansys/(.*)$ /Apps/zhiansys/index.php?s=$1 last;</div><div class="line">break;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">location /Apps/it/ &#123;</div><div class="line"><span class="keyword">if</span> (!-<span class="keyword">e</span> $request_filename) &#123;</div><div class="line">rewrite ^/Apps/it/(.*)$ /Apps/it/index.php?s=$1 last;</div><div class="line">break;</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>3、将规则应用到对应网址，重启nginx。</p>
<p>问题2：AMH环境下访问sqlserver数据库，返回数据编码有误，导致返回数据均为问号</p>
<p>首先，AMH环境下安装mssql模块：</p>
<p>1、安装freetds</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">cd</span> /usr/local/</div><div class="line">wget http://mirrors.xmu.edu.<span class="keyword">cn</span>/ubuntu/archive/pool/main/<span class="keyword">f</span>/freetds/freetds_0.<span class="number">82</span>.orig.tar.gz</div><div class="line">tar zxf freetds_0.<span class="number">82</span>.orig.tar.gz</div><div class="line"><span class="keyword">cd</span> freetds-<span class="number">0.82</span></div><div class="line">./configure –prefix=/usr/local/freetds –with-tdsver=<span class="number">8.0</span> –enable-msdblib –enable-dbmfix –with-gnu-ld –enable-shared –enable-static</div><div class="line"><span class="keyword">make</span> &amp;&amp; <span class="keyword">make</span> install</div></pre></td></tr></table></figure>
<p>2、下载php源码，安装mssql模块</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">cd</span> php-<span class="number">5.3</span>.<span class="number">27</span>/ext/mssql</div><div class="line">/usr/local/php/bin/phpize;</div><div class="line">./configure –with-php-config=/usr/local/php/bin/php-config  –with-mssql=/usr/local/freetds</div><div class="line"><span class="keyword">make</span> &amp;&amp; <span class="keyword">make</span> install</div><div class="line"><span class="keyword">vi</span> /etc/php.ini</div><div class="line">extension = /usr/local/php/lib/php/extensions/<span class="keyword">no</span>-<span class="keyword">debug</span>-non-zts-<span class="number">20090626</span>/mssql.<span class="keyword">so</span></div></pre></td></tr></table></figure>
<p>3、重启面板php、虚拟主机php</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">amh php restart amh-web <span class="keyword">y</span></div><div class="line">amh php restart</div></pre></td></tr></table></figure>
<p>其次，修改php.ini</p>
<p>添加mssql.charset = “UTF8″</p>
]]></content>
      
        <categories>
            
            <category> 技术 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Nginx </tag>
            
        </tags>
        
    </entry>
    
  
  
</search>
